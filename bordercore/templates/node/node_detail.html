{% extends "base.html" %}

{% load dict_get %}

{% load favicon %}

{% block title %} Node <span class="node-name">{{ node.name }}</span> {% endblock %}

{% block nav %}

    <div id="vue-nav" class="d-flex align-items-center mb-3">
        <div class="flex-grow-1 me-auto align-self-center">
            <ul class="breadcrumb mb-0 pt-0 pb-0">
                <li class="breadcrumb-item"> <a href="{% url 'node:list' %}">Nodes</a> </li>
                <li class="breadcrumb-item active">{{ node.name }}</li>
            </ul>
        </div>
        <div v-if="$store.state.editLayout" class="text-primary ms-auto me-5">
            Edit Layout
        </div>
        <drop-down-menu
            ref="dropDownMenu"
            class="me-3"
        >
            <div slot="dropdown" class="mt-0">
                <li>
                    <a class="dropdown-item" href="#" @click.prevent="onAddCollection">
                        <span v-cloak>
                            <font-awesome-icon icon="plus" class="text-primary me-3"></font-awesome-icon>
                            Add collection
                        </span>
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="#" @click.prevent="onAddNote">
                        <span v-cloak>
                            <font-awesome-icon icon="plus" class="text-primary me-3"></font-awesome-icon>
                            Add note
                        </span>
                    </a>
                </li>
                    <a class="dropdown-item" href="#" @click.prevent="onAddImage">
                        <span v-cloak>
                            <font-awesome-icon icon="plus" class="text-primary me-3"></font-awesome-icon>
                            Add image
                        </span>
                    </a>
                    <li>
                    <a class="dropdown-item" href="#" @click.prevent="onEditMode">
                        <span v-cloak>
                            <font-awesome-icon icon="pencil-alt" class="text-primary me-3"></font-awesome-icon>
                            [[ editLayoutDropDownItemValue ]]
                        </span>
                    </a>
                </li>
            </div>
        </drop-down-menu>
    </div>

{% endblock %}

{% block content %}

    <div id="vue-app">

        <create-update-todo
            ref="updateTodo"
            :priority-list="JSON.parse('{{ priority_list }}')"
            update-todo-url="{% url 'todo-detail' '00000000-0000-0000-0000-000000000000' %}"
            create-todo-url="{% url 'todo-list' %}"
            tag-search-url="{% url 'tag:search' %}?query="
            @post-todo-add="addNodeTodo"
            @post-todo-update="refreshNodeTodo"
        >
        </create-update-todo>

        <div class="d-flex g-0 h-100 mx-2">

            <div v-for="(column, colIndex) in layout" class="flex-even">
                <draggable
                    @change="onLayoutChange($event)"
                    :list="layout[colIndex]"
                    group="object"
                    :data-col-number="colIndex"
                    :disabled="!$store.state.editLayout"
                    class="position-relative"
                    :style="'z-index: ' + (2*10 - colIndex)"
                >
                    <div v-for="(obj, rowIndex) in column" class="position-relative" :style="'z-index: ' + (2*10 - colIndex - rowIndex)">
                        <div v-if="obj.type === 'collection'" :key="obj.uuid">
                            <collection-object-list
                                :initial-name="obj.name"
                                :uuid="obj.uuid"
                                update-collection-url="{% url "collection-detail" "00000000-0000-0000-0000-000000000000" %}"
                                update-object-note-url="{% url "collection:update_object_note" %}"
                                :get-object-list-url="'{% url "collection:get_object_list" '00000000-0000-0000-0000-000000000000' %}'.replace('00000000-0000-0000-0000-000000000000', obj.uuid)"
                                remove-object-url="{% url "collection:remove_object" %}"
                                sort-objects-url="{% url "collection:sort_objects" %}"
                                @delete-collection="onDeleteCollection"
                                @open-modal-collection-update="openModalCollectionUpdate"
                            >
                            </collection-object-list>
                        </div>
                        <div v-if="obj.type === 'note'" :draggable="$store.state.editLayout" :key="obj.uuid">
                            <node-note
                                node-uuid="{{ object.uuid }}"
                                :note-uuid="obj.uuid"
                                :note-color="obj.color"
                                :get-node-url="'{% url "blob-detail" '00000000-0000-0000-0000-000000000000' %}'.replace('00000000-0000-0000-0000-000000000000', obj.uuid)"
                                :update-note-url="'{% url "blob-detail" '00000000-0000-0000-0000-000000000000' %}'.replace('00000000-0000-0000-0000-000000000000', obj.uuid)"
                                :set-note-color-url="'{% url "node:set_note_color" %}'"
                                @delete-note="onDeleteNote"
                                @open-modal-note-update="openModalNoteUpdate"
                            >
                            </node-note>
                        </div>
                        <div v-else-if="obj.type === 'todo'" :draggable="$store.state.editLayout" key="todo">
                            <node-todo-list
                                ref="todoList"
                                node-uuid="{{ object.uuid }}"
                                get-todo-list-url="{% url "node:get_todo_list" object.uuid %}"
                                add-node-todo-url="{% url "node:add_todo" %}"
                                remove-node-todo-url="{% url 'todo-detail' '00000000-0000-0000-0000-000000000000' %}"
                                sort-node-todos-url="{% url 'node:sort_todos' %}"
                            >
                            </node-todo-list>
                        </div>
                        <div v-else-if="obj.type === 'image'" :draggable="$store.state.editLayout" key="obj.uuid">
                            <node-image
                                :image-uuid="obj.uuid"
                                :image-title="obj.image_title"
                                :image-url="obj.image_url"
                                @open-modal-note-image="openModalNoteImage"
                                @remove-image="onRemoveImage"
                            >
                            </node-image>
                        </div>
                    </div>
                </draggable>
            </div>

            <collection-object-list-modal ref="collectionUpdate">
            </collection-object-list-modal>

            <node-note-modal ref="noteUpdate">
            </node-note-modal>

            <node-image-modal ref="noteImage">
            </node-image-modal>

            <object-select
                label="_objectSelectImage"
                ref="objectSelectImage"
                search-object-url="{% url 'search:search_names' %}"
                @select-object="selectObjectImage"
            >
            </object-select>
            <object-select
                label="_objectSelectCollection"
                ref="objectSelectCollection"
                search-object-url="{% url 'search:search_names' %}"
                @select-object="selectObjectCollection"
            >
            </object-select>
            <bookmark-select
                ref="bookmarkSelect"
                search-url="{% url 'bookmark:search' %}"
                create-bookmark-url="{% url 'bookmark-list' %}"
                get-title-from-url-url="{% url 'drill:get_title_from_url' %}"
                @select-bookmark="selectBookmark"
            >
            </bookmark-select>

        </div>

    </div>

{% endblock %}

{% block javascript %}

    {{ block.super }}

    {{ object.layout|json_script:"layout" }}

    <script type="text/javascript">

        const store = new Vuex.Store({
            state: {
                editLayout: false,
                nodeUuid: "{{ object.uuid }}",
            },
            getters: {},
            mutations: {},
        });

        new Vue({
            el: "#vue-nav",
            name: "Nav",
            store,
            methods: {
                onAddCollection() {
                    EventBus.$emit("open-collection-modal");
                },
                onAddImage() {
                    EventBus.$emit("object-select-image");
                },
                onAddNote() {
                    doPost(
                        this,
                        "{% url "node:add_note" %}",
                        {
                            "node_uuid": this.$store.state.nodeUuid,
                        },
                        (response) => {
                            EventBus.$emit("update-layout", response.data.layout);
                        },
                        "Note added",
                        ""
                    );
                },
                onEditMode() {
                    this.$store.state.editLayout = !this.$store.state.editLayout;
                },
            },
            computed: {
                editLayoutDropDownItemValue: function() {
                    return this.$store.state.editLayout ? "Disable Edit Layout" : "Enable Edit Layout"
                }
            },
        })

        new Vue({
            el: "#vue-app",
            name: "Node Detail",
            store,
            data() {
                return {
                    layout: JSON.parse(document.getElementById("layout").textContent),
                }
            },
            methods: {
                addCollection() {
                    const name = document.getElementById("id_name_collection").value;
                    doPost(
                        this,
                        "{% url "node:add_collection" %}",
                        {
                            "node_uuid": this.$store.state.nodeUuid,
                            "collection_name": name,
                        },
                        (response) => {
                            EventBus.$emit("update-layout", response.data.layout);
                        },
                        "Collection added",
                        ""
                    );
                },
                addNodeTodo(payload) {
                    this.$refs.todoList[0].addNodeTodo(payload);
                },
                refreshNodeTodo(payload) {
                    this.$refs.todoList[0].getTodoList();
                },
                selectBookmark(bookmarkInfo, collectionUuid, callback) {
                    doPost(
                        this,
                        "{% url "collection:add_bookmark" %}",
                        {
                            "collection_uuid": collectionUuid,
                            "bookmark_uuid": bookmarkInfo.uuid,
                        },
                        (response) => {
                            callback();
                            this.$refs.bookmarkSelect.$refs.simpleSuggest.$refs.suggestComponent.selected = null;
                        },
                        "Bookmark added",
                        ""
                    );
                },
                selectObjectImage(object, callback) {
                    doPost(
                        this,
                        "{% url "node:add_image" %}",
                        {
                            "node_uuid": this.$store.state.nodeUuid,
                            "image_uuid": object.uuid,
                        },
                        (response) => {
                            if (callback) {
                                callback();
                            }
                            EventBus.$emit("update-layout", response.data.layout);
                        },
                        "Image added",
                        ""
                    );
                },
                selectObjectCollection(blob, callback, returnArgs) {
                    doPost(
                        this,
                        "{% url "collection:add_blob" %}",
                        {
                            "collection_uuid": returnArgs.collectionUuid,
                            "blob_uuid": blob.uuid,
                        },
                        (response) => {
                            callback();
                        },
                        "Blob added",
                        ""
                    );
                },
                onDeleteCollection(collectionUuid) {
                    doPost(
                        this,
                        "{% url "node:delete_collection" %}",
                        {
                            "node_uuid": this.$store.state.nodeUuid,
                            "collection_uuid": collectionUuid,
                        },
                        (response) => {
                            this.layout = JSON.parse(response.data.layout);
                        },
                        "Collection deleted",
                    );
                },
                onRemoveImage(imageUuid) {
                    doPost(
                        this,
                        "{% url "node:remove_image" %}",
                        {
                            "node_uuid": this.$store.state.nodeUuid,
                            "image_uuid": imageUuid,
                        },
                        (response) => {
                            this.layout = JSON.parse(response.data.layout);
                        },
                        "Image removed",
                    );
                },
                openModalCollectionUpdate(callback, data) {
                    this.$refs.collectionUpdate.openModal("Update", callback, data);
                },
                openModalNoteUpdate(callback, data) {
                    this.$refs.noteUpdate.openModal("Update", callback, data);
                },
                openModalNoteImage(data) {
                    this.$refs.noteImage.openModal(data);
                },
                onDeleteNote(noteUuid) {
                    doPost(
                        this,
                        "{% url "node:delete_note" %}",
                        {
                            "node_uuid": this.$store.state.nodeUuid,
                            "note_uuid": noteUuid,
                        },
                        (response) => {
                            this.layout = JSON.parse(response.data.layout);
                        },
                        "Note deleted",
                    );
                },
                onDragOver(evt, index) {
                    evt.currentTarget.classList.add("node-drag-over");
                },
                onDragLeave(evt) {
                    evt.currentTarget.classList.remove("node-drag-over");
                },
                onLayoutChange(evt) {
                    doPost(
                        this,
                        "{% url "node:change_layout" %}",
                        {
                            "node_uuid": this.$store.state.nodeUuid,
                            "layout": JSON.stringify(this.layout),
                        },
                        (response) => {
                        },
                        "",
                        ""
                    );
                },
            },
            mounted() {
                EventBus.$on("add-blob", (payload) => {
                    this.$refs.blobList.addBlob(payload);
                });

                EventBus.$on("add-bookmark", (payload) => {
                    this.$refs.bookmarkList.addBookmark(payload);
                });

                EventBus.$on("open-collection-modal", (payload) => {
                    this.$refs.collectionUpdate.openModal("Add", this.addCollection, {});
                });

                EventBus.$on("object-select-image", (payload) => {
                    this.$refs.objectSelectImage.openModal(["blob"]);
                });

                EventBus.$on("update-layout", (payload) => {
                    this.layout = JSON.parse(payload);
                });
            }
        });

    </script>

{% endblock %}
