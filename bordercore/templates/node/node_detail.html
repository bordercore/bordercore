{% extends "base.html" %}

{% load dict_get %}

{% load favicon %}

{% block title %} Node <span class="node-name">{{ node.name }}</span> {% endblock %}

{% block nav %}

    <div class="d-flex mb-3">
        <div class="mr-auto align-self-center">
            <ul class="breadcrumb mb-0 pt-0 pb-0">
                <li class="breadcrumb-item"> <a href="{% url 'node:list' %}">Nodes</a> </li>
                <li class="breadcrumb-item active">{{ node.name }}</li>
            </ul>
        </div>
    </div>

{% endblock %}

{% block content %}

    <div id="vue-app">

        <div class="row no-gutters h-100">
            <div class="col-lg-4 d-flex flex-column">

                <div>
                    <blob-list inline-template ref="blobList" v-b-hover="handleHover">

                        <card title="Blobs">
                            <template v-slot:top-right>
                                <div class="node-add-button">
                                    <add-button href="#" :click-handler="chooseBlob" class="hover-target d-none"></add-button>
                                </div>
                            </template>

                            <template v-slot:content>

                                <ul class="list-group list-group-flush" id="sort-container-tags">
                                    <draggable v-model="blobList" @change="onChange" ghost-class="sortable-ghost" draggable=".draggable">
                                        <transition-group type="transition" class="w-100">
                                            <li v-for="(blob, index) in blobList" class="list-group-item list-group-item-secondary text-info draggable pr-0" :data-uuid="blob.uuid" :key="blob.uuid" v-cloak v-b-hover="handleHover">

                                                <div class="d-flex">

                                                    <div class="pr-2">
                                                        <img :src="[[ blob.cover_url ]]" height="75" width="70" />
                                                    </div>

                                                    <div>
                                                        <a :href="blob.url">[[ blob.name ]]</a>
                                                        <div v-if="blob.note" @click="activateInEditMode(blob, $event.target)" v-show="!blob.noteIsEditable" class="node-note">[[ blob.note ]]</div>
                                                        <span v-show="blob.noteIsEditable">
                                                            <input type="text" class="form-control form-control-sm" :value="blob.note" ref="input" placeholder="" @blur="editNote(blob.uuid, $event.target.value)" @keydown.enter="editNote(blob.uuid, $event.target.value)" >
                                                        </span>
                                                    </div>

                                                    <div class="dropdownmenu hidden">
                                                        <dropdown-menu v-model="show" transition="translate-fade-down">
                                                            <font-awesome-icon icon="ellipsis-v"></font-awesome-icon>
                                                            <div slot="dropdown">
                                                                <a class="dropdown-item" href="#" @click.prevent="removeBlob(blob.uuid)">Remove</a>
                                                                <a v-if="!blob.note" class="dropdown-item" href="#" @click.prevent="addNote(blob.uuid, index)">Add note</a>
                                                            </div>
                                                        </dropdown-menu>
                                                    </div>

                                                </div>

                                            </li>
                                            <div class="text-secondary" v-if="blobList.length == 0" :key="1" v-cloak>
                                                Nothing to show
                                            </div>
                                        </transition-group>
                                    </draggable>
                                </ul>
                            </template>
                        </card>
                    </blob-list>

                </div>

                <div>
                    <note inline-template ref="note">
                        <card v-b-hover="handleHover">
                            <template v-slot:title-slot>
                                <div class="card-title d-flex" v-cloak>
                                    <div>
                                        Notes
                                    </div>
                                    <div class="dropdownmenu d-flex" v-if="note !== ''">
                                        <dropdown-menu v-model="show" transition="translate-fade-down" class="hidden">
                                            <font-awesome-icon icon="ellipsis-v"></font-awesome-icon>
                                            <div slot="dropdown">
                                                <a v-if="note" class="dropdown-item" href="#" @click.prevent="editNote()">Edit note</a>
                                            </div>
                                        </dropdown-menu>
                                    </didspan>
                                </div>
                            </template>
                            <template v-slot:content>
                                <editable-text-area
                                    uuid="{{ object.uuid }}"
                                    v-model:note="note"
                                    edit-url="{% url 'node:edit_note' %}"
                                    ref="note"
                                >
                                </editable-text-area>
                            </template>
                        </card>
                    </note>
                </div>

            </div> <!-- - End first column -->

            <div class="col-lg-4 d-flex flex-column">

                <div>
                    <bookmark-list inline-template ref="bookmarkList" v-b-hover="handleHover">

                        <card title="Links">
                            <template v-slot:top-right>
                                <div class="node-add-button">
                                    <add-button href="#" :click-handler="chooseBookmark" class="hover-target d-none"></add-button>
                                </div>
                            </template>

                            <template v-slot:content>

                                <ul class="list-group list-group-flush" id="sort-container-tags">
                                    <draggable v-model="bookmarkList" @change="onChange" ghost-class="sortable-ghost" draggable=".draggable">
                                        <transition-group type="transition" class="w-100">
                                            <li v-for="(bookmark, index) in bookmarkList" class="node-bookmark list-group-item list-group-item-secondary text-info draggable p-0 mt-2" :data-uuid="bookmark.id" :key="bookmark.id" v-cloak v-b-hover="handleHover">
                                                <div class="d-flex">
                                                    <div v-html="bookmark.favicon_url" class="pr-2"></div>
                                                    <div>
                                                        <a :href="bookmark.url">[[ bookmark.name ]]</a>

                                                        <div v-if="bookmark.note" v-on:click="activateInEditMode(bookmark, $event.target)" v-show="!bookmark.noteIsEditable" class="node-note" v-html="getNote(bookmark.note)"></div>
                                                        <span v-show="bookmark.noteIsEditable">
                                                            <input type="text" class="form-control form-control-sm" :value="bookmark.note" ref="input" placeholder="" @blur="editNote(bookmark.id, $event.target.value)" @keydown.enter="editNote(bookmark.id, $event.target.value)" >
                                                        </span>
                                                    </div>

                                                    <div class="dropdownmenu hidden">
                                                        <dropdown-menu v-model="show" transition="translate-fade-down">
                                                            <font-awesome-icon icon="ellipsis-v"></font-awesome-icon>
                                                            <div slot="dropdown">
                                                                <a class="dropdown-item" href="#" @click.prevent="removeBookmark(bookmark.id)">Remove</a>
                                                                <a v-if="!bookmark.note" class="dropdown-item" href="#" @click.prevent="addNote(bookmark.id, index)">Add note</a>
                                                            </div>
                                                        </dropdown-menu>
                                                    </div>

                                                </div>

                                            </li>
                                            <div class="text-secondary" v-if="bookmarkList.length == 0" :key="1" v-cloak>
                                                No links
                                            </div>
                                        </transition-group>
                                    </draggable>
                                </ul>
                            </template>
                        </card>
                    </bookmark-list>
                </div>
            </div>

            </div>

            <bookmark-search inline-template ref="bookmarkSearch">
                <div class="modal fade" id="modalAddBookmark" tabindex="-1" role="dialog">

                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h4 class="modal-title" id="myModalLabel">Add bookmark</h4>
                                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button>
                            </div>
                            <div class="modal-body">

                                <form id="search" action="" method="get" autocomplete="off">
                                    <div class="form-row align-items-center">

                                        <div class="form-row">
                                            <simple-suggest
                                                ref="simpleSuggest"
                                                display-attribute="name"
                                                value-attribute="name"
                                                search-url="{% url 'node:search_bookmarks' %}?term="
                                            >
                                            </simple-suggest>
                                        </div>
                                    </div>
                                </form>

                            </div>
                        </div>
                    </div>
                </div>
            </bookmark-search>

            <blob-select
                ref="blobSelect"
                search-blob-url="{% url 'search:search_names' %}?doc_type=blob,book,document,note&term="
                recent-blobs-url="{% url "blob:recent_blobs" %}"
                @select-blob="selectBlob"
            />

        </div>

    </div>

{% endblock %}

{% block javascript %}

    {{ block.super }}

    <script type="text/javascript">

        axios.defaults.xsrfCookieName = "csrftoken"
        axios.defaults.xsrfHeaderName = "X-CSRFTOKEN"

        const store = new Vuex.Store({
            state: {
                nodeUuid: "{{ object.uuid }}",
            },
            getters: {},
            mutations: {},
        });

        const BlobList = {
            data() {
                return {
                    blobList: [],
                    show: false
                }
            },
            methods: {
                getBlobList() {
                    doGet(
                        this,
                        "{% url "node:get_blob_list" object.uuid %}",
                        (response) => {
                            this.blobList = response.data.blob_list;
                            // Let Vue know that each blob's "noteIsEditable" property is reactive
                            for (blob of this.blobList) {
                                this.$set(blob, "noteIsEditable", false);
                            }
                        },
                        "Error getting blob list"
                    );
                },
                chooseBlob() {
                    this.$parent.$refs.blobSelect.openModal();
                },
                onChange(evt) {

                    blobUuid = evt.moved.element.uuid;

                    // The backend expects the ordering to begin
                    // with 1, not 0, so add 1.
                    newPosition = evt.moved.newIndex + 1;

                    doPost(
                        this,
                        "{% url "node:sort_blobs" %}",
                        {
                            "node_uuid": this.$store.state.nodeUuid,
                            "blob_uuid": blobUuid,
                            "new_position": newPosition
                        },
                        () => {},
                        ""
                    );

                },
                handleHover(hovered, evt) {
                    evt.currentTarget.querySelector(".dropdownmenu").classList.toggle("d-flex");
                },
                activateInEditMode(blob, event) {

                    const isUuid = (value) => value.uuid == blob.uuid;
                    const index = this.blobList.findIndex(isUuid);

                    this.$set(this.blobList[index], "noteIsEditable", true);

                    setTimeout( () => { event.nextElementSibling.querySelector("input").focus() }, 100)

                },
                addNote(blob_uuid, index) {

                    for (blob of this.blobList) {
                        if (blob.uuid == blob_uuid) {
                            blob.noteIsEditable = true;
                        }
                    }

                    this.$nextTick(() => {
                        this.$refs.input[index].focus();
                    })

                },
                removeBlob(blob_uuid) {

                    doPost(
                        this,
                        "{% url "node:remove_blob" %}",
                        {
                            "node_uuid": this.$store.state.nodeUuid,
                            "blob_uuid": blob_uuid,
                        },
                        (response) => {
                            this.getBlobList();
                        },
                        "Blob removed",
                        ""
                    );

                },
                editNote(blob_uuid, note) {

                    if (this.editingNote) {
                        return;
                    }
                    this.editingNote = true;

                    for (blob of this.blobList) {
                        if (blob.uuid == blob_uuid) {

                            // If the note hasn't changed, abort
                            if (note == blob.note) {
                                blob.noteIsEditable = false;
                                this.editingNote = false;
                                return;
                            }

                            doPost(
                                this,
                                "{% url "node:edit_blob_note" %}",
                                {
                                    "node_uuid": this.$store.state.nodeUuid,
                                    "blob_uuid": blob.uuid,
                                    "note": note
                                },
                                (response) => {
                                    this.getBlobList();
                                },
                                "",
                                ""
                            );

                            this.editingNote = false;

                        }
                    }
                }
            },
            mounted() {

                this.getBlobList();

            }
        }

        const BookmarkList = {
            data() {
                return {
                    bookmarkList: [],
                    show: false
                }
            },
            methods: {
                getBookmarkList() {
                    doGet(
                        this,
                        "{% url "node:get_bookmark_list" object.uuid %}",
                        (response) => {
                            this.bookmarkList = response.data.bookmark_list;

                            // Let Vue know that each blob's "noteIsEditable" property is reactive
                            for (bookmark of this.bookmarkList) {
                                this.$set(bookmark, "noteIsEditable", false);
                            }
                        },
                        "Error getting bookmark list"
                    );
                },
                chooseBookmark() {
                    $("#modalAddBookmark").modal("show");
                    setTimeout( () => { this.$parent.$refs.bookmarkSearch.$refs.simpleSuggest.$refs.suggestComponent.input.focus(); }, 500)
                },
                onChange(evt) {

                    bookmarkId = evt.moved.element.id;

                    // The backend expects the ordering to begin
                    // with 1, not 0, so add 1.
                    newPosition = evt.moved.newIndex + 1;

                    doPost(
                        this,
                        "{% url "node:sort_bookmarks" %}",
                        {
                            "node_uuid": this.$store.state.nodeUuid,
                            "bookmark_id": bookmarkId,
                            "new_position": newPosition
                        },
                        () => {},
                        "",
                        ""
                    );

                },
                activateInEditMode(bookmark, event) {

                    const isId = (value) => value.id == bookmark.id;
                    const index = this.bookmarkList.findIndex(isId);

                    this.$set(this.bookmarkList[index], "noteIsEditable", true);

                    setTimeout( () => { event.nextElementSibling.querySelector("input").focus() }, 100)

                },
                addNote(bookmark_id, index) {

                    for (bookmark of this.bookmarkList) {
                        if (bookmark.id == bookmark_id) {
                            bookmark.noteIsEditable = true;
                        }
                    }

                    this.$nextTick(() => {
                        this.$refs.input[index].focus();
                    })

                },
                addBookmark(bookmark_id) {

                    doPost(
                        this,
                        "{% url "node:add_bookmark" %}",
                        {
                            "node_uuid": this.$store.state.nodeUuid,
                            "bookmark_id": bookmark_id,
                        },
                        (response) => {
                            this.getBookmarkList();
                        },
                        "Bookmark added",
                        ""
                    );

                },
                handleHover(hovered, evt) {
                    evt.currentTarget.querySelector(".dropdownmenu").classList.toggle("d-flex");
                },
                removeBookmark(bookmark_id) {

                    doPost(
                        this,
                        "{% url "node:remove_bookmark" %}",
                        {
                            "node_uuid": this.$store.state.nodeUuid,
                            "bookmark_id": bookmark_id
                        },
                        (response) => {
                            this.getBookmarkList();
                        },
                        "Bookmark removed",
                        ""
                    );

                },
                getNote(note) {
                    return markdown.render(note);
                },
                editNote(bookmark_id, note) {

                    if (this.editingNote) {
                        return;
                    }
                    this.editingNote = true;

                    for (bookmark of this.bookmarkList) {
                        if (bookmark.id == bookmark_id) {

                            // If the note hasn't changed, abort
                            if (note == bookmark.note) {
                                bookmark.noteIsEditable = false;
                                this.editingNote = false;
                                return;
                            }

                            doPost(
                                this,
                                "{% url "node:edit_bookmark_note" %}",
                                {
                                    "node_uuid": this.$store.state.nodeUuid,
                                    "bookmark_id": bookmark.id,
                                    "note": note
                                },
                                (response) => {
                                    this.getBookmarkList();
                                },
                                "",
                                ""
                            );

                            this.editingNote = false;

                        }
                    }
                }
            },
            mounted() {
                this.getBookmarkList();
            }
        }

        const BookmarkSearch = {
            methods: {
                select(selection) {

                    EventBus.$emit("add-bookmark", selection.id);
                    $("#modalAddBookmark").modal("hide");

                    this.$nextTick(() => {
                        this.$refs.simpleSuggest.$refs.suggestComponent.$el.querySelector("input").blur();
                        this.$refs.simpleSuggest.$refs.suggestComponent.setText("");
                    });


                },
                boldenSuggestion(scope) {

                    if (!scope) return scope;

                    const { suggestion, query } = scope;

                    let result = this.$refs.simpleSuggest.$refs.suggestComponent.displayProperty(suggestion);

                    if (!query) return result;

                    const texts = query.split(/[\s-_/\\|\.]/gm).filter(t => !!t) || [''];
                    return result.replace(new RegExp('(.*?)(' + texts.join('|') + ')(.*?)','gi'), '$1<b>$2</b>$3');
                }
            }
        };

        const Note = {
            data() {
                return {
                    note: null,
                    show: false,
                    minNumberRows: 10
                }
            },
            methods: {
                editNote() {
                    this.$refs.note.editNote();
                },
                getNote() {
                    doGet(
                        this,
                        "{% url "node:get_note" object.uuid %}",
                        (response) => {
                            this.note = response.data.note;
                            this.$refs.note.setTextAreaValue(response.data.note);
                        },
                        "Error getting note"
                    );
                },
                setSelectionRange(input, selectionStart, selectionEnd) {
                    if (input.setSelectionRange) {
                    }
                },
                handleHover(hovered, evt) {
                    if (! this.note) {
                        return;
                    }
                    evt.currentTarget.querySelector(".dropdown").classList.toggle("hidden");
                }
            },
            mounted() {
                this.getNote();
            }
        }

        new Vue({
            el: "#vue-app",
            store,
            components: {
                BlobList,
                BookmarkList,
                BlobSelect,
                BookmarkSearch,
                Note
            },
            methods: {
                handleHover(hovered, evt) {
                    evt.currentTarget.querySelector(".hover-target").classList.toggle("d-flex");
                },
                selectBlob(blobUuid) {

                    doPost(
                        this,
                        "{% url "node:add_blob" %}",
                        {
                            "node_uuid": this.$store.state.nodeUuid,
                            "blob_uuid": blobUuid,
                        },
                        (response) => {
                            this.$refs.blobList.getBlobList();
                            this.$refs.blobSelect.$refs.simpleSuggest.$refs.suggestComponent.selected = null;
                        },
                        "Blob added",
                        ""
                    );

                },
            },
            mounted() {

                EventBus.$on("add-blob", payload => {
                    this.$refs.blobList.addBlob(payload);
                });

                EventBus.$on("add-bookmark", payload => {
                    this.$refs.bookmarkList.addBookmark(payload);
                });

            }
        });

    </script>

{% endblock %}
