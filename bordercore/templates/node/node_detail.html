{% extends "base.html" %}

{% load dict_get %}

{% load favicon %}

{% block title %} Node <span class="node-name">{{ node.name }}</span> {% endblock %}

{% block nav %}

    <div class="d-flex mb-3">
        <div class="me-auto align-self-center">
            <ul class="breadcrumb mb-0 pt-0 pb-0">
                <li class="breadcrumb-item"> <a href="{% url 'node:list' %}">Nodes</a> </li>
                <li class="breadcrumb-item active">{{ node.name }}</li>
            </ul>
        </div>
    </div>

{% endblock %}

{% block content %}

    <div id="vue-app">

        <div class="row g-0 h-100">
            <div class="col-lg-4 d-flex flex-column">

                <node-blob-list
                    ref="blobList"
                    edit-blob-note-url="{% url "node:edit_blob_note" %}"
                    get-blob-list-url="{% url "node:get_blob_list" object.uuid %}"
                    remove-blob-url="{% url "node:remove_blob" %}"
                    sort-blobs-url="{% url "node:sort_blobs" %}"
                >
                </node-blob-list>

                <node-note
                    node-uuid="{{ object.uuid }}"
                    get-node-url="{% url "node:get_note" object.uuid %}"
                    edit-url="{% url "node:edit_note" %}"
                >
                </node-note>

            </div>

            <div class="col-lg-4 d-flex flex-column">
                <related-bookmarks-list
                    ref="relatedBookmarksList"
                    object-uuid="{{ object.uuid }}"
                    model-name="node.Node"
                    title="Bookmarks"
                    get-bookmark-list-url="{% url 'bookmark:get_related_bookmark_list' object.uuid %}?model_name=node.Node"
                    create-bookmark-url="{% url 'bookmark-list' %}"
                    search-bookmark-url="{% url 'bookmark:search' %}"
                    get-title-from-url-url="{% url 'drill:get_title_from_url' %}"
                    add-bookmark-url="{% url 'bookmark:add_related_bookmark' %}"
                    :update-modified="true"
                    remove-bookmark-url="{% url 'bookmark:remove_related_bookmark' %}"
                    sort-bookmark-list-url="{% url 'bookmark:sort_related_bookmarks' %}"
                    edit-bookmark-note-url="{% url 'bookmark:edit_related_bookmark_note' %}"
                    :show-add-button="true"
                    extra-class="embedded-card ms-3"
                    transition-name=""
                >
                </related-bookmarks-list>
            </div>

            <blob-select
                ref="blobSelect"
                search-blob-url="{% url 'search:search_names' %}?doc_type=blob,book,document,note&term="
                recent-blobs-url="{% url "blob:recent_blobs" %}"
                @select-blob="selectBlob"
            />

            </div>

        </div>

    </div>

{% endblock %}

{% block javascript %}

    {{ block.super }}

    <script type="text/javascript">

        const store = new Vuex.Store({
            state: {
                nodeUuid: "{{ object.uuid }}",
            },
            getters: {},
            mutations: {},
        });

        new Vue({
            el: "#vue-app",
            store,
            components: {
                BlobSelect,
                NodeBlobList,
                NodeNote,
            },
            methods: {
                selectBookmark(bookmark_uuid) {
                    doPost(
                        this,
                        "{% url "node:add_bookmark" %}",
                        {
                            "node_uuid": this.$store.state.nodeUuid,
                            "bookmark_uuid": bookmark_uuid,
                        },
                        (response) => {
                            this.getBookmarkList();
                        },
                        "Bookmark added",
                        ""
                    );
                },
                selectBlob(blob) {
                    doPost(
                        this,
                        "{% url "node:add_blob" %}",
                        {
                            "node_uuid": this.$store.state.nodeUuid,
                            "blob_uuid": blob.uuid,
                        },
                        (response) => {
                            this.$refs.blobList.getBlobList();
                            this.$refs.blobSelect.$refs.simpleSuggest.$refs.suggestComponent.selected = null;
                        },
                        "Blob added",
                        ""
                    );

                },
            },
            mounted() {

                EventBus.$on("add-blob", payload => {
                    this.$refs.blobList.addBlob(payload);
                });

                EventBus.$on("add-bookmark", payload => {
                    this.$refs.bookmarkList.addBookmark(payload);
                });

            }
        });

    </script>

{% endblock %}
