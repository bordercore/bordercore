{% extends "base.html" %}

{% load dict_get %}

{% load favicon %}

{% block title %} Node <span class="node-name">{{ node.name }}</span> {% endblock %}

{% block nav %}

    <div id="vue-nav" class="d-flex align-items-center mb-3">
        <div class="flex-grow-1 me-auto align-self-center">
            <ul class="breadcrumb mb-0 pt-0 pb-0">
                <li class="breadcrumb-item"> <a href="{% url 'node:list' %}">Nodes</a> </li>
                <li class="breadcrumb-item active" v-cloak>[[ $store.state.nodeName ]]</li>
            </ul>
        </div>
        <Transition name="fade" v-cloak>
            <div v-if="$store.state.editLayout" class="text-primary ms-auto me-5">
                Edit Layout
            </div>
        </Transition>
        <drop-down-menu
            ref="dropDownMenu"
            class="me-3"
            v-cloak
        >
            <div slot="dropdown" class="mt-0">
                <li>
                    <a class="dropdown-item" href="#" @click.prevent="onUpdateNode">
                        <span v-cloak>
                            <font-awesome-icon icon="plus" class="text-primary me-3"></font-awesome-icon>
                            Update node
                        </span>
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="#" @click.prevent="onAddCollection">
                        <span v-cloak>
                            <font-awesome-icon icon="plus" class="text-primary me-3"></font-awesome-icon>
                            Add collection
                        </span>
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="#" @click.prevent="onAddNote">
                        <span v-cloak>
                            <font-awesome-icon icon="plus" class="text-primary me-3"></font-awesome-icon>
                            Add note
                        </span>
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="#" @click.prevent="onAddImage">
                        <span v-cloak>
                            <font-awesome-icon icon="plus" class="text-primary me-3"></font-awesome-icon>
                            Add image
                        </span>
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="#" @click.prevent="onAddQuote">
                        <span v-cloak>
                            <font-awesome-icon icon="plus" class="text-primary me-3"></font-awesome-icon>
                            Add quote
                        </span>
                    </a>
                </li>
                <li v-if="!hasTodoList">
                    <a class="dropdown-item" href="#" @click.prevent="onAddTodoList">
                        <span v-cloak>
                            <font-awesome-icon icon="plus" class="text-primary me-3"></font-awesome-icon>
                            Add todo list
                        </span>
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="#" @click.prevent="onEditMode">
                        <span v-cloak>
                            <font-awesome-icon icon="pencil-alt" class="text-primary me-3"></font-awesome-icon>
                            [[ editLayoutDropDownItemValue ]]
                        </span>
                    </a>
                </li>
            </div>
        </drop-down-menu>

        <div class="modal fade" id="modalUpdateNode" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title" id="myModalLabel">
                            Update Node
                        </h4>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-3">
                            <label class="col-lg-3 col-form-label" for="inputTitle">Name</label>
                            <div class="col-lg-9">
                                <input type="text" autocomplete="off" maxlength="200" id="id_node_name" :value="$store.state.nodeName" class="form-control">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <input id="btn-action" class="btn btn-primary" type="button" value="Update" @click.prevent="onClickUpdateNode">
                    </div>
                </div>
            </div>
        </div>

    </div>

{% endblock %}

{% block content %}

    <div id="vue-app">

        <create-update-todo
            ref="updateTodo"
            :priority-list="JSON.parse('{{ priority_list }}')"
            update-todo-url="{% url 'todo-detail' '00000000-0000-0000-0000-000000000000' %}"
            create-todo-url="{% url 'todo-list' %}"
            tag-search-url="{% url 'tag:search' %}?query="
            @post-todo-add="addNodeTodo"
            @post-todo-update="refreshNodeTodo"
        >
        </create-update-todo>

        <div class="d-flex g-0 h-100 mx-2">

            <div v-for="(column, colIndex) in $store.state.layout" class="flex-even">
                <draggable
                    drag-class="draggable-chosen-class"
                    @change="onLayoutChange"
                    :list="$store.state.layout[colIndex]"
                    group="object"
                    :data-col-number="colIndex"
                    :disabled="!$store.state.editLayout"
                    class="position-relative"
                    :style="'z-index: ' + (2*10 - colIndex)"
                >
                    <div v-for="(obj, rowIndex) in column" class="position-relative" :style="'z-index: ' + (2*10 - colIndex - rowIndex)">
                        <div v-if="obj.type === 'collection'" :key="obj.uuid">
                            <collection-object-list
                                node-uuid="{{ object.uuid }}"
                                :uuid="obj.uuid"
                                :collection-object-list-initial="obj"
                                update-collection-url="{% url "node:update_collection" %}"
                                update-object-note-url="{% url "collection:update_object_note" %}"
                                :get-object-list-url="'{% url "collection:get_object_list" '00000000-0000-0000-0000-000000000000' %}'.replace('00000000-0000-0000-0000-000000000000', obj.uuid)"
                                remove-object-url="{% url "collection:remove_object" %}"
                                sort-objects-url="{% url "collection:sort_objects" %}"
                                @delete-collection="onDeleteCollection"
                                @open-modal-note-image="openModalNoteImage"
                                @open-modal-collection-update="openModalCollectionUpdate"
                            >
                            </collection-object-list>
                        </div>
                        <div v-if="obj.type === 'note'" :draggable="$store.state.editLayout" :key="obj.uuid">
                            <node-note
                                node-uuid="{{ object.uuid }}"
                                :node-note-initial="obj"
                                :get-node-url="'{% url "blob-detail" '00000000-0000-0000-0000-000000000000' %}'.replace('00000000-0000-0000-0000-000000000000', obj.uuid)"
                                :update-note-url="'{% url "blob-detail" '00000000-0000-0000-0000-000000000000' %}'.replace('00000000-0000-0000-0000-000000000000', obj.uuid)"
                                :set-note-color-url="'{% url "node:set_note_color" %}'"
                                @delete-note="onDeleteNote"
                                @open-modal-note-update="openModalNoteUpdate"
                            >
                            </node-note>
                        </div>
                        <div v-else-if="obj.type === 'todo'" :draggable="$store.state.editLayout" key="todo">
                            <node-todo-list
                                ref="todoList"
                                node-uuid="{{ object.uuid }}"
                                get-todo-list-url="{% url "node:get_todo_list" object.uuid %}"
                                add-node-todo-url="{% url "node:add_todo" %}"
                                remove-node-todo-url="{% url 'todo-detail' '00000000-0000-0000-0000-000000000000' %}"
                                sort-node-todos-url="{% url 'node:sort_todos' %}"
                                @delete-todo-list="onDeleteTodoList"
                            >
                            </node-todo-list>
                        </div>
                        <div v-else-if="obj.type === 'image'" :draggable="$store.state.editLayout" key="obj.uuid">
                            <node-image
                                :image-uuid="obj.uuid"
                                :image-title="obj.image_title"
                                :image-url="obj.image_url"
                                @open-modal-note-image="openModalNoteImage"
                                @remove-image="onRemoveImage"
                            >
                            </node-image>
                        </div>
                        <div v-else-if="obj.type === 'quote'" :draggable="$store.state.editLayout" key="quote">
                            <node-quote
                                ref="quote"
                                node-uuid="{{ object.uuid }}"
                                :node-quote-initial="obj"
                                get-quote-url="{% url "quote-detail" '00000000-0000-0000-0000-000000000000' %}"
                                :get-and-set-quote-url="'{% url "node:get_quote" %}'"
                                :update-quote-url="'{% url "node:update_quote" %}'"
                                @remove-quote="onRemoveQuote(obj.node_quote_uuid)"
                                @open-modal-quote-update="openModalQuoteUpdate"
                            >
                            </node-todo>
                        </div>
                    </div>
                </draggable>
            </div>

            <collection-object-list-modal
                ref="collectionUpdate"
                add-collection-url="{% url 'node:add_collection' %}"
                search-url="{% url 'collection:search' %}?query="
            >
            </collection-object-list-modal>

            <node-note-modal ref="noteUpdate">
            </node-note-modal>

            <node-image-modal ref="noteImage">
            </node-image-modal>

            <node-quote-modal ref="quoteUpdate">
            </node-quote-modal>

            <object-select
                :has-filter="false"
                :initial-doctypes="['image']"
                label="_objectSelectImage"
                ref="objectSelectImage"
                search-object-url="{% url 'search:search_names' %}"
                title="Add Image"
                @select-object="selectObjectImage"
            >
            </object-select>
            <object-select
                label="_objectSelectCollection"
                ref="objectSelectCollection"
                search-object-url="{% url 'search:search_names' %}"
                @select-object="selectObjectCollection"
            >
            </object-select>

        </div>

    </div>

{% endblock %}

{% block javascript %}

    {{ block.super }}

    {{ object.layout|json_script:"layout" }}

    <script type="text/javascript">

        const store = new Vuex.Store({
            state: {
                editLayout: false,
                layout: JSON.parse(document.getElementById("layout").textContent),
                nodeName: "{{ object.name }}",
                nodeUuid: "{{ object.uuid }}",
            },
            getters: {},
            mutations: {},
        });

        new Vue({
            el: "#vue-nav",
            name: "Nav",
            store,
            methods: {
                onAddCollection() {
                    EventBus.$emit("open-collection-modal");
                },
                onAddImage() {
                    EventBus.$emit("object-select-image");
                },
                onAddQuote() {
                    doPost(
                        this,
                        "{% url "node:add_quote" %}",
                        {
                            "node_uuid": this.$store.state.nodeUuid,
                        },
                        (response) => {
                            EventBus.$emit("update-layout", response.data.layout);
                        },
                        "Quote added",
                        ""
                    );
                },
                onAddNote() {
                    EventBus.$emit("open-note-modal");
                },
                onAddTodoList() {
                    doPost(
                        this,
                        "{% url "node:add_todo_list" %}",
                        {
                            "node_uuid": this.$store.state.nodeUuid,
                        },
                        (response) => {
                            EventBus.$emit("update-layout", response.data.layout);
                        },
                        "Todo list added",
                        ""
                    );
                },
                onClickUpdateNode() {
                    const name = document.querySelector("#id_node_name").value;
                    doPut(
                        this,
                        "{% url 'node-detail' object.uuid %}",
                        {
                            "node_uuid": "{{ object.uuid }}",
                            "name": name,
                        },
                        (response) => {
                            this.$store.state.nodeName = name;
                            document.querySelector(".node-name").innerHTML = name;
                            const modal = Modal.getInstance(document.querySelector("#modalUpdateNode"));
                            modal.hide();
                        },
                        "Node updated",
                    );

                },
                onEditMode() {
                    this.$store.state.editLayout = !this.$store.state.editLayout;
                },
                onUpdateNode() {
                    const modal = new Modal("#modalUpdateNode");
                    modal.show();
                    setTimeout(() => {
                        document.querySelector("#id_node_name").focus();
                    }, 500);
                }
            },
            computed: {
                editLayoutDropDownItemValue: function() {
                    return this.$store.state.editLayout ? "Disable Edit Layout" : "Enable Edit Layout"
                },
                hasTodoList() {
                    for (const col of this.$store.state.layout) {
                        for (const row of col) {
                            if (row.type === "todo") {
                                return true;
                            }
                        }
                    }
                    return false;
                },
            },
        });

        new Vue({
            el: "#vue-app",
            name: "Node Detail",
            store,
            methods: {
                addCollection(collectionObjectList) {
                    doPost(
                        this,
                        "{% url "node:add_collection" %}",
                        {
                            "node_uuid": this.$store.state.nodeUuid,
                            "collection_name": collectionObjectList.name,
                        },
                        (response) => {
                            EventBus.$emit("update-layout", response.data.layout);
                        },
                        "Collection added",
                        ""
                    );
                },
                addNote(note) {
                    doPost(
                        this,
                        "{% url "node:add_note" %}",
                        {
                            "node_uuid": this.$store.state.nodeUuid,
                            "note_name": note.name,
                            "color": note.color,
                        },
                        (response) => {
                            EventBus.$emit("update-layout", response.data.layout);
                        },
                        "Note added",
                        ""
                    );
                },
                addNodeTodo(payload) {
                    this.$refs.todoList[0].addNodeTodo(payload);
                },
                refreshNodeTodo(payload) {
                    this.$refs.todoList[0].getTodoList();
                },
                selectObjectImage(object, callback) {
                    doPost(
                        this,
                        "{% url "node:add_image" %}",
                        {
                            "node_uuid": this.$store.state.nodeUuid,
                            "image_uuid": object.uuid,
                        },
                        (response) => {
                            if (callback) {
                                callback();
                            }
                            EventBus.$emit("update-layout", response.data.layout);
                        },
                        "Image added",
                        ""
                    );
                },
                selectObjectCollection(object, callback, returnArgs) {
                    let args = {
                        "collection_uuid": returnArgs.collectionUuid
                    };
                    if (object.doctype === "Bookmark") {
                        args.bookmark_uuid = object.uuid;
                    } else {
                        args.blob_uuid = object.uuid;
                    }

                    doPost(
                        this,
                        "{% url "collection:add_object" %}",
                        args,
                        (response) => {
                            callback();
                        },
                        "Object added",
                        ""
                    );
                },
                onDeleteCollection(collectionUuid, collectionType) {
                    doPost(
                        this,
                        "{% url "node:delete_collection" %}",
                        {
                            "node_uuid": this.$store.state.nodeUuid,
                            "collection_uuid": collectionUuid,
                            "collection_type": collectionType,
                        },
                        (response) => {
                            this.$store.state.layout = JSON.parse(response.data.layout);
                        },
                        "Collection deleted",
                    );
                },
                onDeleteTodoList() {
                    doPost(
                        this,
                        "{% url 'node:delete_todo_list' %}",
                        {
                            "node_uuid": this.$store.state.nodeUuid,
                        },
                        (response) => {
                            this.$store.state.layout = JSON.parse(response.data.layout);
                        },
                        "Todo list deleted",
                    );
                },
                onRemoveImage(imageUuid) {
                    doPost(
                        this,
                        "{% url "node:remove_image" %}",
                        {
                            "node_uuid": this.$store.state.nodeUuid,
                            "image_uuid": imageUuid,
                        },
                        (response) => {
                            this.$store.state.layout = JSON.parse(response.data.layout);
                        },
                        "Image removed",
                    );
                },
                onRemoveQuote(nodeQuoteUuid) {
                    doPost(
                        this,
                        "{% url "node:remove_quote" %}",
                        {
                            "node_uuid": this.$store.state.nodeUuid,
                            "node_quote_uuid": nodeQuoteUuid,
                        },
                        (response) => {
                            this.$store.state.layout = JSON.parse(response.data.layout);
                        },
                        "Quote removed",
                    );
                },
                openModalCollectionUpdate(callback, data) {
                    this.$refs.collectionUpdate.openModal("Update", callback, data);
                },
                openModalNoteUpdate(callback, data) {
                    this.$refs.noteUpdate.openModal("Update", callback, data);
                },
                openModalNoteImage(data) {
                    this.$refs.noteImage.openModal(data);
                },
                openModalQuoteUpdate(callback, data) {
                    this.$refs.quoteUpdate.openModal("Update", callback, data);
                },
                onDeleteNote(noteUuid) {
                    doPost(
                        this,
                        "{% url "node:delete_note" %}",
                        {
                            "node_uuid": this.$store.state.nodeUuid,
                            "note_uuid": noteUuid,
                        },
                        (response) => {
                            this.$store.state.layout = JSON.parse(response.data.layout);
                        },
                        "Note deleted",
                    );
                },
                onDragOver(evt, index) {
                    evt.currentTarget.classList.add("node-drag-over");
                },
                onDragLeave(evt) {
                    evt.currentTarget.classList.remove("node-drag-over");
                },
                onLayoutChange(evt) {
                    doPost(
                        this,
                        "{% url "node:change_layout" %}",
                        {
                            "node_uuid": this.$store.state.nodeUuid,
                            "layout": JSON.stringify(this.$store.state.layout),
                        },
                        (response) => {
                        },
                        "",
                        ""
                    );
                },
            },
            mounted() {
                EventBus.$on("add-blob", (payload) => {
                    this.$refs.blobList.addBlob(payload);
                });

                EventBus.$on("add-bookmark", (payload) => {
                    this.$refs.bookmarkList.addBookmark(payload);
                });

                EventBus.$on("open-collection-modal", (payload) => {
                    this.$refs.collectionUpdate.openModal("Add", this.addCollection, {"display": "list"});
                });

                EventBus.$on("open-note-modal", (payload) => {
                    this.$refs.noteUpdate.openModal("Add", this.addNote, {"color": 1});
                });

                EventBus.$on("object-select-image", (payload) => {
                    this.$refs.objectSelectImage.openModal();
                });

                EventBus.$on("update-layout", (payload) => {
                    this.$store.state.layout = JSON.parse(payload);
                });
            }
        });

    </script>

{% endblock %}

{% block help %}

    <div class="d-none" id="help-text">
# Quote Keyboard Shortcuts
- **Right-Arrow** *-* Skip
- **U** *-* Update
    </div>

{% endblock %}
