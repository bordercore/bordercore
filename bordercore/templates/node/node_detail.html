{% extends "base.html" %}

{% load dict_get %}

{% load favicon %}

{% block title %} Node <span class="node-name">{{ node.name }}</span> {% endblock %}

{% block nav %}

    <div id="vue-nav" class="d-flex align-items-center mb-3">
        <div class="flex-grow-1 me-auto align-self-center">
            <ul class="breadcrumb mb-0 pt-0 pb-0">
                <li class="breadcrumb-item"> <a href="{% url 'node:list' %}">Nodes</a> </li>
                <li class="breadcrumb-item active">{{ node.name }}</li>
            </ul>
        </div>
        <div v-if="$store.state.editLayout" class="text-primary ms-auto me-5">
            Edit Layout
        </div>
        <drop-down-menu
            ref="dropDownMenu"
            class="me-3"
        >
            <div slot="dropdown" class="mt-0">
                <li>
                    <a class="dropdown-item" href="#" @click.prevent="onAddCollection">
                        <span v-cloak>
                            <font-awesome-icon icon="plus" class="text-primary me-3"></font-awesome-icon>
                            Add collection
                        </span>
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="#" @click.prevent="onEditMode">
                        <span v-cloak>
                            <font-awesome-icon icon="pencil-alt" class="text-primary me-3"></font-awesome-icon>
                            [[ editLayoutDropDownItemValue ]]
                        </span>
                    </a>
                </li>
            </div>
        </drop-down-menu>
    </div>

{% endblock %}

{% block content %}

    <div id="vue-app">

        <create-update-todo
            ref="updateTodo"
            :priority-list="JSON.parse('{{ priority_list }}')"
            update-todo-url="{% url 'todo-detail' '00000000-0000-0000-0000-000000000000' %}"
            create-todo-url="{% url 'todo-list' %}"
            tag-search-url="{% url 'tag:search' %}?query="
            @post-todo-add="addNodeTodo"
            @post-todo-update="refreshNodeTodo"
        >
        </create-update-todo>

        <div class="d-flex g-0 h-100 mx-2">

            <div v-for="(column, colIndex) in layout" class="flex-even">
                <draggable
                    @change="onChange($event)"
                    :list="layout[colIndex]"
                    group="object"
                    :data-col-number="colIndex"
                    :disabled="!$store.state.editLayout"
                >
                    <div v-for="(obj, rowIndex) in column">
                        <div v-if="obj.type === 'collection'" key="collection">
                            <collection-object-list
                                :initial-name="obj.name"
                                :uuid="obj.uuid"
                                :node-uuid="$store.state.nodeUuid"
                                update-collection-url="{% url "collection-detail" "00000000-0000-0000-0000-000000000000" %}"
                                update-object-note-url="{% url "collection:update_object_note" %}"
                                :get-object-list-url="'{% url "collection:get_object_list" '00000000-0000-0000-0000-000000000000' %}'.replace('00000000-0000-0000-0000-000000000000', obj.uuid)"
                                remove-object-url="{% url "collection:remove_object" %}"
                                sort-objects-url="{% url "collection:sort_objects" %}"
                                @delete-collection="onDeleteCollection"
                            >
                            </collection-object-list>
                        </div>
                        <div v-if="obj.type === 'blob'" key="blob">
                            <node-blob-list
                                ref="blobList"
                                edit-blob-note-url="{% url "node:edit_blob_note" %}"
                                get-blob-list-url="{% url "node:get_blob_list" object.uuid %}"
                                remove-blob-url="{% url "node:remove_blob" %}"
                                sort-blobs-url="{% url "node:sort_blobs" %}"
                            >
                            </node-blob-list>
                        </div>
                        <div v-else-if="obj.type === 'note'" :draggable="$store.state.editLayout" key="note">
                            <node-note
                                node-uuid="{{ object.uuid }}"
                                get-node-url="{% url "node:get_note" object.uuid %}"
                                edit-url="{% url "node:edit_note" %}"
                            >
                            </node-note>
                        </div>
                        <div v-else-if="obj.type === 'todo'" :draggable="$store.state.editLayout" key="todo">
                            <node-todo-list
                                ref="todoList"
                                node-uuid="{{ object.uuid }}"
                                get-todo-list-url="{% url "node:get_todo_list" object.uuid %}"
                                add-node-todo-url="{% url "node:add_todo" %}"
                                remove-node-todo-url="{% url 'todo-detail' '00000000-0000-0000-0000-000000000000' %}"
                                sort-node-todos-url="{% url 'node:sort_todos' %}"
                            >
                            </node-todo-list>
                        </div>
                        <div v-else-if="obj.type === 'bookmark'" :draggable="$store.state.editLayout" key="bookmark">
                            <related-bookmarks-list
                                ref="relatedBookmarksList"
                                object-uuid="{{ object.uuid }}"
                                model-name="node.Node"
                                title="Bookmarks"
                                get-bookmark-list-url="{% url 'bookmark:get_related_bookmark_list' object.uuid %}?model_name=node.Node"
                                add-bookmark-url="{% url 'bookmark:add_related_bookmark' %}"
                                :update-modified="true"
                                remove-bookmark-url="{% url 'bookmark:remove_related_bookmark' %}"
                                sort-bookmark-list-url="{% url 'bookmark:sort_related_bookmarks' %}"
                                edit-bookmark-note-url="{% url 'bookmark:edit_related_bookmark_note' %}"
                                :show-add-button="true"
                                transition-name=""
                            >
                            </related-bookmarks-list>
                        </div>
                    </div>
                </draggable>
            </div>

            <blob-select
                ref="blobSelect"
                search-blob-url="{% url 'search:search_names' %}?doc_type=blob,book,document,note"
                recent-blobs-url="{% url "blob:recent_blobs" %}"
                @select-blob="selectBlob"
            >
            </blob-select>
            <bookmark-select
                ref="bookmarkSelect"
                search-url="{% url 'bookmark:search' %}"
                create-bookmark-url="{% url 'bookmark-list' %}"
                get-title-from-url-url="{% url 'drill:get_title_from_url' %}"
                @select-bookmark="selectBookmark"
            >
            </bookmark-select>

        </div>

    </div>

{% endblock %}

{% block javascript %}

    {{ block.super }}

    {{ object.layout|json_script:"layout" }}

    <script type="text/javascript">

        const store = new Vuex.Store({
            state: {
                editLayout: false,
                nodeUuid: "{{ object.uuid }}",
            },
            getters: {},
            mutations: {},
        });

        new Vue({
            el: "#vue-nav",
            name: "Nav",
            store,
            methods: {
                onAddCollection() {
                    doPost(
                        this,
                        "{% url "node:add_collection" %}",
                        {
                            "node_uuid": this.$store.state.nodeUuid,
                        },
                        (response) => {
                            EventBus.$emit("update-layout", response.data.layout);
                        },
                        "Collection added",
                        ""
                    );
                },
                onEditMode() {
                    this.$store.state.editLayout = !this.$store.state.editLayout;
                },
            },
            computed: {
                editLayoutDropDownItemValue: function() {
                    return this.$store.state.editLayout ? "Disable Edit Layout" : "Enable Edit Layout"
                }
            },
        })

        new Vue({
            el: "#vue-app",
            name: "Node Detail",
            store,
            components: {
                BlobSelect,
            },
            data() {
                return {
                    layout: JSON.parse(document.getElementById("layout").textContent),
                }
            },
            methods: {
                addNodeTodo(payload) {
                    this.$refs.todoList[0].addNodeTodo(payload);
                },
                refreshNodeTodo(payload) {
                    this.$refs.todoList[0].getTodoList();
                },
                selectBookmark(bookmarkInfo, collectionUuid, callback) {
                    doPost(
                        this,
                        "{% url "collection:add_bookmark" %}",
                        {
                            "collection_uuid": collectionUuid,
                            "bookmark_uuid": bookmarkInfo.uuid,
                        },
                        (response) => {
                            callback();
                            this.$refs.bookmarkSelect.$refs.simpleSuggest.$refs.suggestComponent.selected = null;
                        },
                        "Bookmark added",
                        ""
                    );
                },
                selectBlob(blob, collectionUuid, callback) {
                    doPost(
                        this,
                        "{% url "collection:add_blob" %}",
                        {
                            "collection_uuid": collectionUuid,
                            "blob_uuid": blob.uuid,
                        },
                        (response) => {
                            callback();
                            this.$refs.blobSelect.$refs.simpleSuggest.$refs.suggestComponent.selected = null;
                        },
                        "Blob added",
                        ""
                    );
                },
                onDeleteCollection(collectionUuid) {
                    doPost(
                        this,
                        "{% url "node:delete_collection" %}",
                        {
                            "node_uuid": this.$store.state.nodeUuid,
                            "collection_uuid": collectionUuid,
                        },
                        (response) => {
                            this.layout = JSON.parse(response.data.layout);
                        },
                        "Collection deleted",
                    );

                },
                onDragOver(evt, index) {
                    evt.currentTarget.classList.add("node-drag-over");
                },
                onDragLeave(evt) {
                    evt.currentTarget.classList.remove("node-drag-over");
                },
                onChange(evt) {
                    doPost(
                        this,
                        "{% url "node:change_layout" %}",
                        {
                            "node_uuid": this.$store.state.nodeUuid,
                            "layout": JSON.stringify(this.layout),
                        },
                        (response) => {
                        },
                        "",
                        ""
                    );
                },
            },
            mounted() {
                EventBus.$on("add-blob", (payload) => {
                    this.$refs.blobList.addBlob(payload);
                });

                EventBus.$on("add-bookmark", (payload) => {
                    this.$refs.bookmarkList.addBookmark(payload);
                });

                EventBus.$on("update-layout", (payload) => {
                    this.layout = JSON.parse(payload);
                });
            }
        });

    </script>

{% endblock %}
