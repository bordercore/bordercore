{% extends "base.html" %}

{% load favicon %}

{% block title %} Bookmarks {% endblock %}

{% block content %}

    <div class="row g-0 h-100" id="vue-app">

        <div class="flex-grow-last col-lg-3 d-flex flex-column ps-2">

            {% if object %}
            <div class="card-body p-3">
                <div class="d-flex justify-content-center">
                    <img src="{{ object.thumbnail_url }}?foo=bar" class="mw-100" />
                </div>
            </div>
            {% endif %}

            <transition name="fade">
                <div v-show="showRelatedTags">
                    <related-tags
                        ref="relatedTags"
                        related-tags-url="{% url 'tag:get_related_tags' %}"
                        @click-tag="onClickTag"
                    >
                    </related-tags>
                </div>
            </transition>

            <div v-if="related_questions.length > 0" class="d-flex">
                <card title="Related Questions" class="backdrop-filter mw-100">
                    <template v-slot:content>
                        <ul class="list-group interior-borders cursor-pointer">
                            <li v-for="question in related_questions" class="hoverable px-0 list-group-item list-group-item-secondary text-primary">
                                <div class="d-flex">
                                    <div class="mt-1 me-2">
                                        <font-awesome-icon icon="question" class="text-success"></font-awesome-icon>
                                    </div>
                                    <div>
                                        <span v-html="question.question" @click="onClick(question.url)"></span>
                                        <div>
                                            <span v-for="tag in question.tags" class="badge bg-info me-2">[[ tag.tag ]]</span>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </template>
                </card>
            </div>

            <div v-if="related_blobs.length > 0" class="d-flex">
                <card title="Related Blobs" class="backdrop-filter">
                    <template v-slot:content>
                        <ul class="list-group interior-borders cursor-pointer">
                            <li v-for="blob in related_blobs" class="hoverable px-0 list-group-item list-group-item-secondary text-primary">
                                <div class="d-flex align-items-center">
                                    <div class="mt-1 me-2">
                                        <img :src="blob.cover_url" />
                                    </div>
                                    <div class="d-flex justify-content-center w-100">
                                        <a :href="blob.url">[[ blob.name ]]</a>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <span v-for="tag in blob.tags" class="badge bg-info me-2">[[ tag ]]</span>
                                </div>
                            </li>
                        </ul>
                    </template>
                </card>
            </div>

            <div v-if="related_nodes.length > 0" class="d-flex">
                <card title="Related Nodes" class="card-body backdrop-filter w-100">
                    <template v-slot:content>
                        <ul class="list-group interior-borders cursor-pointer">
                            <li v-for="node in related_nodes" class="hoverable px-0 list-group-item list-group-item-secondary text-primary">
                                <div class="d-flex align-items-center ps-3">
                                    <div class="d-flex w-100">
                                        <a :href="node.url">[[ node.name ]]</a>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </template>
                </card>
            </div>

        </div>

        <div class="col-lg-9">

            <div class="me-2">
                <div class="card-body">

                    <p class="lead offset-lg-2">
                        {{ form.instance.url|favicon|safe }} {{ action }} Bookmark
                    </p>

                    <form id="bookmark-form" action="{{ request.path }}" method="post">

                        {% csrf_token %}

                        {% for field in form %}

                            <div class="{% if field.errors %}error{% endif %} row mb-3">
                                <label class="fw-bold col-lg-2 col-form-label text-end">
                                    {{ field.label }}
                                </label>
                                <div class="col-lg-7">

                                    {% if field.label == 'Tags' %}
                                        <tags-input
                                            ref="tagsInput"
                                            search-url="{% url 'tag:search' %}?query="
                                            @tags-changed="onTagsChanged"
                                            @blur="onTagsBlur"
                                            @focus="onTagsFocus"
                                        >
                                        </tags-input>
                                    {% elif field.label == "Url" %}
                                        <input
                                            type="url"
                                            name="url"
                                            value="{{ field.value|default:'' }}"
                                            class="form-control"
                                            required
                                            id="id_url"
                                            {% if action == "Create" %}
                                                @blur="onBlur"
                                            {% endif %}
                                            autocomplete="off"
                                        />
                                        <div class="form-error">{{ field.errors.0 }}</div>
                                    {% else %}
                                        {{ field }}
                                        {% for error in field.errors %}
                                            <span class="form-error">{{ error }}</span>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>

                        {% endfor %}

                        <div>
                            <div class="col-lg-7 offset-lg-2">
                                <input class="btn btn-primary" type="submit" name="Go" value="{{ action }}" />
                                <input class="btn btn-secondary{% if not form.instance.id %} disabled{% endif %} ms-3" type="button" name="Go" value="Delete" @click="onClickDelete" />
                                <a href="{% url 'bookmark:overview' %}" class="ms-3">Cancel</a>
                            </div>
                        </div>

                    </form>

                </div>

            </div>

        </div>

    </div>

{% endblock %}

{% block javascript %}

    {{ block.super }}

    {{ tags|json_script:"initial-tags"|default:"" }}
    {{ related_blobs|json_script:"related_blobs" }}
    {{ related_nodes|json_script:"related_nodes" }}

    <script type="text/javascript">

        new Vue({
            el: "#vue-app",
            data() {
                return {
                    {% if bookmark.uuid %}
                    uuid: "{{ bookmark.uuid }}",
                    {% endif %}
                    related_questions: [
                        {% for question in related_questions %}
                        {
                            question: markdown.render("{{ question.question|escapejs }}"),
                            url: "{% url 'drill:detail' question.uuid %}",
                            tags: [
                                {% for tag in question.tags.all %}
                                {
                                    tag: "{{ tag }}",
                                },
                                {% endfor %}
                            ]
                        },
                        {% endfor %}
                    ],
                    related_blobs: JSON.parse(document.getElementById("related_blobs").textContent),
                    related_nodes: JSON.parse(document.getElementById("related_nodes").textContent),
                    showRelatedTags: false,
                }
            },
            mounted() {
                EventBus.$on("add-tag", (payload) => {
                    this.$refs.tagsInput.addTag({"text": payload, "display": payload});
                });
            },
            methods: {
                onClickDelete(evt) {
                    const formEl = document.getElementById("bookmark-form");
                    formEl.setAttribute("action", "{% url 'bookmark:delete' '00000000-0000-0000-0000-000000000000' %}".replace('00000000-0000-0000-0000-000000000000', this.uuid));
                    formEl.submit();
                },
                onClickTag(tag) {
                    EventBus.$emit("add-tag", tag);
                },
                onBlur(evt) {

                    // If the name has already been filled-in, abort
                    const name = document.getElementById("id_name");
                    if ( name.value ) {
                        return;
                    }

                    let url = document.getElementById("id_url").value;
                    if ( !url ) {
                        return;
                    }

                    url = encodeURIComponent(url).replace(/%/g, "%25");

                    doGet(
                        this,
                        "{% url "bookmark:get_title_from_url" %}?url=" + url,
                        (response) => {
                            name.value = response.data.title;
                        },
                        "Error getting title from url"
                    );

                },
                onClick(url) {
                    window.location = url;
                },
                onTagsChanged(tags) {
                    this.$refs.relatedTags.setTags(tags.map( (x) => x.display ));
                },
                onTagsBlur(tags) {
                    this.showRelatedTags = false;
                },
                onTagsFocus(tags) {
                    this.showRelatedTags = true;
                },
            }
        });

    </script>

{% endblock %}
