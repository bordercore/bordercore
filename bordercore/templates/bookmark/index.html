{% extends "base.html" %}

{% block title %} Bookmarks {% endblock %}

{% block content %}

    <div class="row no-gutters h-100">

        <div class="col-lg-3 d-flex flex-column">

            <div id="vue-pinned-tags" class="card-body">

                <h4>Pinned Tags</h4>

                <ul id="sort-container-tags" class="list-group flex-column w-100" v-cloak>
                    <tag-list inline-template>
                        <div>
                            <draggable v-model="$store.state.pinnedTags" @change="onSortTags" ghost-class="sortable-ghost" draggable=".draggable">
                                <transition-group type="transition" class="w-100">
                                    <li v-for="tag in $store.state.pinnedTags" class="bookmark-tag-list d-flex pl-2 py-1 pr-1" :class="{ 'selected rounded-sm': tag.name === $store.state.selectedTagName, draggable: tag.isDraggable }" @click.prevent="onClickTag" :data-tag="tag.name" :data-id="tag.id" :key="tag.id" @dragover="onDragOverTag($event)" @dragleave="onDragLeaveTag($event)" @drop="onAddTagToBookmark($event, tag)">
                                        <div class="pl-2 text-truncate">
                                            [[ tag.name ]]
                                        </div>
                                        <div v-if="tag.count" class="ml-auto pr-2">
                                            <span class="px-2 badge badge-pill badge-info">
                                                [[ tag.count ]]
                                            </span>
                                        </div>
                                    </li>
                                </transition-group>
                            </draggable>
                        </div>
                    </tag-list>
                </ul>

            </div>

        </div>

        <div id="vue-app-top" class="col-lg-9">

            <div class="ml-3">

                <div id="bookmark-search-form" class="d-flex flex-column mr-3 p-3">

                    <div class="d-flex">
                        <form class="form-inline" role="form" method="get" @submit.prevent>
                        {% csrf_token %}

                            <input id="add-to-remote-from-pinned-tagname" type="hidden" name="tag" />

                            <div class="form-group has-search">
                                <font-awesome-icon icon="search" class="ml-2 text-info"></font-awesome-icon>
                                <search inline-template @search-term="onTermSearch" @get-page="getPage" ref="search">
                                    <div class="position-relative">
                                        <simple-suggest
                                            id="bookmarkSearch"
                                            ref="simpleSuggest"
                                            place-holder="Search term or tag"
                                            search-url="{% url 'bookmark:get_tags_used_by_bookmarks' %}?query="
                                        >
                                        </simple-suggest>
                                    </div>
                                </search>
                            </div>

                        </form>

                        <div class="btn-group ml-3" role="group" aria-label="List View">
                            <button type="button" class="btn btn-primary" :class="{'active': $store.state.viewType === 'normal' }" @click="switchViewType('normal')">Normal</button>
                            <button type="button" class="btn btn-primary" :class="{'active': $store.state.viewType === 'compact' }" @click="switchViewType('compact')">Compact</button>
                        </div>

                        <div class="ml-3">
                            <add-button :href="'{% url 'bookmark:create' %}'">
                            </add-button>
                        </div>

                        <div class="dropdownmenu d-flex">
                            <dropdown-menu v-model="show" :right="right" transition="translate-fade-down" class="my-auto">
                                <font-awesome-icon icon="ellipsis-v"></font-awesome-icon>
                                <div slot="dropdown" v-cloak>
                                    <a v-if="$store.state.selectedTagName && $store.state.selectedTagName !== 'Untagged'" class="dropdown-item" href="#" @click.prevent="togglePinStatus">
                                        <font-awesome-icon icon="thumbtack" class="text-primary mr-3"></font-awesome-icon>
                                    [[ getPinnedMenuItem() ]]
                                    </a>
                                    <a class="dropdown-item" href=" url 'bookmark:import' %}">
                                        <font-awesome-icon icon="file-import" class="text-primary mr-3"></font-awesome-icon>Import
                                    </a>
                                </div>
                            </dropdown-menu>
                        </div>

                    </div>
                    <div v-cloak>
                        <div class="d-flex mt-1 ml-3">

                            <div v-if="$store.state.selectedTagName && $store.state.selectedTagName !== 'Untagged'" id="bookmark-search-filter" class="tag label label-info d-flex align-items-center">
                                <div>Tag: <span class="text-white">[[ $store.state.selectedTagName ]]</span></div>
                                <div>
                                    <a class="ml-1" href="#" @click.prevent="removeFilter">
                                        <font-awesome-icon icon="times" class="text-primary" />
                                    </a>
                                </div>
                            </div>

                            <div v-if="$store.state.searchTerm" id="bookmark-search-filter" class="tag label label-info d-flex align-items-center">
                                <div>Term: <span class="text-white">[[ $store.state.searchTerm ]]</span></div>
                                <div>
                                    <a class="ml-1" href="#" @click.prevent="removeFilter">
                                        <font-awesome-icon icon="times" class="text-primary" />
                                    </a>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

            </div>

            <div class="card-grid ml-2">

                <bookmark-list inline-template @paginate="paginate" @get-page="getPage" ref="bookmarkList">
                    <div class="row">
                        <div class="col-lg-12">
                            <table id="bookmark-list" class="w-100">
                                <tbody is="draggable" v-model="bookmarkList" @change="onSortBookmarks" ghost-class="sortable-ghost">
                                    <transition-group type="transition">
                                        <tr v-for="bookmark in bookmarkList" :data-uuid="bookmark.uuid" :key="bookmark.uuid" class="bookmark-list w-100" @mouseenter="onRowHovered" @mouseleave="onRowUnhovered" v-b-hover="handleYoutubeHover" v-cloak @dragstart="startDrag($event, bookmark)" @click="onClickBookmark(bookmark.uuid)">
                                            <td class="bookmark-list-date p-2 text-info align-top">
                                                <span>[[ bookmark.created ]]</span>
                                            </td>
                                            <td v-if="$store.state.viewType !== 'compact'" class="bookmark-list-favicon p-2">
                                                <img width="120" height="67" :src="bookmark.thumbnail_url + '?foo=bar'" />
                                            </td>
                                            <td class="bookmark-list-favicon p-2 align-top">
                                                <span v-html="bookmark.favicon_url"></span>
                                            </td>
                                            <td class="bookmark-list-link w-100 p-2 align-top position-relative">
                                                <a :href="bookmark.url" :id="bookmark.linkId" target="_blank">[[ unescapeHtml(bookmark.name) ]]</a>
                                                <a v-for="tag in bookmark.tags" v-if="tag != $store.state.selectedTagName" class="tag ml-2 d-inline-block" @click.prevent="onClickTag" href="#">[[ tag ]]</a>
                                                <div v-if="bookmark.note != null && bookmark.note != ''" class="table-note">
                                                    [[ bookmark.note ]]
                                                </div>
                                                <div class="yt-hover-target text-secondary position-absolute d-none" v-if="bookmark.url.startsWith('https://www.youtube.com/watch') && $store.state.viewType === 'normal'">
                                                    Duration: [[ bookmark.video_duration ]]
                                                </div>
                                            </td>
                                            <td class="p-2">
                                                <div class="dropdownmenu small mr-4">
                                                    <dropdown-menu v-model="show" :right="right" transition="translate-fade-down" class="d-none">
                                                        <font-awesome-icon icon="ellipsis-v"></font-awesome-icon>
                                                        <div slot="dropdown">
                                                            <a class="dropdown-item" href="#" @click.prevent="onClickUpdate(bookmark.uuid)">
                                                                <font-awesome-icon icon="pencil-alt" class="text-primary mr-3"></font-awesome-icon>Update
                                                            </a>
                                                            <a class="dropdown-item" href="#" @click.prevent="onClickDelete(bookmark.uuid)">
                                                                <font-awesome-icon icon="times" class="text-primary mr-3"></font-awesome-icon>Delete
                                                            </a>
                                                        </div>
                                                    </dropdown-menu>
                                                </div>
                                            </td>
                                        </tr>
                                    </transition-group>
                                </tbody>
                            </table>

                            <div v-if="bookmarkList.length === 0" v-cloak>
                                <div class="text-center pt-3">
                                    No bookmarks found.
                                </div>
                            </div>

                        </div>
                    </div>
                </bookmark-list>

                <div class="d-flex justify-content-center">

                    <pagination class="ml-3 mt-3" inline-template :pagination="pagination" @get-page="getPage" v-cloak>
                        <div class="row" v-if="pagination.num_pages > 1">
                            <nav aria-label="Page navigation">
                                <ul class="pagination">
                                    <li v-if="pagination.previous_page_number" class="page-item"><a class="page-link" @click.prevent="$emit('get-page', pagination.previous_page_number)" href="">Previous</a></li>
                                    <li v-else class="disabled page-item"><a class="page-link" href="">Previous</a></li>

                                    <template v-if="pagination.page_number - pagination.paginate_by > 1">
                                        <li class="page-item"><a class="page-link" @click.prevent="$emit('get-page', 1)" href="">1</a></li>
                                        <li v-if="pagination.page_number != pagination.paginate_by + 2" class="disabled page-item"><a class="page-link" href="">...</a></li>
                                    </template>

                                    <template v-for="page in pagination.range">

                                        <template v-if="pagination.page_number == page">
                                            <li class="disabled page-item">
                                                <a class="page-link" href="">[[ page ]]</a>
                                            </li>
                                        </template>
                                        <template v-else>
                                            <li class="page-item">
                                                <a class="page-link" @click.prevent="$emit('get-page', page)" href="">[[ page ]]</a>
                                            </li>
                                        </template>

                                    </template>

                                    <template v-if="pagination.num_pages - pagination.page_number > pagination.paginate_by">
                                        <li v-if="pagination.num_pages - pagination.page_number != pagination.paginate_by + 1"  class="disabled page-item"><a class="page-link" href="">...</a></li>
                                        <li class="page-item"><a class="page-link" @click.prevent="$emit('get-page', pagination.num_pages)" href="">[[ pagination.num_pages ]]</a></li>
                                    </template>

                                    <li v-if="pagination.next_page_number" class="page-item"><a class="page-link" @click.prevent="$emit('get-page', pagination.next_page_number)" href="">Next</a></li>
                                    <li v-else class="disabled page-item"><a class="page-link" href="">Next</a></li>
                                </ul>
                            </nav>
                        </div>
                    </pagination>

                </div>

            </div>

        </div>

    </div>

{% endblock %}

{% block javascript %}

    {{ block.super }}

    <script type="text/javascript">

        const store = new Vuex.Store({
            state: {
                selectedTagName: "Untagged",
                searchTerm: null,
                viewType: "{{ request.session.bookmark_view_type|default:'normal' }}",
                intervalId: null,
                pinnedTags: [
                    {
                        id: -1,
                        name: "Untagged",
                        isDraggable: false,
                        count: {{ untagged_count }},
                    },
                    {% for tag in pinned_tags %}
                    {
                        id: {{ tag.id }},
                        name: "{{ tag.name }}",
                        isDraggable: true,
                        count: {{ tag.bookmark_count }},
                    },
                    {% endfor %}
                ],
            },
            getters: {},
            mutations: {},
        });

        const Search = {
            methods: {
                onEnter(evt) {
                    // If we've hit 'Enter' and we're hovering over a tag suggestion,
                    //  we don't want to execute a term search, so bail.
                    if (this.$refs.simpleSuggest.$refs.suggestComponent.hovered) {
                        return;
                    }
                    searchTerm = evt.srcElement.value;

                    if (searchTerm) {
                        this.$refs.simpleSuggest.$refs.suggestComponent.setText("");
                        EventBus.$emit("search-term", searchTerm);
                    } else {
                        // If the search box is empty, refresh the list with no filters
                        EventBus.$emit("search-tag", "Untagged");
                    }

                },
                select(tag) {
                    this.$nextTick(() => {
                        this.$refs.simpleSuggest.$refs.suggestComponent.setText("");
                        this.$refs.simpleSuggest.$refs.suggestComponent.clearSuggestions();
                    });
                    EventBus.$emit("search-tag", tag.value);
                },
            },
            components: {
                SimpleSuggest
            }
        };

        const BookmarkList = {
            data() {
                return {
                    bookmarkList: [],
                    selectedBookmarkUuid: null,
                    show: false,
                    right: true,
                }
            },
            methods: {
                onClickTag(evt) {
                    const tagName = evt.srcElement.innerHTML;
                    EventBus.$emit("search-tag", tagName);
                },
                onClickBookmark(uuid) {
                    this.selectedBookmarkUuid = uuid;
                    this.selectBookmark();
                },
                onSortBookmarks(evt) {

                    // Ignore this event if we're not filtering
                    //  on a tag.
                    if (!this.$store.state.selectedTagName || this.$store.state.selectedTagName === "Untagged") {
                        return false;
                    }
                    bookmarkUuid = evt.moved.element.uuid;

                    // The backend expects the ordering to begin
                    // with 1, not 0, so add 1.
                    newPosition = evt.moved.newIndex + 1;

                    doPost(
                        this,
                        "{% url "bookmark:sort" %}",
                        {
                            "tag": this.$store.state.selectedTagName,
                            "bookmark_uuid": bookmarkUuid,
                            "position": newPosition
                        },
                        (response) => {},
                        "",
                        "Sort error"
                    );

                },
                unescapeHtml(html) {
                    // Source: https://stackoverflow.com/a/46851765/378256
                    var el = document.createElement('div');
                    return html.replace(/\&[#0-9a-z]+;/gi, function (enc) {
                        el.innerHTML = enc;
                        return el.innerText
                    });
                },
                getVideoDuration(data) {
                    if (data !== null) {
                        return data.video_duration;
                    }
                },
                handleYoutubeHover(hovered, evt) {
                    if (!evt.currentTarget.querySelector(".yt-hover-target")) {
                        return;
                    }
                    if (hovered) {
                        evt.currentTarget.querySelector(".yt-hover-target").classList.remove("d-none");
                    } else {
                        evt.currentTarget.querySelector(".yt-hover-target").classList.add("d-none");
                    }
                },
                getBookmarkList({ pageNumber=1, searchTerm=null, searchTag=null } = {}) {
                    var self = this;

                    if (searchTag !== null) {
                        url = "{% url 'bookmark:get_bookmarks_by_tag' 666 %}".replace(/666/, searchTag);
                        self.$store.state.searchTerm = null;
                    } else if (searchTerm !== null) {
                        url = "{% url 'bookmark:get_bookmarks_by_keyword' 666 %}".replace(/666/, searchTerm);
                    } else {
                        url = "{% url 'bookmark:get_bookmarks_by_page' 666 %}".replace(/666/, pageNumber);
                    }

                    axios.get(url)
                         .then(function (response) {

                             var bookmarks = []
                             var lastDate = null;
                             for (bookmark of response.data.bookmarks) {
                                 if (bookmark.created == lastDate) {
                                     lastDate = bookmark.created;
                                     bookmark.created = null;
                                 } else {
                                     lastDate = bookmark.created;
                                 }
                                 bookmarks.push(bookmark);
                             }

                             if (searchTag !== null) {
                                 // Only update the tagFilter here, *after* we have a new set of
                                 // updated bookmarks that's appropriate for this tagFilter
                                 self.$store.state.selectedTagName = searchTag;

                                 // Clear any timeouts to prevent the list from refreshing
                                 clearTimeout(self.$store.state.intervalId);
                             } else if (searchTerm !== null) {
                                 self.$store.state.selectedTagName = null;
                             } else {
                                 self.$store.state.selectedTagName = "Untagged";
                                 self.$store.state.intervalId = window.setTimeout(self.getBookmarkList, 60000, {pageNumber: 1});
                             }

                             self.$store.state.searchTerm = searchTerm;

                             self.bookmarkList = bookmarks;

                             self.$emit("paginate", response.data.pagination);

                         })
                         .catch(function (error) {
                             console.log("Error getting new bookmarks list: " + error);
                         })
                         .finally(function () {
                         });
                },
                onClickUpdate(uuid) {
                    window.location="{% url 'bookmark:update' '00000000-0000-0000-0000-000000000000' %}".replace(/00000000-0000-0000-0000-000000000000/, uuid);
                },
                onClickDelete(uuid) {

                    var self = this;

                    axios.delete("{% url 'bookmark-detail' '00000000-0000-0000-0000-000000000000' %}".replace('00000000-0000-0000-0000-000000000000', uuid))
                         .then(() => {

                             this.$bvToast.toast("Bookmark deleted", {
                                 title: "Info",
                                 variant: "primary"
                             })

                             EventBus.$emit("get-page");

                         })
                },
                onRowHovered(evt) {
                    evt.currentTarget.querySelector(".dropdown").classList.remove("d-none");
                },
                onRowUnhovered(evt) {
                    evt.currentTarget.querySelector(".dropdown").classList.add("d-none");
                },
                getNextBookmark() {
                    const index = this.bookmarkList.findIndex( (e) => e.uuid === this.selectedBookmarkUuid );
                    if (index < this.bookmarkList.length - 1) {
                        return this.bookmarkList[index + 1].uuid;
                    }
                },
                getPreviousBookmark() {
                    const index = this.bookmarkList.findIndex( (e) => e.uuid === this.selectedBookmarkUuid );
                    if (index > 0) {
                        return this.bookmarkList[index - 1].uuid;
                    }
                },
                selectBookmark() {
                    document.querySelectorAll("#bookmark-list tr").forEach(row => {
                        row.classList.remove("selected");
                    });

                    document.querySelector("#bookmark-list tr[data-uuid='" + this.selectedBookmarkUuid + "']").classList.add("selected");
                },
                startDrag(evt, bookmark) {
                    evt.dataTransfer.dropEffect = "move";
                    evt.dataTransfer.effectAllowed = "move";
                    evt.dataTransfer.setData("application/x-moz-node", bookmark.uuid);
                }
            },
            mounted() {

                let self = this;

                window.addEventListener("keydown", function(e) {

                    // If the active element isn't the body, it's probably an input,
                    //   in which case we don't want this event handler to take control.
                    if (document.activeElement.tagName !== "BODY") {
                        return;
                    }

                    if (e.which === 40 && e.altKey) { /* Alt-Down arrow */

                        if (!self.selectedBookmarkUuid) {
                            self.selectedBookmarkUuid = self.bookmarkList[0].uuid;
                        } else {
                            self.selectedBookmarkUuid = self.getNextBookmark();
                        }
                        self.selectBookmark();

                    } else if (e.which === 38 && e.altKey) { /* Alt-Up arrow */

                        if (!self.selectedBookmarkUuid) {
                            self.selectedBookmarkUuid = self.bookmarkList[self.bokmarkList.length - 1].uuid;
                        } else {
                            self.selectedBookmarkUuid = self.getPreviousBookmark();
                        }
                        self.selectBookmark();

                    } else if (e.which === 68) { /* D */

                        const index = self.bookmarkList.findIndex( (e) => e.uuid === self.selectedBookmarkUuid );
                        const nextBookmark = self.getNextBookmark();
                        self.onClickDelete(self.bookmarkList[index].uuid);
                        self.selectedBookmarkUuid = nextBookmark;
                        self.selectBookmark();

                    } else if (e.which === 79) { /* O */

                        const index = self.bookmarkList.findIndex( (e) => e.uuid === self.selectedBookmarkUuid );
                        window.open(self.bookmarkList[index].url, "_blank");
                        self.onClickDelete(self.bookmarkList[index].uuid);
                        self.selectedBookmarkUuid = null;

                    } else if (e.which === 27) { /* Escape */

                        self.selectedBookmarkUuid = null;
                        document.querySelectorAll("#bookmark-list tr").forEach(row => {
                            row.classList.remove("selected");
                        });

                    }

                });

                {% if tag %}
                this.getBookmarkList({searchTag: "{{ tag }}"});
                {% else %}
                this.getBookmarkList({pageNumber: 1});
                {% endif %}

            }
        };

        const Pagination = {
            props: {
                pagination: ""
            }
        }

        new Vue({
            el: "#vue-app-top",
            name: "BookmarkContainer",
            store,
            components: {
                BookmarkList,
                Pagination,
                Search,
            },
            data() {
                return {
                    pagination: "",
                    pageNumber: 1,
                    show: false,
                    right: true,
                }
            },
            methods: {
                getPage(pageNumber) {
                    this.pageNumber = pageNumber;
                    this.$refs.bookmarkList.getBookmarkList({pageNumber: pageNumber});
                },
                getPage(pageNumber) {
                    EventBus.$emit("get-page", pageNumber);
                },
                getPinnedMenuItem() {
                    return !this.filteredTagIsPinned() ? "Pin" : "Unpin";
                },
                onTermSearch(searchTerm) {
                    this.$refs.bookmarkList.getBookmarkList({searchTerm: searchTerm});
                },
                paginate(payload) {
                    this.pagination = payload;
                },
                removeFilter() {
                    this.$store.state.searchTerm = null;
                    EventBus.$emit("search-tag", "Untagged");
                },
                switchViewType(type) {
                    this.$store.state.viewType = type;
                    doPost(
                        this,
                        "{% url "accounts:store_in_session" %}",
                        {
                            "bookmark_view_type": type
                        },
                        (response) => {},
                        "",
                        ""
                    );
                },
                filteredTagIsPinned() {
                    return this.$store.state.pinnedTags.find(element => element.name == this.$store.state.selectedTagName);
                },
                togglePinStatus() {
                    let formAction = null;
                    if (this.getPinnedMenuItem() === "Pin") {
                        document.getElementById("add-to-remote-from-pinned-tagname").value = this.$refs.search.$refs.simpleSuggest.$refs.suggestComponent.text;
                        formAction = "{% url 'tag:pin' %}";
                    } else {
                        document.getElementById("add-to-remote-from-pinned-tagname").value = this.$store.state.selectedTagName;
                        formAction = "{% url 'tag:unpin' %}";
                    }
                    const form = document.querySelector("#bookmark-search-form form");
                    form.method = "post";
                    form.action = formAction;
                    form.submit();
                },
            },
            mounted() {

                EventBus.$on("search-tag", tagName => {
                    if (tagName == "Untagged") {
                        this.$refs.bookmarkList.getBookmarkList({pageNumber: 1});
                    } else {
                        this.$refs.bookmarkList.getBookmarkList({searchTag: tagName});
                    }
                });

                EventBus.$on("search-term", searchTerm => {
                    this.$refs.bookmarkList.getBookmarkList({searchTerm: searchTerm});
                });

                EventBus.$on("get-page", pageNumber => {
                    this.$refs.bookmarkList.getBookmarkList({pageNumber: pageNumber});
                });

            }
        });

        const TagList = {
            store,
            methods: {
                onClickTag(evt) {
                    const tagName = evt.currentTarget.dataset.tag;
                    EventBus.$emit("search-tag", tagName);
                },
                onDragOverTag(evt) {
                    evt.currentTarget.classList.add("hover-tag");
                },
                onDragLeaveTag(evt) {
                    evt.currentTarget.classList.remove("hover-tag");
                },
                onAddTagToBookmark(evt, tag) {
                    evt.currentTarget.classList.remove("hover-tag");

                    // Ignore if we're dragging a bookmark from a tag list
                    //  onto the same tag.
                    if (tag.name === this.$store.state.selectedTagName) {
                        return;
                    }

                    const bookmarkUuid = evt.dataTransfer.getData("application/x-moz-node");

                    // Ignore if we're sorting the tag list instead of
                    //  dragging a bookmark onto a tag (both events
                    //  will trigger this handler). That will be taken
                    //  care of in another handler.
                    if (!bookmarkUuid) {
                        return;
                    }

                    doPost(
                        this,
                        "{% url "bookmark:add_tag" %}",
                        {
                            "tag_id": tag.id,
                            "bookmark_uuid": bookmarkUuid,
                        },
                        (response) => {
                            EventBus.$emit("get-page", 1);
                        },
                        "",
                        "Error adding tag"
                    );
                },
                onSortTags(evt) {
                    if (evt.added) {
                        console.log("Add tag to bookmark uuid = " + evt.added.element.uuid);
                        return;
                    }
                    tagId = evt.moved.element.id;

                    doPost(
                        this,
                        "{% url "bookmark:sort_pinned_tags" %}",
                        {
                            "tag_id": tagId,
                            "new_position": evt.moved.newIndex
                        },
                        () => {},
                        "",
                        "Error sorting tags"
                    );

                }
            },
        };

        new Vue({
            el: "#vue-pinned-tags",
            name: "Pinned Tags",
            store,
            components: {
                TagList
            },
        });

    </script>

{% endblock %}

{% block help %}

    <div class="d-none" id="help-text">
# Keyboard Shortcuts
- **Alt-Up**, **Alt-Down** *-* Select a bookmark
- **D** *-* Delete the selected bookmark
- **O** *-*  Open and delete the selected bookmark
- **Escape** *-* Unselect the selected bookmark
    </div>

{% endblock %}
