{% extends "base.html" %}

{% load dict_get %}
{% load jsonify %}

{% load favicon %}

{% block title %} Bookmarks {% endblock %}

{% block left-block %}

    <div id="vue-app-left">

        <add-note inline-template>
            <div id="bookmark-sidebar" >
                <form>
                    <div class="form-group">
                        <label class="col-form-label">Note</label>
                        <textarea class="form-control" id="note" rows="9" v-model="note"></textarea>
                    </div>
                    <button id="btn-add-note" type="button" class="btn btn-primary" @click="onClick">Add</button>
                </form>
            </div>
        </add-note>

        <h2>Favorite Tags</h2>

        <ul class="list-group" id="sort-container-tags">
            <tag-list inline-template>
                <div>
                    <draggable v-model="favoriteTags" @change="onChange" ghost-class="sortable-ghost" filter="#untagged">
                        <transition-group type="transition">
                            <li v-for="tag in favoriteTags" :class="'list-group-item ' + tag.className" :data-id="tag.id" :key="tag.id">
                                <a href="" @click.prevent="onClick" :data-tag="tag.name">[[ tag.name ]]</a>
                                <span :class="'ml-2 badge ' + tag.badgeClassName">[[ tag.count ]]</span>
                            </li>
                        </transition-group>
                    </draggable>
                </div>
            </tag-list>
        </ul>

    {% if tag_filter %}
        {% if tag_filter not in tag_counts %}
            <form action="{% url 'add_favorite_tag' %}" method="post">
                {% csrf_token %}
                <input type="hidden" name="tag" value="{{ tag_filter }}" />
                <button type="submit" class="btn btn-secondary">
            Add To Favorites
                </button>
            </form>
        {% else %}
            <form action="{% url 'remove_favorite_tag' %}" method="post">
                {% csrf_token %}
                <input type="hidden" name="tag" value="{{ tag_filter }}" />
                <button type="submit" class="btn btn-secondary">
            Remove From Favorites
                </button>
            </form>
        {% endif %}
    {% endif %}

    <randomize-button inline-template>
        <form role="form" action="" method="get">
            <div class="btn-group mt-5">
                <button class="btn btn-secondary" @click.prevent="onClick" id="btn-random">Randomize</button>
            </div>

            <br />

            <div class="btn-group mt-5">
                <a class="btn btn-secondary" href="{% url 'bookmark_import' %}">Import</a>
            </div>
        </form>
    </randomize-button>

    </div>

    <br />


{% endblock %}

{% block content %}

    <div id="vue-app-right">

        {% include "common/show_messages.html" %}

        <div class="row">

            <div class="col-lg-12 bookmark-search">

                <form class="form-inline" role="form" name="nav_form" id="search" method="get" @submit.prevent>

                    <div class="form-group col-auto has-search">
                        <span class="fas fa-search form-control-feedback"></span>
                        <search @search-term="searchTerm" @search-tag="searchTag" @get-page="getPage"></search>
                    </div>

                    <button-group @get-page="getPage"></button-group>

                </form>

            </div>

        </div>

        <br />

        <bookmark-list inline-template @paginate="paginate" ref="bookmarkList">
            <div class="row">
                <div class="col-lg-12">
                    <table>
                        <tbody is="draggable" v-model="bookmarkList" @change="onChange" ghost-class="sortable-ghost" :disabled="disableSort">
                            <transition-group type="transition">
                                <tr v-for="bookmark in bookmarkList" :data-id="bookmark.id" :key="bookmark.id" class="bookmark-list" @click="onClick" v-cloak>
                                    <td class="bookmark-list-date p-2">
                                        <span>[[ bookmark.created ]]</span>
                                    </td>
                                    <td class="bookmark-list-favicon p-2">
                                        <span v-html="bookmark.favicon_url"></span>
                                    </td>
                                    <td class="bookmark-list-link p-2">
                                        <a class="one-tag" :href="bookmark.url" :id="bookmark.linkId" target="_blank">[[ unescapeHtml(bookmark.title) ]]</a>
                                        <a v-if="bookmark.lastResponseCode != 200" class="form-error ml-3" target="wayback" :href="'https://web.archive.org/web/1000/' + bookmark.url">[[ bookmark.lastResponseCode ]]</a>
                                        <i v-if="bookmark.note != null && bookmark.note != ''" class="fa fa-clipboard"></i>
                                        <a v-for="tag in bookmark.tags" v-if="tag != $tagFilter" class="badge badge-info ml-2" @click.prevent="onClick" href="">[[ tag ]]</a>
                                    </td>
                                </tr>
                            </transition-group>
                        </tbody>
                    </table>
                </div>
            </div>
        </bookmark-list>

        <pagination inline-template :pagination="pagination" @get-page="getPage">
            <div class="row" v-if="pagination.num_pages > 1">
                <nav aria-label="Page navigation">
                    <ul class="pagination">
                        <li v-if="pagination.previous_page_number" class="page-item"><a class="page-link" @click.prevent="$emit('get-page', pagination.previous_page_number)" href="">Previous</a></li>
                        <li v-else class="disabled page-item"><a class="page-link" href="">Previous</a></li>

                        <template v-if="pagination.page_number - pagination.paginate_by > 1">
                            <li class="page-item"><a class="page-link" @click.prevent="$emit('get-page', 1)" href="">1</a></li>
                            <li v-if="pagination.page_number != pagination.paginate_by + 2" class="disabled page-item"><a class="page-link" href="">...</a></li>
                        </template>

                        <template v-for="page in pagination.range">

                            <template v-if="pagination.page_number == page">
                                <li class="disabled page-item">
                                    <a class="page-link" href="">[[ page ]]</a>
                                </li>
                            </template>
                            <template v-else>
                                <li class="page-item">
                                    <a class="page-link" @click.prevent="$emit('get-page', page)" href="">[[ page ]]</a>
                                </li>
                            </template>

                        </template>

                        <template v-if="pagination.num_pages - pagination.page_number > pagination.paginate_by">
                            <li v-if="pagination.num_pages - pagination.page_number != pagination.paginate_by + 1"  class="disabled page-item"><a class="page-link" href="">...</a></li>
                            <li class="page-item"><a class="page-link" @click.prevent="$emit('get-page', pagination.num_pages)" href="">[[ pagination.num_pages ]]</a></li>
                        </template>

                        <li v-if="pagination.next_page_number" class="page-item"><a class="page-link" @click.prevent="$emit('get-page', pagination.next_page_number)" href="">Next</a></li>
                        <li v-else class="disabled page-item"><a class="page-link" href="">Next</a></li>
                    </ul>
                </nav>
            </div>
        </pagination>

    </div>

{% endblock %}

{% block javascript %}

    {{ block.super }}

    <script src="//cdn.jsdelivr.net/npm/sortablejs@1.8.4/Sortable.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/Vue.Draggable/2.20.0/vuedraggable.umd.min.js"></script>

    <script type="text/javascript" src="https://unpkg.com/vue-simple-suggest@1.10.1"></script>

    <script type="text/javascript">

        Vue.prototype.$tagFilter = null;
        var isFiltered = false;

        // When this is set to true, then hitting "Enter" will NOT
        //  execute a general term search, but instead fire the event
        //  that initiates a tag search.
        disableTermSearch = false;

        Vue.mixin({ delimiters: ["[[", "]]"] });

        const EventBus = new Vue();

        const BookmarkList = {
            data() {
                return {
                    bookmarkList: [],
                    disableSort: true,
                }
            },
            methods: {
                onClick(evt) {

                    element = evt.currentTarget;

                    if (evt.srcElement.classList.contains("badge")) {
                        const tagName = evt.srcElement.innerHTML;
                        EventBus.$emit("search-tag", tagName);
                    } else if (element.classList.contains("selected")) {

                        if (this.$tagFilter) {
                            document.getElementById("bookmark-sidebar").classList.remove("show");
                        }

                        element.classList.remove("selected");

                        EventBus.$emit("toggleDisabledEdit", "disable")
                        EventBus.$emit("toggleDisabledDelete", "disable");

                    } else {

                        if (this.$tagFilter) {
                            noteValue = "";

                            var selectedId = parseInt(element.dataset.id, 10);

                            const found = this.bookmarkList.find(element => element.id == selectedId);

                            if (found) {
                                noteValue = atob(found.note);
                            }

                            EventBus.$emit("setNoteValue", noteValue);

                            document.getElementById("bookmark-sidebar").classList.add("show");
                        }

                        const currentlySelected = document.querySelector("tr.bookmark-list.selected");
                        if (currentlySelected) {
                            currentlySelected.classList.remove("selected");
                        }
                        element.classList.add("selected");

                        EventBus.$emit("toggleDisabledEdit", "enable");
                        EventBus.$emit("toggleDisabledDelete", "enable");

                    }

                },
                onChange(evt) {

                    linkId = evt.moved.element.id;

                    // The backend expects the ordering to begin
                    // with 1, not 0, so add 1.
                    newPosition = evt.moved.newIndex + 1;

                    const data = new URLSearchParams();
                    data.append("tag", this.$tagFilter);
                    data.append("link_id", linkId);
                    data.append("position", newPosition);

                    fetch("{% url "sort_bookmarks" %}", {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}"
                        },
                        body: data,
                    }).then(response => response.json())
                      .then(data => {
                          console.log("Success:", data);
                      })
                      .catch((error) => {
                          console.error("Error:", error);
                          $.smkAlert({text: "Error reordering notes: " + error, type: "error", position:"top-right"});
                      });
                },
                unescapeHtml(html) {
                    // Source: https://stackoverflow.com/a/46851765/378256
                    var el = document.createElement('div');
                    return html.replace(/\&[#0-9a-z]+;/gi, function (enc) {
                        el.innerHTML = enc;
                        return el.innerText
                    });
                },
                getBookmarkList({ pageNumber=null, searchTerm=null, searchTag=null, randomize=false } = {}) {
                    var self = this;

                    this.disableSort = true;
                    if (searchTerm != null) {
                        url = "{% url 'get_bookmarks_by_keyword' 666 %}".replace(/666$/, searchTerm);
                        isFiltered = true;
                    } else if (searchTag != null) {
                        url = "{% url 'get_bookmarks_by_tag' 666 %}".replace(/666$/, searchTag);
                        isFiltered = true;
                        this.disableSort = false;
                        this.$tagFilter = searchTag;
                    } else if (randomize == true) {
                        isFiltered = true;
                        url = "{% url 'get_bookmarks_by_random' %}";
                    } else {

                        // If we've executed a search, ignore the automatic timed bookmarks refresh
                        if (isFiltered) {
                            return;
                        }

                        url = "{% url 'get_bookmarks_by_page' 666 %}".replace(/666$/, pageNumber);
                    }

                    axios.get(url)
                         .then(function (response) {

                             var bookmarks = []
                             var lastDate = null;
                             for (bookmark of response.data.bookmarks) {
                                 if (bookmark.created == lastDate) {
                                     lastDate = bookmark.created;
                                     bookmark.created = null;
                                 } else {
                                     lastDate = bookmark.created;
                                 }
                                 bookmarks.push(bookmark);
                             }
                             self.bookmarkList = bookmarks;

                             self.$emit("paginate", response.data.pagination);

                         })
                         .catch(function (error) {
                             console.log("Error getting new bookmarks list: " + error);
                         })
                         .finally(function () {
                         });
                },
            },
            mounted() {

                EventBus.$on("foobar", payload => {

                    this.bookmarkList.forEach( bookmark => {
                        if( bookmark.id == payload.id ) {
                            bookmark.note = btoa(payload.noteValue);
                        }
                    });

                });

                this.getBookmarkList({pageNumber: 1});

                window.setInterval(this.getBookmarkList, 60000, {pageNumber: 1});

            }
        };

        const Pagination = {
            props: {
                pagination: ""
            }
        }

        const AddNote = {
            data() {
                return {
                    note: ""
                }
            },
            methods: {
                onClick(evt) {

                    const note = document.getElementById("note").value;
                    var selectedId = document.querySelector("tr.bookmark-list.selected").dataset.id;

                    const data = new URLSearchParams();
                    data.append("tag", "{{ tag_filter }}");
                    data.append("link_id", selectedId);
                    data.append("note", note);

                    fetch("{% url 'bookmark_add_note' %}",
                          {
                              method: "POST",
                              headers: {
                                  "X-CSRFToken": "{{ csrf_token }}"
                              },
                              body: data
                          }
                    ).then(response => {
                        return response;
                    }).then(() => {

                        payload = {
                            id: selectedId,
                            noteValue: note
                        }
                        EventBus.$emit("foobar", payload);

                    })

                }
            },
            mounted() {

                EventBus.$on("setNoteValue", payload => {
                    this.note = payload;
                });

            }
        }

        const Search = {
            template: `
                <div>
                    <vue-simple-suggest ref="suggestComponent"
                        v-model="query"
                        display-attribute="value"
                        value-attribute="value"
                        :list="tagSearch"
                        :filter-by-query=true
                        :debounce=200
                        :name="inputName"
                        placeholder="Search"
                        autofocus
                        autocomplete="off"
                        id="searchInput"
                        @select="onSelect"
                        @keydown.native.enter="onEnter"
                        :styles="autoCompleteStyle"
                        @hide-list="onHideList"
                        @hover="onHover"
                        >
                    </vue-simple-suggest>
                </div>
            `,
            data() {
                return {
                    inputName: "search",
                    query: "",
                    tags: [],
                    autoCompleteStyle: {
                        vueSimpleSuggest: "position-relative",
                        inputWrapper: "search-box",
                        defaultInput: "form-control",
                        suggestions: "position-absolute list-group z-1000",
                        suggestItem: "list-group-item"
                    }
                }
            },
            methods: {
                tagSearch(query) {
                    return fetch("{% url 'get_tags_used_by_bookmarks' %}?query=" + query)
                        .then(response => {
                            return response.json();
                        })
                        .then(data => data)
                },
                onSelect(tag) {
                    this.$emit("search-tag", tag.value);
                    disableTermSearch = false;
                },
                onHideList() {
                    disableTermSearch = false;
                },
                onHover() {
                    disableTermSearch = true;
                },
                onEnter(evt) {

                    if (disableTermSearch) {
                        return;
                    }
                    searchTerm = evt.srcElement.value;

                    if (searchTerm) {
                        this.$emit("search-term", searchTerm);
                    } else {
                        // If the search box is empty, refresh the list with no filters
                        isFiltered = false;
                        this.$emit("get-page", 1);
                    }

                }
            }
        };

        const ButtonGroup = {
            template: `
                <div class="btn-group">
                    <a class="btn btn-secondary" id="btn-add" href="{% url 'bookmark_add' %}">Add</a>
                    <input type="button" class="btn btn-secondary" id="btn-edit" value="Edit" :disabled="isDisabledEdit" @click="onClickEdit" />
                    <input type="button" class="btn btn-secondary" id="btn-delete" value="Delete" :disabled="isDisabledDelete" @click="onClickDelete" />
                </div>
            `,
            methods: {
                onClickDelete(evt) {

                    var bookmarkEl = document.querySelector("tr.bookmark-list.selected");
                    var selectedId = bookmarkEl.dataset.id;

                    var self = this;

                    fetch("{% url 'bookmark_delete' 666 %}".replace(/666$/, selectedId),
                          {
                              method: "DELETE",
                              headers: {
                                  "X-CSRFToken": "{{ csrf_token }}"
                              }
                          }
                    ).then(response => {
                        return response;
                    }).then(() => {

                        this.isDisabledEdit = true;
                        this.isDisabledDelete = true;

                        {% if tag_filter %}
                        document.getElementById("bookmark-sidebar").classList.remove("show");
                        {% endif %}

                        self.$emit("get-page", 1);

                    })
                },
                onClickEdit(evt) {

                    var selectedId = document.querySelector("tr.bookmark-list.selected").dataset.id;
                    window.location="{% url 'bookmark_edit' 666 %}".replace(/666$/, selectedId);

                },
            },
            data() {
                return {
                    isDisabledEdit: true,
                    isDisabledDelete: true
                }
            },
            mounted() {

                EventBus.$on("toggleDisabledEdit", payload => {
                    if (payload == "disable") {
                        this.isDisabledEdit = true;
                    } else if (payload == "enable") {
                        this.isDisabledEdit = false;
                    }
                });

                EventBus.$on("toggleDisabledDelete", payload => {
                    if (payload == "disable") {
                        this.isDisabledDelete = true;
                    } else if (payload == "enable") {
                        this.isDisabledDelete = false;
                    }
                });

            }
        };

        new Vue({
            el: "#vue-app-right",
            components: {
                BookmarkList,
                ButtonGroup,
                Pagination,
                Search
            },
            data() {
                return {
                    pagination: ""
                }
            },
            methods: {
                paginate(payload) {
                    this.pagination = payload;
                },
                getPage(pageNumber) {
                    this.$refs.bookmarkList.getBookmarkList({pageNumber: pageNumber});
                },
                searchTerm(searchTerm) {
                    this.$refs.bookmarkList.getBookmarkList({searchTerm: searchTerm});
                },
                searchTag(searchTag) {
                    this.$refs.bookmarkList.getBookmarkList({searchTag: searchTag});
                }
            },
            mounted() {

                EventBus.$on("search-tag", tagName => {
                    this.$refs.bookmarkList.getBookmarkList({searchTag: tagName});
                });

                EventBus.$on("get-page", pageNumber => {
                    this.$refs.bookmarkList.getBookmarkList({pageNumber: pageNumber});
                });

                EventBus.$on("randomize", () => {
                    this.$refs.bookmarkList.getBookmarkList({randomize: true});
                });

            }
        });

        const TagList = {
            data() {
                return {
                    favoriteTags: [
                        {
                            id: -1,
                            name: "Untagged",
                            className: "active",
                            count: {{ tag_counts|dict_get:"Untagged" }},
                            badgeClassName: "badge-light"
                        },
                        {% for tag in favorite_tags %}
                        {
                            id: {{ tag.id }},
                            name: "{{ tag.name }}",
                            className: "{% if tag.name == tag_filter %}active{% else %}{% endif %}",
                            count: {{ tag_counts|dict_get:tag.name }},
                            badgeClassName: "{% if tag.name == tag_filter %}badge-light{% else %}badge-primary{% endif %}",
                        },
                        {% endfor %}
                    ],
                    selectedTag: null
                }
            },
            methods: {
                onClick(evt) {
                    const tagName = evt.srcElement.dataset.tag;
                    this.selectedTag = tagName;

                    for (tag of this.favoriteTags) {
                        if (tag.name == tagName) {
                            tag.className = "list-group-item active";
                            tag.badgeClassName = "badge-light";
                        } else {
                            tag.className = "list-group-item";
                            tag.badgeClassName = "badge-primary";
                        }
                    }

                    if (tagName == "Untagged") {
                        isFiltered = false;
                        EventBus.$emit("get-page", 1);
                    } else {
                        EventBus.$emit("search-tag", tagName);
                    }
                },
                getClassName(tagName) {

                    if (tagName == this.selectedTag) {
                        return "badge-light";
                    } else {
                        return "badge-primary";
                    }
                },
                onChange(evt) {

                    tagId = evt.moved.element.id;

                    // The backend expects the ordering to begin
                    // with 1, not 0, so add 1.
                    newPosition = evt.moved.newIndex + 1;

                    const data = new URLSearchParams();
                    data.append("tag_id", tagId);
                    data.append("new_position", newPosition);

                    fetch("{% url "sort_favorite_tags" %}", {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}"
                        },
                        body: data,
                    }).then(response => response.json())
                      .then(data => {
                          console.log("Success:", data);
                      })
                      .catch((error) => {
                          console.error("Error:", error);
                          $.smkAlert({text: "Error reordering notes: " + error, type: "error", position:"top-right"});
                      });
                }
            },
        };

        const RandomizeButton = {
            methods: {
                onClick(evt) {
                    EventBus.$emit("randomize");
                }
            }
        }

        new Vue({
            el: "#vue-app-left",
            components: {
                AddNote,
                TagList,
                RandomizeButton
            }
        });

    </script>

{% endblock %}
