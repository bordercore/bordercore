{% extends "base.html" %}

{% block title %} Todo {% endblock %}

{% block content %}

    <div class="row no-gutters h-100" id="vue-app">

        <div class="col-lg-3 d-flex flex-column">

            <div class="card-body">

                <h3>
                    Tag Filter
                </h3>

                {% for tag in tags %}
                    <div class="tag-list p-2 d-flex" :class="getTagClass('{{ tag.name }}')" @click.prevent="onClickTag" data-tag="{{ tag.name }}">
                        <div>{{ tag.name }}</div>
                        <div class="ml-auto"><span class="px-2 badge badge-pill {% ifequal tagsearch tag.name %}badge-dark{% else %}badge-primary{% endifequal %}">{{ tag.count }}</span></div>
                    </div>
                {% endfor %}

            </div>

        </div>

        <div class="col-lg-9">

            <div class="card-grid ml-2">

                <div class="d-flex justify-content-between">

                    <form class="form-inline" role="form">

                        <select class="form-control ml-2" id="filter-priority" v-model="filterPriority" @change="onChange($event)">
                            <option v-for="option in filterPriorityOptions" :value="option[0]">
                                [[ option[1] ]]
                            </option>
                        </select>

                        <select class="form-control ml-2" id="filter-time" v-model="filterTime" @change="onChange($event)">
                            <option v-for="option in filterTimeOptions" :value="option[0]">
                                [[ option[1] ]]
                            </option>
                        </select>

                        <div class="form-group ml-2">
                            <input v-model="filter" id="todo_search" type="text" class="form-control" placeholder="Name Filter">
                        </div>

                    </form>

                    <div class="float-right mr-2">
                        <button class="button-add">
                            <a id="btn-create" :href=createTodoUrl>
                                <font-awesome-icon icon="plus" class="form-control-feedback text-dark"></font-awesome-icon>
                            </a>
                        </button>
                    </div>

                </div>

                <b-table
                    :hover="hover"
                    primary-key="uuid"
                    :items="items"
                    :fields="fields"
                    :sort-compare="sortCompare"
                    @sort-changed="sortChanged"
                    @row-hovered="rowHovered"
                    @row-unhovered="rowUnHovered"
                    onEnd="onEnd"
                    :filter="filter"
                    v-sortable
                    :sorting="items"
                    sort-by="manualSorting"
                    show-empty
                    empty-text="No tasks found"
                >

                    <template #cell(task)="data">
                        <span v-html="data.value"></span>
                        <span v-if="data.item.url"><a class="ml-1" :href="data.item.url"><font-awesome-icon icon="link"></font-awesome-icon></a></span>
                        <div class="table-note" v-html="data.item.note"></div>
                    </template>

                    <template #cell(manualSorting)="data">
                        <font-awesome-icon icon="bars"></font-awesome-icon>
                        <span v-html="data.value"></span>
                    </template>

                    <template #cell(uuid)="data">
                        <div class="hover-target hidden">
                            <dropdown-menu v-model="show" :right="right" transition="translate-fade-down" class="text-center">
                                <font-awesome-icon icon="ellipsis-v" class="burger-menu"></font-awesome-icon>
                                <div slot="dropdown">
                                    <a class="dropdown-item" href="#" @click="onClickUpdate(data.value)">Update</a>
                                    <a class="dropdown-item" href="#" @click="onClickDelete(data.value)">Delete</a>
                                </div>
                            </dropdown-menu>
                        </div>
                    </template>

                </b-table>

            </div>

        </div>

    </div>

{% endblock %}

{% block javascript %}

    {{ block.super }}

    <script type="text/javascript" charset="utf-8">

        Vue.mixin({ delimiters: ["[[", "]]"] });

        const EventBus = new Vue();

        let sortable = null;

        Vue.directive("sortable", {
            update(el, binding, vnode) {

                const sort_items = vnode.data.attrs.sorting;
                let options = {
                    handle: ".drag-handle"
                };

                if (sort_items) {

                    options.onStart = function sortableStart(evt) {
                        // Disable the table's hover feature will we're dragging and dropping
                        table.hover = false;
                    }

                    options.onUpdate = function sortableUpdate(evt) {
                        const deleted = sort_items.splice(evt.oldIndex, 1);
                        sort_items.splice(evt.newIndex, 0, deleted[0]);
                    };

                    options.onEnd = function sortableEnd(evt) {
                        table.hover = true;
                        if (evt.newIndex !== evt.oldIndex) {

                            const bodyFormData = new URLSearchParams();
                            bodyFormData.append("tag", "{{ tagsearch }}");
                            bodyFormData.append("todo_uuid", evt.item.dataset.pk);
                            bodyFormData.append("position", evt.newIndex + 1);

                            axios("{% url 'todo:sort' %}", {
                                method: "POST",
                                data: bodyFormData,
                            })
                                .then((response) => {
                                    console.log("Success");
                                }, (error) => {
                                    console.log(error);
                                });

                        }
                    }
                }

                sortable = Sortable.create(document.querySelector("tbody"), options);
            }
        });

        const table = new Vue({
            el: "#vue-app",
            data() {
                return {
                    selectedTag: "{{ tagsearch }}",
                    filterPriority: "{{ filter.todo_filter_priority|default:'' }}",
                    filterTime: "{{ filter.todo_filter_time|default:'' }}",
                    items: [],
                    fields: [
                        {
                            key: "manualSorting",
                            label: "Manual",
                            class: "drag-handle text-center cursor-grab",
                            sortable: false,
                            thClass: "todo-col-manual-sorting",
                        },
                        {
                            key: "task",
                            sortable: true,
                        },
                        {
                            key: "priority",
                            sortable: true,
                            thClass: "todo-col-priority"
                        },
                        {
                            key: "created",
                            label: "Date",
                            class: "text-nowrap",
                            sortable: true,
                            thClass: "todo-col-date"
                        },
                        {
                            key: "uuid",
                            label: "",
                            tdClass: "text-center align-middle",
                            thClass: "col-action"
                        }
                    ],
                    filterPriorityOptions: [
                        ["", "Priority"],
                        ["1", "High"],
                        ["2", "Medium"],
                        ["3", "Low"]
                    ],
                    filterTimeOptions: [
                        ["", "Created"],
                        ["1", "Last Day"],
                        ["3", "Last 3 Days"],
                        ["7", "Last Week"],
                        ["30", "Last Month"],
                    ],
                    filter: null,
                    show: false,
                    right: true,
                    hover: true
                }
            },
            methods: {
                getTodoList() {
                    const filterPriority = document.getElementById("filter-priority").value;
                    const filterTime = document.getElementById("filter-time").value;
                    doGet(
                        this,
                        "{% url "todo:list_tasks" 666 %}".replace(/666/, this.selectedTag) +
                        `?priority=${filterPriority}` +
                        `&time=${filterTime}`,
                        (response) => {
                            this.items = response.data.todo_list;
                        },
                        "Error todo list"
                    );
                },
                sortCompare(aRow, bRow, key) {

                    let a = b = null;

                    if (key === "created") {
                        a = aRow["unixtime"];
                        b = bRow["unixtime"];
                    } else if (key === "manualSorting") {
                        a = aRow["sort_order"];
                        b = bRow["sort_order"];
                    } else {
                        a = aRow[key];
                        b = bRow[key];
                    }

                    return a < b ? -1 : a > b ? 1 : 0;

                },
                sortChanged(evt) {
                    if (evt.sortBy === "") {
                        sortable.option("disabled", false);
                        this.fields[0].class="drag-handle text-center cursor-grab";
                    } else {
                        sortable.option("disabled", true);
                        this.fields[0].class="drag-handle text-center";
                    }
                },
                rowHovered(item, index, evt) {
                    evt.currentTarget.querySelector(".hover-target").classList.remove("hidden");
                },
                rowUnHovered(item, index, evt) {
                    evt.currentTarget.querySelector(".hover-target").classList.add("hidden");
                },
                onClickUpdate(item, index, evt) {
                    window.location="{% url 'todo:update' '00000000-0000-0000-0000-000000000000' %}".replace(/00000000-0000-0000-0000-000000000000/, item);
                },
                onClickDelete(item, index, evt) {

                    let selectedUuid = item;

                    axios.delete("{% url 'todo-list' %}" + selectedUuid)
                         .then((response) => {

                             this.$bvToast.toast("Todo task deleted", {
                                 title: "Info",
                                 variant: "primary"
                             })

                             EventBus.$emit("get-todo-list");

                             this.$store.state.selectedUuid = null;

                             console.log("Success");
                         }, (error) => {
                             console.log(error);
                         });

                },
                onClickTag(evt) {
                    this.selectedTag = evt.currentTarget.dataset.tag;
                    this.getTodoList();
                },
                getTagClass(tag) {
                    if (tag === this.selectedTag) {
                        return "selected"
                    }
                },
                onChange(event) {
                    this.getTodoList();
                    sortable.option("disabled", true);
                },
            },
            computed: {
                isFiltered() {
                    return this.filterPriority !== "" || this.filterTime !== "";
                },
                createTodoUrl() {
                    return "{% url 'todo:create' %}?tagsearch=" + this.selectedTag;
                }
            },
            mounted() {

                EventBus.$on("get-todo-list", payload => {
                    this.getTodoList();
                });

                var el = document.querySelector("tbody");

                this.getTodoList();

            }
        });

    </script>

{% endblock %}
