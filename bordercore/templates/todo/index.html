{% extends "base.html" %}

{% block title %} Todo {% endblock %}

{% block content %}

    <div class="row no-gutters h-100" id="vue-app">

        <div class="col-lg-3 d-flex flex-column">

            <div class="card-body">

                <h2>
                    Tags
                </h2>

                {% for tag in tags %}
                    <div class="p-2">
                        <a class="btn" :class="getButtonClass('{{ tag.name }}')" href="" @click.prevent="onClickTag" data-tag="{{ tag.name }}">
                            {{ tag.name }} <span class="badge {% ifequal tagsearch tag.name %}badge-light{% else %}badge-light{% endifequal %}">{{ tag.count }}</span>
                        </a>
                    </div>
                {% endfor %}

            </div>

        </div>

        <div class="col-lg-9">

            <div class="card-grid ml-2">

                <form class="form-inline" role="form">

                    <div class="btn-group">
                        <a class="btn btn-secondary" id="btn-create" href="{% url 'todo:create' %}?tagsearch={{ tagsearch }}">Create</a>
                    </div>

                    <div class="form-group ml-2">
                        <input v-model="filter" id="todo_search" type="text" class="form-control" placeholder="Filter">
                    </div>

                </form>

                <b-table
                    hover
                    primary-key="uuid"
                    :items="items"
                    :fields="fields"
                    :sort-compare="sortCompare"
                    @sort-changed="sortChanged"
                    @row-hovered="rowHovered"
                    @row-unhovered="rowUnHovered"
                    onEnd="onEnd"
                    :filter="filter"
                    v-sortable
                    :sorting="items"
                    sort-by="manualSorting"
                >
                    <template #cell(task)="data">
                        <span v-html="data.value"></span>
                        <span v-if="data.item.url"><a class="ml-1" :href="data.item.url"><font-awesome-icon icon="link"></font-awesome-icon></a></span>
                        <div class="table-note" v-html="data.item.note"></div>
                    </template>

                    <template #cell(manualSorting)="data">
                        <font-awesome-icon icon="bars"></font-awesome-icon>
                        <span v-html="data.value"></span>
                    </template>

                    <template #cell(uuid)="data">
                        <div class="hover-target hidden">
                            <dropdown-menu v-model="show" :right="right" transition="translate-fade-down" class="text-center">
                                <font-awesome-icon icon="ellipsis-v" class="burger-menu"></font-awesome-icon>
                                <div slot="dropdown">
                                    <a class="dropdown-item" href="#" @click="onClickUpdate(data.value)">Update</a>
                                    <a class="dropdown-item" href="#" @click="onClickDelete(data.value)">Delete</a>
                                </div>
                            </dropdown-menu>
                        </div>
                    </template>

                </b-table>

            </div>

        </div>

    </div>

{% endblock %}

{% block javascript %}

    {{ block.super }}

    <script type="text/javascript" charset="utf-8">

        Vue.mixin({ delimiters: ["[[", "]]"] });

        const EventBus = new Vue();

        let sortable = null;

        Vue.directive("sortable", {
            update(el, binding, vnode) {

                const sort_items = vnode.data.attrs.sorting;
                let options = {};

                if (sort_items) {

                    options.onUpdate = function sortableUpdate(evt) {
                        const deleted = sort_items.splice(evt.oldIndex, 1);
                        sort_items.splice(evt.newIndex, 0, deleted[0]);
                    };

                    options.onEnd = function sortableEnd(evt) {
                        if (evt.newIndex !== evt.oldIndex) {

                            const bodyFormData = new URLSearchParams();
                            bodyFormData.append("tag", "{{ tagsearch }}");
                            bodyFormData.append("todo_uuid", evt.item.dataset.pk);
                            bodyFormData.append("position", evt.newIndex + 1);

                            axios("{% url 'todo:sort' %}", {
                                method: "POST",
                                data: bodyFormData,
                            })
                                .then((response) => {
                                    console.log("Success");
                                }, (error) => {
                                    console.log(error);
                                });

                        }
                    }
                }

                sortable = Sortable.create(document.querySelector("tbody"), options);
            }
        });

        new Vue({
            el: "#vue-app",
            data() {
                return {
                    selectedTag: "{{ tagsearch }}",
                    items: [],
                    fields: [
                        {
                            key: "manualSorting",
                            label: "Manual",
                            class: "cursor-grab text-center",
                            sortable: false,
                            thClass: "todo-col-manual-sorting",
                        },
                        {
                            key: "task",
                            sortable: true,
                        },
                        {
                            key: "priority",
                            sortable: true,
                            thClass: "todo-col-priority"
                        },
                        {
                            key: "modified",
                            label: "Date",
                            class: "text-nowrap",
                            sortable: true,
                            thClass: "todo-col-date"
                        },
                        {
                            key: "uuid",
                            label: "",
                            tdClass: "text-center align-middle",
                            thClass: "col-action"
                        }
                    ],
                    filter: null,
                    show: false,
                    right: true
                }
            },
            methods: {
                getTodoList() {
                    doGet(
                        this,
                        "{% url "todo:list_tasks" 666 %}".replace(/666/, this.selectedTag),
                        (response) => {
                            this.items = response.data.todo_list;
                        },
                        "Error todo list"
                    );
                },
                sortCompare(aRow, bRow, key) {

                    let a = b = null;

                    if (key === "modified") {
                        a = aRow["unixtime"];
                        b = bRow["unixtime"];
                    } else if (key === "manualSorting") {
                        a = aRow["sort_order"];
                        b = bRow["sort_order"];
                    } else {
                        a = aRow[key];
                        b = bRow[key];
                    }

                    return a < b ? -1 : a > b ? 1 : 0;

                },
                sortChanged(evt) {
                    if (evt.sortBy === "") {
                        sortable.option("disabled", false);
                    } else {
                        sortable.option("disabled", true);
                    }
                },
                rowHovered(item, index, evt) {
                    evt.currentTarget.querySelector(".hover-target").classList.remove("hidden");
                },
                rowUnHovered(item, index, evt) {
                    evt.currentTarget.querySelector(".hover-target").classList.add("hidden");
                },
                onClickUpdate(item, index, evt) {
                    window.location="{% url 'todo:update' '00000000-0000-0000-0000-000000000000' %}".replace(/00000000-0000-0000-0000-000000000000/, item);
                },
                onClickDelete(item, index, evt) {

                    let selectedUuid = item;

                    axios.delete("{% url 'todo-list' %}" + selectedUuid)
                         .then((response) => {

                             this.$bvToast.toast("Todo task deleted", {
                                 title: "Info",
                                 variant: "primary"
                             })

                             EventBus.$emit("get-todo-list");

                             this.$store.state.selectedUuid = null;

                             console.log("Success");
                         }, (error) => {
                             console.log(error);
                         });

                },
                onClickTag(evt) {
                    this.selectedTag = evt.srcElement.dataset.tag;
                    this.getTodoList();
                },
                getButtonClass(tag) {
                    if (tag === this.selectedTag) {
                        return "btn-primary"
                    } else {
                        return "btn-info"
                    }
                }
            },
            mounted() {

                EventBus.$on("get-todo-list", payload => {
                    this.getTodoList();
                });

                var el = document.querySelector("tbody");

                this.getTodoList();

            }
        });

    </script>

{% endblock %}
