{% extends "base.html" %}

{% block title %} Todo {% endblock %}

{% block content %}

    <div class="row no-gutters h-100">

        <div class="col-lg-3 d-flex flex-column">

            <div class="card-body">

                <h2>
                    Tags
                </h2>

                {% for tag in tags %}
                    <div class="p-2">
                        <a class="btn {% ifequal tagsearch tag.name %}btn-primary{% else %}btn-info{% endifequal %}" href="{% url 'todo:list' %}?tagsearch={{ tag.name }}">
                            {{ tag.name }} <span class="badge {% ifequal tagsearch tag.name %}badge-light{% else %}badge-light{% endifequal %}">{{ tag.count }}</span>
                        </a>
                    </div>
                {% endfor %}

            </div>

        </div>

        <div class="col-lg-9" id="vue-app">

            <div class="card-grid ml-2">

                <form class="form-inline" role="form">

                    <button-group inline-template>
                        <div class="btn-group">
                            <a class="btn btn-secondary" id="btn-create" href="{% url 'todo:create' %}?tagsearch={{ tagsearch }}">Create</a>
                            <input type="button" class="btn btn-secondary" id="btn-update" value="Update" :disabled="isDisabled" @click="onClickUpdate" />
                            <input type="button" class="btn btn-secondary" id="btn-delete" value="Delete" :disabled="isDisabled" @click="onClickDelete" />
                        </div>
                    </button-group>

                    <div class="form-group ml-2">
                        <input v-model="filter" id="todo_search" type="text" class="form-control" placeholder="Filter">
                    </div>

                </form>

                <b-table
                    hover
                    primary-key="uuid"
                    :items="items"
                    :fields="fields"
                    selectable
                    select-mode="single"
                    :sort-compare="sortCompare"
                    @row-selected="rowSelected"
                    @sort-changed="sortChanged"
                    onEnd="onEnd"
                    selected-variant="info"
                    :filter="filter"
                    v-sortable
                    :sorting="items"
                    sort-by="manualSorting"
                >
                    <template #cell(task)="data">
                        <span v-html="data.value"></span>
                        <span v-if="data.item.url"><a class="ml-1" :href="data.item.url"><font-awesome-icon icon="link"></font-awesome-icon></a></span>
                        <div class="todo-note" v-html="data.item.note"></div>
                    </template>

                    <template #cell(manualSorting)="data">
                        <font-awesome-icon icon="bars"></font-awesome-icon>
                        <span v-html="data.value"></span>
                    </template>

                </b-table>

            </div>

        </div>

    </div>

{% endblock %}

{% block javascript %}

    {{ block.super }}

    <script type="text/javascript" charset="utf-8">

        Vue.mixin({ delimiters: ["[[", "]]"] });

        const EventBus = new Vue();

        const store = new Vuex.Store({
            state: {
                selectedUuid: null
            }
        });

        const ButtonGroup = {
            store,
            methods: {
                onClickDelete(evt) {

                    let selectedUuid = this.$store.state.selectedUuid;

                    axios.delete("{% url 'todo-list' %}" + selectedUuid)
                         .then((response) => {

                             this.$bvToast.toast("Todo task deleted", {
                                 title: "Info",
                                 variant: "primary"
                             })

                             EventBus.$emit("get-todo-list");

                             this.$store.state.selectedUuid = null;

                             console.log("Success");
                         }, (error) => {
                             console.log(error);
                         });

                },
                onClickUpdate(evt) {
                    let selectedUuid = this.$store.state.selectedUuid;
                    window.location="{% url 'todo:update' '00000000-0000-0000-0000-000000000000' %}".replace(/00000000-0000-0000-0000-000000000000/, selectedUuid);
                },
            },
            computed: {
                isDisabled () {
                    return this.$store.state.selectedUuid === null ? true : false;
                }
            }
        };

        let sortable = null;

        Vue.directive("sortable", {
            update(el, binding, vnode) {

                const sort_items = vnode.data.attrs.sorting;
                let options = {};

                if (sort_items) {

                    options.onUpdate = function sortableUpdate(evt) {
                        const deleted = sort_items.splice(evt.oldIndex, 1);
                        sort_items.splice(evt.newIndex, 0, deleted[0]);
                    };

                    options.onEnd = function sortableEnd(evt) {
                        if (evt.newIndex !== evt.oldIndex) {

                            const bodyFormData = new URLSearchParams();
                            bodyFormData.append("tag", "{{ tagsearch }}");
                            bodyFormData.append("todo_uuid", evt.item.dataset.pk);
                            bodyFormData.append("position", evt.newIndex + 1);

                            axios("{% url 'todo:sort' %}", {
                                method: "POST",
                                data: bodyFormData,
                            })
                                .then((response) => {
                                    console.log("Success");
                                }, (error) => {
                                    console.log(error);
                                });

                        }
                    }
                }

                sortable = Sortable.create(document.querySelector("tbody"), options);
            }
        });

        new Vue({
            el: "#vue-app",
            store,
            data() {
                return {
                    items: [],
                    fields: [
                        {
                            key: "manualSorting",
                            label: "Manual",
                            class: "cursor-grab text-center",
                            sortable: false,
                            thClass: "todo-col-manual-sorting",
                        },
                        {
                            key: "task",
                            sortable: true,
                        },
                        {
                            key: "priority",
                            sortable: true,
                            thClass: "todo-col-priority"
                        },
                        {
                            key: "modified",
                            label: "Date",
                            class: "text-nowrap",
                            sortable: true,
                            thClass: "todo-col-date"
                        }
                    ],
                    selectedUuid: null,
                    filter: null,
                    sortableOptions: {
                    },
                }
            },
            methods: {
                getTodoList() {
                    doGet(
                        this,
                        "{% url "todo:list_tasks" tagsearch %}",
                        (response) => {
                            this.items = response.data.todo_list;
                        },
                        "Error todo list"
                    );
                },
                sortCompare(aRow, bRow, key) {

                    let a = b = null;

                    if (key === "modified") {
                        a = aRow["unixtime"];
                        b = bRow["unixtime"];
                    } else if (key === "manualSorting") {
                        a = aRow["sort_order"];
                        b = bRow["sort_order"];
                    } else {
                        a = aRow[key];
                        b = bRow[key];
                    }

                    return a < b ? -1 : a > b ? 1 : 0;

                },
                rowSelected(evt) {
                    if (evt.length > 0) {
                        this.selectedUuid = evt[0].uuid;
                        this.$store.state.selectedUuid = evt[0].uuid;
                    } else {
                        this.$store.state.selectedUuid = null;
                    }
                },
                sortChanged(evt) {
                    if (evt.sortBy === "") {
                        sortable.option("disabled", false);
                    } else {
                        sortable.option("disabled", true);
                    }
                }
            },
            mounted() {

                EventBus.$on("get-todo-list", payload => {
                    this.getTodoList();
                });

                var el = document.querySelector("tbody");

                this.getTodoList();

            },
            components: {
                ButtonGroup
            }
        });

    </script>

{% endblock %}
