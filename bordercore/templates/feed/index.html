{% extends "base.html" %}

{% block title %} Feeds {% endblock %}

{% block content %}

<div class="row" id="vue-app">

    <div class="col-lg-4">
        <h3>Feed List</h3>
        <hr />
        <ul id="sort-container" class="feed-list">
            <feed-list inline-template>
                <div>
                    <draggable v-model="feedList" @change="onChange" ghost-class="collection_sortable-ghost" animation="500" forceFallback="true">
                        <transition-group type="transition">
                            <li v-for="feed in feedList" :key="feed.id" v-cloak>
                                <a href="#" :data-id="feed.id" @click="onClick(feed)">[[ feed.name ]]</a>
                            </li>
                        </transition-group>
                    </draggable>
                </div>
            </feed-list>
            {% for feed in subscribed_feeds_list %}
                <li>
                    <a href="#" id="link_{{ feed.id }}">{{ feed.name }}</a>
                    {% if feed.last_response_code != 200 %}<span class="list_annotation">{{ feed.last_response_code }}</span>{% endif %}
                </li>
            {% empty %}
                No feed subscriptions found. <a href="{% url 'feed:subscriptions' %}">Subscribe here.</a>
            {% endfor %}
        </ul>

    </div>

    <url-list inline-template>
        <div class="col-lg-6">
            <h3 id="feed-title" v-cloak><a :href="currentFeed.homepage">[[ currentFeed.name ]]</a></h3>
            <hr />
            <ul>
                <li v-for="url in currentFeed.feedItems" v-cloak>
                    <a :href="url.link">[[ url.title ]]</a>
                </li>
            </ul>
        </div>
    </url-list>

</div>

{% endblock %}

{% block javascript %}

    {{ block.super }}

    <script type="text/javascript">

        Vue.mixin({ delimiters: ["[[", "]]"] });

        const EventBus = new Vue();

        const FeedList = {
            data() {
                return {
                    feedList: [
                        {% for feed in subscribed_feeds_list %}
                        {
                            id: {{ feed.id }},
                            name: "{{ feed.name }}",
                            lastResponseCode: {{ feed.last_response_code }},
                            homepage: "{{ feed.homepage }}",
                            feedItems: [
                                {% for feed_item in feed.feeditem_set.all %}
                                {
                                    link: "{{ feed_item.link }}",
                                    title: "{{ feed_item.title }}"
                                },
                                {% endfor %}
                            ]
                        },
                        {% endfor %}
                    ]
                }
            },
            methods: {
                onClick(feed) {
                    EventBus.$emit("showFeed", feed);

                    doPost(
                        this,
                        "{% url "accounts:store_in_session" %}",
                        {
                            "current_feed": feed.id
                        }
                        ,
                        (response) => {},
                        "",
                        ""
                    );

                },
                onChange(evt) {

                    const feedId = evt.moved.element.id;

                    // The backend expects the ordering to begin
                    // with 1, not 0, so add 1.
                    newPosition = evt.moved.newIndex + 1;

                    const bodyFormData = new URLSearchParams();
                    bodyFormData.append("feed_id", feedId);
                    bodyFormData.append("position", newPosition);

                    axios("{% url "feed:sort" %}", {
                        method: "POST",
                        data: bodyFormData
                    }).then(response => {
                        console.log("Success:", response);
                    })

                }
            },
            mounted() {
                currentFeed = this.feedList.find(element => element.id === {{ current_feed|safe }}.id);

                this.$nextTick(() => {
                    EventBus.$emit("showFeed", currentFeed);
                });
            }
        };

        const UrlList = {
            data() {
                return {
                    currentFeed: 0,
                }
            },
            mounted() {

                EventBus.$on("showFeed", feed => {
                    this.currentFeed = feed;
                });

            }
        }

        new Vue({
            el: "#vue-app",
            components: {
                FeedList,
                UrlList
            }
        });

    </script>

{% endblock %}
