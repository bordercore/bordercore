{% extends "base.html" %}

{% block title %} Music {% endblock %}

{% block content %}

    <div class="row g-0 h-100" id="vue-app">

        {% if not collection_is_not_empty %}

            <div class="card-grid ms-2">
                <h3>
                    Your music library is empty. Feel free to add a song to begin your collection.
                </h3>
                <div>
                    <a href="{% url 'music:create' %}" class="btn btn-primary" role="button"><font-awesome-icon icon="plus" class="me-2"></font-awesome-icon>Add song</a>
                </div>
            </div>

        {% else %}

        <div class="col-lg-3 d-flex flex-column">

            {% if random_album %}
                <card title="Featured Album" class="flex-grow-0">
                    <template v-slot:content>
                        <table class="table table-borderless">
                            <tr>
                                <td>
                                    <a href="{% url 'music:album_detail' random_album.uuid %}">
                                        <img src="{{ IMAGES_URL }}album_artwork/{{ random_album.uuid }}" height="150" width="150" />
                                    </a>
                                </td>
                                <td>
                                    <strong>{{ random_album.title }}</strong>
                                    <br />
                                    {{ random_album.artist }}
                                </td>
                            </tr>
                        </table>
                    </template>
                </card>
            {% endif %}

            <card title="Playlists" class="flex-grow-0">

                <template v-slot:content>

                    <ul class="list-group interior-borders">
                        {% for playlist in playlists %}
                            <li class="tag-list list-group-item list-group-item-secondary text-info d-flex">
                                <div>
                                    <a href="{% url 'music:playlist_detail' playlist.uuid %}">{{ playlist.name }}</a>
                                </div>
                                <div class="ms-auto">
                                    <span class="px-2 badge rounded-pill bg-info">{{ playlist.num_songs }}</span>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                    <div class="mt-3 ms-3">
                        <font-awesome-icon icon="plus"></font-awesome-icon>
                        <a href="#" class="text-info" @click="onClickCreate">Create a playlist</a>
                    </div>
                </template>

            </card>

            {% if recent_songs %}
            <card title="Recently Played Songs">
                <template v-slot:content>
                    <ul class="list-group interior-borders">
                        {% for song in recent_songs %}
                            <li class="list-group-item list-group-item-secondary text-white">
                                {{ song.title}}
                                <a class="ms-2" href="{% url 'music:artist_detail' song.artist.uuid %}">{{ song.artist.name }}</a>
                            </li>
                        {% endfor %}
                    </ul>
                </template>
            </card>
            {% endif %}

        </div>

        <div class="col-lg-9">

            <div class="me-3">

                <card>
                    <template v-slot:title-slot>
                        <div class="d-flex">

                            <div class="card-title">Recently Added Albums</div>

                            <div class="me-2 ms-auto">
                                <add-button :href="'{% url 'music:create' %}'"></add-button>
                            </div>

                        </div>
                    </template>

                    <template v-slot:content>
                        <table class="table-borderless mt-2">
                            <tr>

                                {% for album in recent_albums %}

                                    {% if forloop.counter0|divisibleby:"4" %}

                            </tr>
                            <tr class="m-2">

                                    {% endif %}

                                    <td class="w-25 hoverable p-2">
                                        <a href="{% url 'music:album_detail' album.uuid %}">
                                            <img src="{{ IMAGES_URL }}album_artwork/{{ album.uuid }}" height="150" width="150" /> <br />
                                        </a>
                                        <div class="mt-1 fw-bold">
                                            {{ album.title }}
                                        </div>
                                        <div class="text-light">
                                            <a href="{% url 'music:artist_detail' album.artist.uuid %}">
                                                {{ album.artist.name }}
                                            </a>
                                        </div>
                                    </td>

                                {% endfor %}

                            </tr>
                        </table>
                    </template>
                </card>

            <card title="Recently added music">
                <template v-slot:content>
                    <div class="card-grid ms-2">

                        <div>
                            <b-table
                                :data="songList"
                                :mobile-cards="false"
                                hoverable
                                sort-icon="chevron-up"
                                ref="table"
                            >
                                <b-table-column field="title" label="Title" header-class="cursor-pointer" v-slot="props">
                                    <span>[[ props.row.title ]]</span>
                                    <span class="ps-2 table-note" v-html="props.row.note"></span>
                                </b-table-column>

                                <b-table-column field="artist" label="Artist" header-class="cursor-pointer" v-slot="props">
                                    <a :href="props.row.artist_url">[[ props.row.artist ]]</a>
                                </b-table-column>

                                <b-table-column field="year" label="Year" header-class="cursor-pointer" v-slot="props">
                                    <span>[[ props.row.year ]]</span>
                                </b-table-column>

                                <b-table-column field="length" label="Length" cell-class="text-center" header-class="cursor-pointer text-center" v-slot="props">
                                    <span>[[ props.row.length ]]</span>
                                </b-table-column>

                            </b-table>
                        </div>

                    </div>
                </template>
            </card>
            </div>

        </div>

        <form action="{% url 'music:playlist_create' %}" method="post">
            {% csrf_token %}
            <create-update-playlist
                tag-search-url="{% url 'tag:search' %}?doctype=song"
            />
        </form>

    </div>

        {% endif %}

{% endblock %}

{% block javascript %}

    {{ block.super }}

    {{ tags|json_script:"initial-tags"|default:"" }}

    <script type="text/javascript" charset="utf-8">

        new Vue({
            el: "#vue-app",
            components: {
                CreateUpdatePlaylist
            },
            data() {
                return {
                    songList: [],
                }
            },
            mounted() {
                const promise = axios.get("{% url "music:recent_songs" %}");

                return promise.then(data => {
                    this.songList = data.data.song_list;
                })
            },
            methods: {
                myProvider(ctx, callback) {
                    const params = "?page=" + ctx.currentPage + "&size=" + ctx.perPage
                    const promise = axios.get("{% url "music:recent_songs" %}" + params)

                    return promise.then(data => {
                        const items = data.data.song_list
                        return items || []
                    })
                },
                onClickCreate(evt) {
                    const modal = new Modal("#modalCreateUpdate");
                    modal.show();
                    window.setTimeout(() => { document.getElementById("id_name").focus() }, 500);
                },
            },
        });

    </script>

{% endblock %}
