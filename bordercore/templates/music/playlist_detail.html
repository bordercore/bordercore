{% extends "base.html" %}

{% block title %} Music {% endblock %}

{% block nav %}

    <div class="d-flex mb-3" id="vue-nav">
        <div class="me-auto align-self-center">
            <ul class="breadcrumb mb-0 pt-0 pb-0">
                <li class="breadcrumb-item"> <a href="{% url 'music:list' %}"><font-awesome-icon icon="home" class="glow"></font-awesome-icon></a> </li>
                <li class="breadcrumb-item active">Playlist: {{ playlist.name }}</li>
            </ul>
        </div>
    </div>

{% endblock %}

{% block content %}

    <div class="row g-0 h-100 mx-2" id="vue-app">

        <div class="col-lg-3 d-flex flex-column">

            <div class="card-body">

                {% if playlist.type == "tag" %}

                    <div>
                        Songs matching tag <strong class="text-primary">{{ playlist.parameters.tag }}</strong>
                    </div>

                {% elif playlist.type == "recent" %}

                    <div>
                        Songs added recently
                    </div>

                {% elif playlist.type == "time" %}

                    <div>
                        Songs between the years <strong class="text-primary">{{ playlist.parameters.start_year }}</strong> and <strong class="text-primary">{{ playlist.parameters.end_year }}</strong>
                    </div>

                {% elif playlist.type == "manual" %}

                    <div>
                        Manually created playlist
                    </div>

                {% endif %}

                {% if playlist.parameters.exclude_recent %}

                    <div>
                        not listened to within the past <strong class="text-primary">{{ playlist.parameters.exclude_recent }}</strong> day{{ playlist.parameters.exclude_recent|pluralize }}
                    </div>

                {% endif %}

                {% if playlist.parameters.exclude_albums %}

                    <div>
                        not on an album
                    </div>

                {% endif %}

            </div>

            <audio-player
                ref="audioPlayer"
                :track-list="songList"
                song-url="{{ MEDIA_URL_MUSIC }}songs/"
                mark-listened-to-url="{% url 'music:mark_song_as_listened_to' '00000000-0000-0000-0000-000000000000' %}"
                @current-song="onCurrentSong"
            >
            </audio-player>

        </div>

        <div class="col-lg-9 d-flex flex-column flex-grow-last h-100">

            <card title="" class="backdrop-filter z-index-positive">
                <template v-slot:content>
                    <div class="d-flex">
                        <h2 class="text-secondary">
                            {{ playlist.name }}
                        </h2>
                        <drop-down-menu :links="playlistMenuItems">
                        </drop-down-menu>
                    </div>

                    {% if playlist.note %}
                        <h6>{{ playlist.note }}</h6>
                    {% endif %}

                    <small v-if="songCount > 0" class="text-primary ms-2" v-cloak>
                        <strong>[[ songCount ]]</strong> [[ songCountPluralized ]], <strong v-html="totalTime"></strong>
                    </small>
                </template>
            </card>

            <card title="" id="album-song-list" class="backdrop-filter">
                <template v-slot:content>

                    <o-table
                        :data="songList"
                        :default-sort="['sort_order']"
                        draggable
                        hoverable
                        :selected.sync="selectedSong"
                        :row-class="() => 'hover-target'"
                        @drop="onDrop"
                        @dragend="onDragEnd"
                        @dragover="onDragOver"
                        @dragstart="onDragStart"
                        @cell-click="onSongClicked"
                        ref="table"
                        v-cloak
                    >
                        {% if playlist.type == "manual" %}
                            <o-table-column
                                field="sort_order"
                                label="#"
                                :td-attrs="() => ({ class: 'cursor-grab' })"
                                v-slot="props"
                            >
                                <span>[[ props.row.sort_order ]]</span>
                            </o-table-column>
                        {% endif %}

                        <o-table-column
                            field="title"
                            label="Title"
                            {% if playlist.type != "manual" %}sortable{% endif %}
                            v-slot="props"
                        >
                            <span>[[ props.row.title ]]</span>
                        </o-table-column>

                        <o-table-column
                            field="artist"
                            label="Artist"
                            :td-attrs="() => ({ class: 'cursor-grab' })"
                            {% if playlist.type != "manual" %}sortable{% endif %}
                            v-slot="props"
                        >
                            <span>[[ props.row.artist ]]</span>
                        </o-table-column>

                        <o-table-column
                            field="year"
                            label="Year"
                            :td-attrs="() => ({ class: 'cursor-grab text-center' })"
                            :th-attrs="() => ({ class: 'cursor-pointer text-center' })"
                            {% if playlist.type != "manual" %}sortable{% endif %}
                            v-slot="props"
                        >
                            <span>[[ props.row.year ]]</span>
                        </o-table-column>

                        <o-table-column
                            field="length"
                            label="Length"
                            :td-attrs="() => ({ class: 'cursor-grab text-center' })"
                            :th-attrs="() => ({ class: 'cursor-pointer text-center' })"
                            {% if playlist.type != "manual" %}sortable{% endif %}
                            v-slot="props"
                        >
                            <span>[[ props.row.length ]]</span>
                        </o-table-column>

                        <o-table-column
                            field="uuid"
                            label=""
                            :td-attrs="() => ({ class: 'col-action text-center align-middle' })"
                            v-slot="props"
                        >
                            <drop-down-menu :show-on-hover="true">
                                <template #dropdown>
                                    <li>
                                        <a class="dropdown-item" href="#" @click.prevent="onClickRemove(props.row.playlistitem_uuid)">
                                            <font-awesome-icon icon="trash-alt" class="text-primary me-3"></font-awesome-icon>
                                            Remove from playlist
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" @click.prevent="onClickUpdateSong(props.row.uuid)">
                                            <font-awesome-icon icon="pencil-alt" class="text-primary me-3"></font-awesome-icon>Update
                                        </a>
                                    </li>
                                </template>
                            </drop-down-menu>
                        </o-table-column>

                        <template #empty>
                            <div class="text-center">No songs in the playlist</div>
                        </template>

                    </o-table>

                </template>
            </card>

        </div>

        <form action="{% url 'music:delete_playlist' playlist.uuid %}" method="post">

            {% csrf_token %}

            <div class="modal fade" id="modalDelete" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">

                        <div class="modal-header">
                            <h4 class="modal-title" id="myModalLabel">Delete Playlist</h4>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                            </button>
                        </div>

                        <div class="modal-body">
                            <div>
                                Are you sure you want to delete this playlist?
                            </div>

                            <div class="mt-3">
                                <input id="btn-action" class="btn btn-primary" type="submit" name="Go" value="Confirm" />
                                <a href="#" data-bs-dismiss="modal" class="ms-3">Cancel</a>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </form>

        <form action="{% url 'music:playlist_update' playlist.uuid %}" method="post">
            {% csrf_token %}
            <create-update-playlist
                tag-search-url="{% url 'tag:search' %}?doctype=song"
                action="Update"
                :playlist="JSON.parse('{{ playlist_json }}')"
            />
        </form>

    </div>

{% endblock %}

{% block javascript %}

    {{ block.super }}

    {{ tags|json_script:"initial-tags"|default:"" }}

    <script type="text/javascript">

        const navApp = createApp({
            name: "Nav",
            components: {
                FontAwesomeIcon,
            },
        });
        navApp.mount("#vue-nav");

        const app = createApp({
            name: "SongList",
            components: {
                AudioPlayer,
                Card,
                CreateUpdatePlaylist,
                DropDownMenu,
                FontAwesomeIcon,
            },
            delimiters: ["[[", "]]"],
            setup() {
                const songList = ref([]);
                const selectedSong = ref({});
                const draggingRow = ref("");
                const draggingRowIndex = ref("");
                const menuValue = ref("");
                const totalTime = ref(0);
                const continuousPlay = ref(true);

                const audioPlayer = ref(null);

                const songCount = computed(() => {
                    return songList.length;
                });

                const songCountPluralized = computed(() => {
                    return pluralize("song", songList.length);
                });

                function getPlaylist() {
                    doGet(
                        "{% url "music:get_playlist" playlist.uuid %}",
                        (response) => {
                            songList.value = response.data.playlistitems;
                            totalTime.value = response.data.totalTime;
                        },
                        "Error getting playlist",
                    );
                }

                function onCurrentSong(songNumber) {
                    if (songNumber === -1) {
                        return;
                    }
                    selectedSong.value = songList[songNumber];
                }

                function onSongClicked(row, column, rowIndex, columnIndex) {
                    // Don't play the song if we've clicked on the
                    //  'on-hover' menu, which stores the song uuid
                    if (column.field !== "uuid") {
                        audioPlayer.value.playTrack(row.uuid);
                    }
                }

                function onDragOver(payload) {
                    payload.event.dataTransfer.dropEffect = "move";
                    payload.event.preventDefault();
                }

                function onDragStart(payload) {
                    payload.event.currentTarget.classList.add("dragging");
                    draggingRow.value = payload.row;
                    draggingRowIndex.value = payload.index;
                    payload.event.dataTransfer.effectAllowed = "move";
                }

                function onDragEnd(payload) {
                    payload.event.currentTarget.classList.remove("dragging");
                }

                function onDrop(payload) {
                    const playlistItemUuid = draggingRow.playlistitem_uuid;
                    const newIndex = payload.index;

                    const bodyFormData = new URLSearchParams();
                    bodyFormData.append("playlistitem_uuid", playlistItemUuid);
                    bodyFormData.append("position", newIndex + 1);

                    axios("{% url 'music:sort_playlist' %}", {
                        method: "POST",
                        data: bodyFormData,
                    })
                        .then((response) => {
                            getPlaylist();
                        }, (error) => {
                            console.log(error);
                        });
                }

                function onClickRemove(uuid) {
                    axios.delete("{% url 'playlistitem-detail' '00000000-0000-0000-0000-000000000000' %}".replace("00000000-0000-0000-0000-000000000000", uuid))
                        .then((response) => {
                            EventBus.$emit(
                                "toast",
                                {
                                    "body": "Song deleted from playlist",
                                },
                            );

                            getPlaylist();
                        }, (error) => {
                            console.log(error);
                        });
                }

                function onClickUpdateSong(uuid) {
                    window.location = "{% url 'music:update' '00000000-0000-0000-0000-000000000000' %}?return_url={{ request.get_full_path }}".replace(/00000000-0000-0000-0000-000000000000/, uuid);
                }

                function onClickDelete() {
                    const modal = new Modal("#modalDelete");
                    modal.show();
                }

                function onClickUpdatePlaylist() {
                    const modal = new Modal("#modalCreateUpdate");
                    modal.show();
                    window.setTimeout(() => {
                        document.getElementById("id_name").focus();
                    }, 500);
                }

                onMounted(() => {
                    getPlaylist();
                });

                return {
                    audioPlayer,
                    getPlaylist,
                    onCurrentSong,
                    onSongClicked,
                    onDragOver,
                    onDragStart,
                    onDragEnd,
                    onDrop,
                    onClickRemove,
                    onClickUpdateSong,
                    onClickDelete,
                    onClickUpdatePlaylist,
                    songCount,
                    songCountPluralized,
                    songList,
                    selectedSong,
                    draggingRow,
                    draggingRowIndex,
                    menuValue,
                    totalTime,
                    continuousPlay,
                    playlistMenuItems: [
                        {
                            id: uuidv4(),
                            title: "Update",
                            url: "#",
                            clickHandler: onClickUpdatePlaylist,
                            icon: "pencil-alt",
                        },
                        {
                            id: uuidv4(),
                            title: "Delete",
                            url: "#",
                            clickHandler: onClickDelete,
                            icon: "times",
                        },
                    ],
                };
            },
        });
        app.use(Oruga, {
            iconComponent: "font-awesome-icon",
            iconPack: "fa",
            table: {
                sortIcon: "caret-up",
            },
        });
        app.mount("#vue-app");

    </script>

{% endblock %}
