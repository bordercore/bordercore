{% extends "base.html" %}

{% block title %} Music {% endblock %}

{% block nav %}

    <div class="d-flex mb-3" id="vue-nav">
        <div class="me-auto align-self-center">
            <ul class="breadcrumb mb-0 pt-0 pb-0">
                <li class="breadcrumb-item"> <a href="{% url 'music:list' %}"><font-awesome-icon icon="home" class="icon-hover"></font-awesome-icon></a> </li>
                <li class="breadcrumb-item active">Playlist: {{ playlist.name }}</li>
            </ul>
        </div>
    </div>

{% endblock %}

{% block content %}

    <div class="row g-0 h-100" id="vue-app">

        <div class="col-lg-3 d-flex flex-column">

            <div class="card-body">

                {% if playlist.type == "tag" %}

                    <div>
                        Songs matching tag <strong class="text-primary">{{ playlist.parameters.tag }}</strong>
                    </div>

                {% elif playlist.type == "recent" %}

                    <div>
                        Songs added recently
                    </div>

                {% elif playlist.type == "time" %}

                    <div>
                        Songs between the years <strong class="text-primary">{{ playlist.parameters.start_year }}</strong> and <strong class="text-primary">{{ playlist.parameters.end_year }}</strong>
                    </div>

                {% endif %}

                {% if playlist.parameters.exclude_recent %}

                    <div>
                        not listened to within the past <strong class="text-primary">{{ playlist.parameters.exclude_recent }}</strong> day{{ playlist.parameters.exclude_recent|pluralize }}
                    </div>

                {% endif %}

                {% if playlist.parameters.exclude_albums %}

                    <div>
                        not on an album
                    </div>

                {% endif %}

                <audio-player
                    ref="audioPlayer"
                    :track-list="songList"
                    song-url="{{ MEDIA_URL_MUSIC }}songs/"
                    mark-listened-to-url="{% url 'music:mark_song_as_listened_to' '00000000-0000-0000-0000-000000000000' %}"
                    @current-song="selectRow"
                >
                </audio-player>

            </div>

        </div>

        <div class="col-lg-9">

            <div class="card-grid ms-2">

                <div class="d-flex">
                    <h2 class="text-info">
                        {{ playlist.name }}
                    </h2>
                    <drop-down-menu
                        :links="playlistMenuItems"
                    >
                    </drop-down-menu>
                </div>

                {% if playlist.note %}
                    <h6>{{ playlist.note }}</h6>
                {% endif %}

                <small v-if="songCount > 0" class="text-primary ms-2"><strong>[[ songCount ]]</strong> [[ songCountPluralized ]], <strong v-html="totalTime"></strong></small>
            </div>

            <div class="ms-3 me-3">

                <b-table
                    :data="songList"
                    :mobile-cards="false"
                    :default-sort="['sort_order']"
                    hoverable
                    draggable
                    :selected.sync="selectedSong"
                    sort-icon="chevron-up"
                    @drop="onDrop"
                    @dragend="onDragEnd"
                    @dragover="onDragOver"
                    @dragstart="onDragStart"
                    @mouseenter="onMouseEnter"
                    @mouseleave="onMouseLeave"
                    @cellclick="onSongClicked"
                    ref="table"
                >

                    {% if playlist.type == "manual" %}
                    <b-table-column field="sort_order" label="#" cell-class="cursor-grab" header-class="cursor-pointer" {% if playlist.type != "manual" %}sortable{% endif %} v-slot="props">
                        <span>[[ props.row.sort_order ]]</span>
                    </b-table-column>
                    {% endif %}

                    <b-table-column field="title" label="Title" cell-class="cursor-grab" header-class="cursor-pointer" {% if playlist.type != "manual" %}sortable{% endif %} v-slot="props">
                        <span>[[ props.row.title ]]</span>
                    </b-table-column>

                    <b-table-column field="artist" label="Artist" cell-class="cursor-grab" header-class="cursor-pointer" {% if playlist.type != "manual" %}sortable{% endif %} v-slot="props">
                        <span>[[ props.row.artist ]]</span>
                    </b-table-column>

                    <b-table-column field="year" label="Year" cell-class="cursor-grab text-center" header-class="cursor-pointer text-center" {% if playlist.type != "manual" %}sortable{% endif %} v-slot="props">
                        <span>[[ props.row.year ]]</span>
                    </b-table-column>

                    <b-table-column field="length" label="Length" cell-class="cursor-grab text-center" header-class="cursor-pointer text-center" {% if playlist.type != "manual" %}sortable{% endif %} v-slot="props">
                        <span>[[ props.row.length ]]</span>
                    </b-table-column>

                    <b-table-column field="uuid" label="" cell-class="col-action text-center align-middle" v-slot="props">
                        <drop-down-menu :show-on-hover="true">
                            <div slot="dropdown">
                                <li>
                                    <a class="dropdown-item" href="#" @click.prevent="onClickRemove(props.row.uuid)">Remove from playlist</a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" @click.prevent="onClickUpdateSong(props.row.uuid)">Update</a>
                                </li>
                            </div>
                        </drop-down-menu>
                    </b-table-column>

                    <template #empty>
                        <div class="text-center">No songs in the playlist</div>
                    </template>

                </b-table>

            </div>

        </div>

        <form action="{% url 'music:delete_playlist' playlist.uuid %}" method="post">

            {% csrf_token %}

            <div class="modal fade" id="modalDelete" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">

                        <div class="modal-header">
                            <h4 class="modal-title" id="myModalLabel">Delete Playlist</h4>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                            </button>
                        </div>

                        <div class="modal-body">
                            Are you sure you want to delete this playlist?
                        </div>

                        <div class="modal-footer justify-content-end">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <input id="btn-action" class="btn btn-primary" type="submit" name="Go" value="Confirm" />
                        </div>

                    </div>
                </div>
            </div>
        </form>

        <form action="{% url 'music:playlist_update' playlist.uuid %}" method="post">
            {% csrf_token %}
            <create-update-playlist
                tag-search-url="{% url 'tag:search' %}?doctype=song"
                action="Update"
                :playlist="JSON.parse('{{ playlist_json }}')"
            />
        </form>

    </div>

{% endblock %}

{% block javascript %}

    {{ block.super }}

    {{ tags|json_script:"initial-tags"|default:"" }}

    <script type="text/javascript">

        new Vue({
            el: "#vue-nav",
        });

        const table = new Vue({
            el: "#vue-app",
            components: {
                CreateUpdatePlaylist
            },
            data() {
                return {
                    songList: [],
                    selectedSong: null,
                    draggingRow: null,
                    draggingRowIndex: null,
                    menuValue: "",
                    totalTime: 0,
                    continuousPlay: true,
                    playlistMenuItems: [
                        {
                            id: uuidv4(),
                            title: "Update",
                            url: "#",
                            clickHandler: this.onClickUpdatePlaylist,
                            icon: "pencil-alt"
                        },
                        {
                            id: uuidv4(),
                            title: "Delete",
                            url: "#",
                            clickHandler: this.onClickDelete,
                            icon: "times"
                        }
                    ]
                }
            },
            methods: {
                getPlaylist() {
                    doGet(
                        this,
                        "{% url "music:get_playlist" playlist.uuid %}",
                        (response) => {
                            this.songList = response.data.playlistitems;
                            this.totalTime = response.data.totalTime;
                        },
                        "Error getting playlist"
                    );
                },
                onSongClicked(row, column, rowIndex, columnIndex) {
                    // Don't play the song if we've clicked on the
                    //  'on-hover' menu.
                    if (columnIndex !== 5) {
                        this.$refs.audioPlayer.playTrack(row.uuid);
                    }
                },
                selectRow(index) {
                    // Select a row based on index number. If the index is -1,
                    // assume we only want to deselect any currently selected row.
                    this.$refs.table.clearSelected();
                    if (index != -1) {
                        this.$refs.table.selectRow(index);
                    }
                },
                onMouseEnter(row, evt) {
                    evt.currentTarget.querySelector(".dropdown").classList.remove("d-none");
                },
                onMouseLeave(row, evt) {
                    evt.currentTarget.querySelector(".dropdown").classList.add("d-none");
                },
                onDragOver(payload) {
                    payload.event.dataTransfer.dropEffect = "move";
                    payload.event.preventDefault();
                },
                onDragStart(payload) {
                    payload.event.currentTarget.classList.add("dragging");
                    this.draggingRow = payload.row;
                    this.draggingRowIndex = payload.index;
                    payload.event.dataTransfer.effectAllowed = "move";
                },
                onDragEnd(payload) {
                    payload.event.currentTarget.classList.remove("dragging");
                },
                onDrop(payload) {
                    const playlistItemUuid = this.draggingRow.playlistitem_uuid;
                    const newIndex = payload.index;

                    const bodyFormData = new URLSearchParams();
                    bodyFormData.append("playlistitem_uuid", playlistItemUuid);
                    bodyFormData.append("position", newIndex + 1);

                    axios("{% url 'music:sort_playlist' %}", {
                        method: "POST",
                        data: bodyFormData,
                    })
                        .then((response) => {
                            console.log("Success");
                            this.getPlaylist();
                        }, (error) => {
                            console.log(error);
                        });

                },
                onClickRemove(uuid) {
                    const self = this;
                    axios.delete("{% url 'playlistitem-detail' '00000000-0000-0000-0000-000000000000' %}".replace('00000000-0000-0000-0000-000000000000', uuid))
                         .then((response) => {

                             EventBus.$emit(
                                 "toast",
                                 {
                                     "body": "Song deleted from playlist",
                                 },
                             );

                             this.getPlaylist();
                             console.log("Success");
                         }, (error) => {
                             console.log(error);
                         });

                },
                onClickUpdateSong(uuid) {
                    window.location="{% url 'music:update' '00000000-0000-0000-0000-000000000000' %}?return_url={{ request.get_full_path }}".replace(/00000000-0000-0000-0000-000000000000/, uuid);
                },
                onClickDelete() {
                    const modal = new Modal("#modalDelete");
                    modal.show();
                },
                onClickUpdatePlaylist() {
                    const modal = new Modal("#modalCreateUpdate");
                    modal.show();
                    window.setTimeout(() => { document.getElementById("id_name").focus() }, 500);
                },
            },
            computed: {
                songCount() {
                    return this.songList.length;
                },
                songCountPluralized() {
                    return pluralize("song", this.songList.length);
                }
            },
            mounted() {
                this.getPlaylist();
            }
        });

    </script>

{% endblock %}
