{% extends "base.html" %}

{% block title %} Music {% endblock %}

{% block nav %}

    <div class="d-flex mb-3" id="vue-nav">
        <div class="me-auto align-self-center">
            <ul class="breadcrumb mb-0 pt-0 pb-0">
                <li class="breadcrumb-item"> <a href="{% url 'music:list' %}"><font-awesome-icon icon="home" class="glow"></font-awesome-icon></a> </li>
                <li class="breadcrumb-item active">Playlist: {{ playlist.name }}</li>
            </ul>
        </div>
    </div>

{% endblock %}

{% block content %}

    <div class="row g-0 h-100 mx-2" id="vue-app">

        <div class="col-lg-3 d-flex flex-column">

            <div class="card-body">

                {% if playlist.type == "tag" %}

                    <div>
                        Songs matching tag <strong class="text-primary">{{ playlist.parameters.tag }}</strong>
                    </div>

                {% elif playlist.type == "recent" %}

                    <div>
                        Songs added recently
                    </div>

                {% elif playlist.type == "time" %}

                    <div>
                        Songs between the years <strong class="text-primary">{{ playlist.parameters.start_year }}</strong> and <strong class="text-primary">{{ playlist.parameters.end_year }}</strong>
                    </div>

                {% elif playlist.type == "manual" %}

                    <div>
                        Manually created playlist
                    </div>

                {% endif %}

                {% if playlist.parameters.exclude_recent %}

                    <div>
                        not listened to within the past <strong class="text-primary">{{ playlist.parameters.exclude_recent }}</strong> day{{ playlist.parameters.exclude_recent|pluralize }}
                    </div>

                {% endif %}

                {% if playlist.parameters.exclude_albums %}

                    <div>
                        not on an album
                    </div>

                {% endif %}

            </div>

            <audio-player
                ref="audioPlayer"
                :track-list="songList"
                song-url="{{ MEDIA_URL_MUSIC }}songs/"
                mark-listened-to-url="{% url 'music:mark_song_as_listened_to' '00000000-0000-0000-0000-000000000000' %}"
            >
            </audio-player>

        </div>

        <div class="col-lg-9 d-flex flex-column flex-grow-last h-100">

            <card title="" class="backdrop-filter z-index-positive">
                <template v-slot:content>
                    <div class="d-flex">
                        <h2 class="text-secondary">
                            {{ playlist.name }}
                        </h2>
                        <drop-down-menu :links="playlistMenuItems">
                        </drop-down-menu>
                    </div>

                    {% if playlist.note %}
                        <h6>{{ playlist.note }}</h6>
                    {% endif %}

                    <small v-if="songCount > 0" class="text-primary ms-2" v-cloak>
                        <strong>[[ songCount ]]</strong> [[ songCountPluralized ]], <strong v-html="totalTime"></strong>
                    </small>
                </template>
            </card>

            <card title="" id="album-song-list" class="backdrop-filter">
                <template v-slot:content>

                    <o-table
                        :data="songList"
                        :default-sort="['sort_order']"
                        draggable
                        hoverable
                        :selected.sync="selectedSong"
                        :row-class="() => 'hover-target'"
                        @drop="onDrop"
                        @dragend="onDragEnd"
                        @dragover="onDragOver"
                        @dragstart="onDragStart"
                        @cell-click="onSongClicked"
                        ref="table"
                        v-cloak
                    >
                        {% if playlist.type == "manual" %}
                            <o-table-column
                                field="sort_order"
                                label="#"
                                :td-attrs="() => ({ class: 'cursor-grab' })"
                                v-slot="props"
                            >
                                <span>[[ props.row.sort_order ]]</span>
                            </o-table-column>
                        {% endif %}

                        <o-table-column
                            field="title"
                            label="Title"
                            {% if playlist.type != "manual" %}sortable{% endif %}
                            v-slot="props"
                        >
                            <span>[[ props.row.title ]]</span>
                        </o-table-column>

                        <o-table-column
                            field="artist"
                            label="Artist"
                            :td-attrs="() => ({ class: 'cursor-grab' })"
                            {% if playlist.type != "manual" %}sortable{% endif %}
                            v-slot="props"
                        >
                            <span>[[ props.row.artist ]]</span>
                        </o-table-column>

                        <o-table-column
                            field="year"
                            label="Year"
                            :td-attrs="() => ({ class: 'cursor-grab text-center' })"
                            :th-attrs="() => ({ class: 'cursor-pointer text-center' })"
                            {% if playlist.type != "manual" %}sortable{% endif %}
                            v-slot="props"
                        >
                            <span>[[ props.row.year ]]</span>
                        </o-table-column>

                        <o-table-column
                            field="length"
                            label="Length"
                            :td-attrs="() => ({ class: 'cursor-grab text-center' })"
                            :th-attrs="() => ({ class: 'cursor-pointer text-center' })"
                            {% if playlist.type != "manual" %}sortable{% endif %}
                            v-slot="props"
                        >
                            <span>[[ props.row.length ]]</span>
                        </o-table-column>

                        <o-table-column
                            field="uuid"
                            label=""
                            :td-attrs="() => ({ class: 'col-action text-center align-middle' })"
                            v-slot="props"
                        >
                            <drop-down-menu :show-on-hover="true">
                                <div slot="dropdown">
                                    <li>
                                        <a class="dropdown-item" href="#" @click.prevent="onClickRemove(props.row.playlistitem_uuid)">
                                            <font-awesome-icon icon="trash-alt" class="text-primary me-3"></font-awesome-icon>
                                            Remove from playlist
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" @click.prevent="onClickUpdateSong(props.row.uuid)">
                                            <font-awesome-icon icon="pencil-alt" class="text-primary me-3"></font-awesome-icon>Update
                                        </a>
                                    </li>
                                </div>
                            </drop-down-menu>
                        </o-table-column>

                        <template #empty>
                            <div class="text-center">No songs in the playlist</div>
                        </template>

                    </o-table>

                </template>
            </card>

        </div>

        <form action="{% url 'music:delete_playlist' playlist.uuid %}" method="post">

            {% csrf_token %}

            <div class="modal fade" id="modalDelete" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">

                        <div class="modal-header">
                            <h4 class="modal-title" id="myModalLabel">Delete Playlist</h4>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                            </button>
                        </div>

                        <div class="modal-body">
                            <div>
                                Are you sure you want to delete this playlist?
                            </div>

                            <div class="mt-3">
                                <input id="btn-action" class="btn btn-primary" type="submit" name="Go" value="Confirm" />
                                <a href="#" data-bs-dismiss="modal" class="ms-3">Cancel</a>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </form>

        <form action="{% url 'music:playlist_update' playlist.uuid %}" method="post">
            {% csrf_token %}
            <create-update-playlist
                tag-search-url="{% url 'tag:search' %}?doctype=song"
                action="Update"
                :playlist="JSON.parse('{{ playlist_json }}')"
            />
        </form>

    </div>

{% endblock %}

{% block javascript %}

    {{ block.super }}

    {{ tags|json_script:"initial-tags"|default:"" }}

    <script type="text/javascript">

        new Vue({
            el: "#vue-nav",
        });

        const table = new Vue({
            el: "#vue-app",
            data() {
                return {
                    songList: [],
                    selectedSong: null,
                    draggingRow: null,
                    draggingRowIndex: null,
                    menuValue: "",
                    totalTime: 0,
                    continuousPlay: true,
                    playlistMenuItems: [
                        {
                            id: uuidv4(),
                            title: "Update",
                            url: "#",
                            clickHandler: this.onClickUpdatePlaylist,
                            icon: "pencil-alt",
                        },
                        {
                            id: uuidv4(),
                            title: "Delete",
                            url: "#",
                            clickHandler: this.onClickDelete,
                            icon: "times",
                        },
                    ],
                };
            },
            methods: {
                getPlaylist() {
                    doGet(
                        this,
                        "{% url "music:get_playlist" playlist.uuid %}",
                        (response) => {
                            this.songList = response.data.playlistitems;
                            this.totalTime = response.data.totalTime;
                        },
                        "Error getting playlist",
                    );
                },
                onSongClicked(row, column, rowIndex, columnIndex) {
                    // Don't play the song if we've clicked on the
                    //  'on-hover' menu, which stores the song uuid
                    if (column.field !== "uuid") {
                        this.$refs.audioPlayer.playTrack(row.uuid);
                    }
                },
                onDragOver(payload) {
                    payload.event.dataTransfer.dropEffect = "move";
                    payload.event.preventDefault();
                },
                onDragStart(payload) {
                    payload.event.currentTarget.classList.add("dragging");
                    this.draggingRow = payload.row;
                    this.draggingRowIndex = payload.index;
                    payload.event.dataTransfer.effectAllowed = "move";
                },
                onDragEnd(payload) {
                    payload.event.currentTarget.classList.remove("dragging");
                },
                onDrop(payload) {
                    const playlistItemUuid = this.draggingRow.playlistitem_uuid;
                    const newIndex = payload.index;

                    const bodyFormData = new URLSearchParams();
                    bodyFormData.append("playlistitem_uuid", playlistItemUuid);
                    bodyFormData.append("position", newIndex + 1);

                    axios("{% url 'music:sort_playlist' %}", {
                        method: "POST",
                        data: bodyFormData,
                    })
                        .then((response) => {
                            this.getPlaylist();
                        }, (error) => {
                            console.log(error);
                        });

                },
                onClickRemove(uuid) {
                    const self = this;
                    axios.delete("{% url 'playlistitem-detail' '00000000-0000-0000-0000-000000000000' %}".replace('00000000-0000-0000-0000-000000000000', uuid))
                         .then((response) => {

                             EventBus.$emit(
                                 "toast",
                                 {
                                     "body": "Song deleted from playlist",
                                 },
                             );

                             this.getPlaylist();
                         }, (error) => {
                             console.log(error);
                         });

                },
                onClickUpdateSong(uuid) {
                    window.location="{% url 'music:update' '00000000-0000-0000-0000-000000000000' %}?return_url={{ request.get_full_path }}".replace(/00000000-0000-0000-0000-000000000000/, uuid);
                },
                onClickDelete() {
                    const modal = new Modal("#modalDelete");
                    modal.show();
                },
                onClickUpdatePlaylist() {
                    const modal = new Modal("#modalCreateUpdate");
                    modal.show();
                    window.setTimeout(() => { document.getElementById("id_name").focus() }, 500);
                },
            },
            computed: {
                songCount() {
                    return this.songList.length;
                },
                songCountPluralized() {
                    return pluralize("song", this.songList.length);
                }
            },
            mounted() {
                this.getPlaylist();
            }
        });

    </script>

{% endblock %}
