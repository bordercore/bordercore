{% extends "base.html" %}

{% load dict_get %}

{% block title %} KB :: Search {% endblock %}

{% block left-block %}

    {% if request.GET and info %}

        <div class="card bg-info">
            <div class="card-header text-white">Match Categories</div>
            <div class="card-body bg-light">
{% for facet in facet_counts|dictsortreversed:"count" %}
                    <input type="checkbox" name="filter_query" class="facet my-2" id="{{ facet.doctype }}"
                           {% if facet.doctype in filter_query %}checked="checked"{% endif %}
                           /> {{ facet.doctype_purty }} ({{ facet.count }})
                <br/>
{% endfor %}
            </div>
        </div>

    {% endif %}

{% endblock %}

{% block content %}

{% include "kb/header.html" %}

<br />

{% if request.GET %}

    <div class="row">
        <div class="col-lg-12">

{% if not info and not messages %}

    <br />
    <div class="alert alert-info">Nothing found</div>

{% else %}

    <table>

{% for match in info %}

    <tr>
        <td{% if match.importance == 10 %} class="important"{% endif %}>
{% if match.doctype == 'todo' %}

    <h4 class="search_book_title">Todo: <a href="{% url 'todo:edit' match.uuid %}">{{ match.task }}</a></h4>

{% elif match.doctype == 'bordercore_bookmark' %}

    <h4 class="search_book_title">
        <img src="{{ STATIC_URL }}img/kb_link.png" />
        <a href="{{ match.url }}">{{ match.title }}</a>
    </h4>

{% elif match.doctype == 'note' %}

    <h4 class="search_book_title"><a href="{% url 'blob:detail' match.uuid %}">{{ match.title|default:"Note" }}</a></h4>

    <h5>{{ match.note|safe }}</h5>

{% elif match.doctype == 'document' %}

    <h4 class="search_book_title">
        <a href="{% url 'blob:detail' match.uuid %}">{{ match.title|default:"Title" }}</a>
    </h4>

    <h5>{{ match.note|safe }}</h5>

{% else %}

    <h4>
        <img src="{{ STATIC_URL }}img/kb_book.png" />
        <span class="search_book_title">
            <a href="{% url 'blob:detail' match.uuid %}">{{ match.title|default:"No title" }}</a>
        </span>
        <span class="search_book_author">
            {% if match.creators %} - {{ match.creators }}{% endif %}
        </span>
    </h4>
{% endif %}

    <strong class="ml-3">{{ match.date }}</strong>

Tags: {% if not match.tags%}None{% endif %}
{% for tag in match.tags %}
    <strong><a href="{% url 'search:kb_search_tag_detail' tag %}">{{ tag }}</a></strong>{% if not forloop.last %}, {% endif %}
{% endfor %}

        </td>
    </tr>

{% endfor %}

        </table>

    </div>

{% endif %}

{% endif %}

        </div>
    </div>

{% endblock %}

{% block javascript %}

    {{ block.super }}

    <script type="text/javascript" charset="utf-8">

        new Vue({
            delimiters: ["[[", "]]"],
            el: "#search",
            data() {
                return {
                    inputName: "search",
                    query: "",
                    tags: [],
                    autoCompleteStyle: {
                        vueSimpleSuggest: "position-relative",
                        inputWrapper: "search-box",
                        defaultInput: "form-control",
                        suggestions: "position-absolute list-group z-1000",
                        suggestItem: "list-group-item"
                    }
                }
            },
            methods: {
                tagSearch(query) {
                    return axios.get("{% url 'search:kb_search_tags_booktitles' %}?term=" + query)
                                .then(response => {
                                    return response.data;
                                })
                },
                select(tag) {

                    if (tag.type == 'Tag') {
                        url = '{% url 'search:kb_search_tag_detail' 666 %}'.replace(/666/, tag.value);
                    } else {
                        url = '{% url 'blob:detail' '00000000-0000-0000-0000-000000000000' %}'.replace('00000000-0000-0000-0000-000000000000', tag.uuid);
                    }
                    window.location=url;

                },
                boldenSuggestion(scope) {

                    if (!scope) return scope;

                    const { suggestion, query } = scope;

                    let result = this.$refs.suggestComponent.displayProperty(suggestion);
                    result = "<em>" + suggestion.type + "</em> - " + result

                    if (!query) return result;

                    const texts = query.split(/[\s-_/\\|\.]/gm).filter(t => !!t) || [''];
                    return result.replace(new RegExp('(.*?)(' + texts.join('|') + ')(.*?)','gi'), '$1<b>$2</b>$3');
                }
            }
        });

    </script>

{% endblock %}
