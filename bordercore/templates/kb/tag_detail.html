{% extends "base.html" %}

{% load get_doctype %}
{% load dict_get %}

{% block title %} KB :: Tag Detail {% endblock %}

{% block content %}

{% include "kb/header.html" %}

    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/tagsinput.css" />

    <script type="text/javascript" src="{{ STATIC_URL }}js/bootstrap-tagsinput.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/typeahead.bundle.min.js"></script>

    <script type="text/javascript">

        $(document).ready(function() {

            {% include "common/common-typeaheadjs-tagsinput.js" with itemValue="value" %}

            // Tags are stored by tagsinput as objects which look like this:
            //
            // { 'text': 'emacs', 'value': 'emacs', 'is_meta': 'false' }

            // Add the initial list of tags in the search box
            {% for tag in tag_list %}
            $('#id_tags').tagsinput('add',{'value':'{{ tag.name }}', 'text':'{{ tag.name }}', 'is_meta': '{{ tag.is_meta }}'});
            {% if forloop.last %}
            $('.bootstrap-tagsinput input').attr('placeholder', '')
            {% endif %}
            {% endfor %}

            $('#id_tags').on('beforeItemAdd', function(event) {
                var tags = get_tag_list_string();
                if (tags) {
                    tags = tags + ',' + event.item.value;
                } else {
                    tags = event.item.value;
                }
                event.cancel = true;
                window.location='{% url 'kb_search_tag_detail' 666 %}'.replace('666', tags);
            });

            $('#id_tags').on('itemRemoved', function(event) {
                var tags = get_tag_list_string();
                event.cancel = true;
                window.location='{% url 'kb_search_tag_detail' 666 %}'.replace('666', tags);
            });

            $('#other_tags').change( function(event) {
                var tags = get_tag_list_string() + ',' + $(this).val();
                window.location='{% url 'kb_search_tag_detail' 666 %}'.replace('666', tags);
            });

            $('#myTab a').click(function (event) {
                $.ajax( { type: 'POST',
                          url: '{% url 'store_in_session' %}',
                          data: { kb_tag_detail_current_tab:  $(this).attr('id').replace('tab_', '') },
                          success: function() {
                    }
                          });
                event.preventDefault();
                $(this).tab('show');
            });

            $('.meta_tag').click(function (event) {
                event.preventDefault();
                var tags = get_tag_list_string() + ',' + event.target.innerHTML;
                window.location='{% url 'kb_search_tag_detail' 666 %}'.replace('666', tags);
            });

            function get_tag_list_string() {
                return $.map( $('#id_tags').tagsinput('items'), function( element ) { return element.value } ).join();
            }

            // Try to select the tab based on what's stored in the user's session
            {% if kb_tag_detail_current_tab and doctypes|dict_get:kb_tag_detail_current_tab %}
            $('#myTab a#tab_{{ kb_tag_detail_current_tab }}').tab('show');
            {% else %}
            $('#myTab a:first').tab('show');
            {% endif %}

            $('#id_tags').tagsinput('focus');

        });

    </script>

    <br />

    <div class="row">
        <div class="col-lg-10">

            <form id="tag-filter-form" class="form-inline" action="{% url 'kb_search_tag_detail' tag %}" method="get" autocomplete="off">
                <div class="form-group">
                    <input id="id_tags" class="form-control" type="text" name="taglist" placeholder="Tag List" />
                </div>
                {% if tag_counts %}
                <div class="form-group ml-2">
                    <select id="other_tags" class="form-control">
                        <option value="-1">Other tags</option>
                        {% for tag, count in tag_counts %}
                            <option value="{{ tag }}">{{ tag }} ({{ count }})</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                <div class="form-group">
                {% for tag in meta_tags %}
                    {% if forloop.first %}
                        <label class="ml-3">Meta Tags: </label>
                    {% endif %}
                    <span class="badge badge-success ml-2"><a class="meta_tag tag" href="">{{ tag }}</a></span>
                {% endfor %}
                </div>
            </form>
        </div>
    </div>

    <br />

    <ul class="nav nav-tabs" id="myTab">
        {% for doctype in doctype_counts %}
            <li class="nav-item"><a class="nav-link" id="tab_{{ doctype.0 }}" href="#{{ doctype.0 }}">{{ doctype_mapping|get_doctype:doctype.0 }} <span class="badge alert-info">{{ doctype.1 }}</span></a></li>
        {% endfor %}
    </ul>

    <div class="tab-content" id="tag-detail-tab-content">

        <div id="blob" class="tab-pane fade">
            {% for match in info.matches.blob %}
                <div class="row voffset">
                    <div class="col-lg-12">
                        {% if match.sha1sum %}
                            <a href="{{ MEDIA_URL }}{{ match.url|safe }}">
                                <img src="{{ STATIC_URL }}img/download-2-32.png" width="16" height="16" />
                            </a>
                        {% endif %}
                        {% if match.content_type == 'Image' %}
                        <img width="32" height="32" src="{{ MEDIA_URL }}{{ match.cover_url }}" />
                        {% endif %}
                        <a href="{% url 'blob_detail' match.uuid %}">{{ match.title|default:"No Title" }}</a>
                        {% if match.content_type and match.content_type != 'Image' %}
                            <span class="list_annotation">{{ match.content_type }}</span>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>

        <div id="book" class="tab-pane fade">
            <table class="table-borderless">
                <tr>

            {% for match in info.matches.book %}
                {% if forloop.counter0|divisibleby:"3" %}
                </tr><tr>
                {% endif %}
                <td>
                    <img src="{{ MEDIA_URL }}{{ match.cover_url }}" height="75" width="70"/>
                    <br/>
                    <a href="{{ MEDIA_URL }}blobs{{ match.url|safe }}">
                        <img src="{{ STATIC_URL }}img/download-2-32.png" width="16" height="16" />
                    </a>
                    <a href="{% url 'blob_detail' match.uuid %}">{{ match.title }}</a>
                </td>
            {% endfor %}
            </table>
        </div>

        <div id="bordercore_bookmark" class="tab-pane fade">
            {% for match in info.matches.bordercore_bookmark %}
                <div class="row voffset">
                    <div class="col-lg-12">
                        <a href="{{ match.url }}">{{ match.title }}</a>
                    </div>
                </div>
            {% endfor %}
        </div>

        <div id="document" class="tab-pane fade">
            {% for match in info.matches.document %}
                <div class="row voffset">
                    <div class="col-lg-12">
                        <a href="{% url 'blob_detail' match.uuid %}">{{ match.title|default:"No Title" }}</a>
                    </div>
                </div>
            {% endfor %}
        </div>

        <div id="note" class="tab-pane fade">
            {% for match in info.matches.note %}
                <div class="row voffset">
                    <div class="col-lg-12">
                        <a href="{% url 'blob_detail' match.uuid %}">{{ match.title|default:"Note" }}</a>
                    </div>
                </div>
            {% endfor %}
        </div>

        <div id="bordercore_todo" class="tab-pane fade">
            {% for match in info.matches.bordercore_todo %}
                <div class="row voffset">
                    <div class="col-lg-12">
                        {{ match.bordercore_todo_task.0 }}  <span class="search_todo_date">{{ match.last_modified }}</span>
                    </div>
                </div>
            {% endfor %}
        </div>

     </div>

{% endblock %}
