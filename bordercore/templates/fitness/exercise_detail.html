{% extends "base.html" %}

{% load dict_get %}

{% block title %} Exercise :: Detail {% endblock %}

{% block extra_head %}
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs4/dt-1.10.20/sl-1.3.1/datatables.min.css"/>
{% endblock %}

{% block content %}

    <div class="row">
        <div class="col-lg-12">
            {% block breadcrumbs %}
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"> <a href="{% url 'fitness_summary' %}">Exercises</a> </li>
                    <li class="breadcrumb-item active"> {{ object.exercise }} </li>
                </ol>
            {% endblock %}

        </div>
    </div>

    {% include "common/show_messages.html" %}

    <h1>{{ object.exercise }}</h1>

    <div class="row">
        <div class="col-lg-6">

    Last workout: {{ recent_data.date|date:"N j, Y" }} - {{ delta_days }} day{{ delta_days|pluralize:"s" }} ago

            <br /><br />

            <form action="{% url 'change_active_status' %}" method="post">
                {% csrf_token %}
                <input type="hidden" name="exercise_id" value="{{ object.id }}" />
                {% if activity_info %}
        You've been doing this exercise since {{ activity_info.0.started|date:"N j, Y" }}
                    <button type="submit" class="btn btn-primary ml-2" id="inactive">Make Inactive</button>
                    <input type="hidden" name="state" value="inactive" />
                {% else %}
                    <button type="submit" class="btn btn-primary" id="active">Make Active</button>
                    <input type="hidden" name="state" value="active" />
                {% endif %}
            </form>

        </div>
        {% if object.note %}
            <div class="col-lg-6">
                <p class="alert alert-info">
                    {{ object.note }}
                </p>
            </div>
        {% endif %}
    </div>

    <div id="exerciseDetailChart"></div>

    {% if reps %}
        <p class="alert alert-info">Reps last workout: <strong>{{ reps }}</strong></p>
    {% endif %}

    <br /><br />
    <div class="card">
        <div class="card-header bg-info text-white">Add a new workout</div>
        <div class="card-body">

            <form id="form-workout" class="form-inline" action="{% url 'fitness_add' exercise.id %}" method="post" autocomplete="off">
                <input type="hidden" name="workout-data" id="input-metadata" />
                {% csrf_token %}

                <div class="form-group">
                    <label>Weight</label>
                    <input id="weight" class="form-control mx-3" type="text" name="weight" value="{{ recent_data.weight }}" />
                </div>

                <div class="form-group">
                    <label>Reps</label>
                    <input id="reps" class="form-control mx-3" type="text" name="reps" value="{{ first_reps }}" />
                </div>

                <input class="btn btn-secondary" id="btn-add" type="button" name="Go" value="Add" />
                <input class="btn btn-primary ml-3" id="btn-submit" disabled="disabled" type="submit" name="Go" value="Submit" />

            </form>

            <br />

            <div class="row">

                <div class="col-lg-5">
                    <table class="table table-bordered" id="workout">
                        <caption>Current workout</caption>
                        <thead>
                            <tr>
                                <th>Weight</th>
                                <th>Reps</th>
                            </tr>
                        </thead>
                        {% for w in workout %}
                            <tr><td>{{ w.0 }}</td><td>{{ w.1 }}</td></tr>
                        {% endfor %}
                    </table>
                </div>

            </div>
        </div>
    </div>

{% endblock %}

{% block javascript %}

    {{ block.super }}

    <script type="text/javascript" src="https://cdn.datatables.net/v/bs4/dt-1.10.20/sl-1.3.1/datatables.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/jquery.color-2.1.2.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <script type="text/javascript" charset="utf-8">

        var metadata = []
        var table;

        $(document).ready(function() {

            var data = [
                {
                    x: {{ labels|safe }},
                    y: {{ plotdata|safe }},
                    type: 'bar',
                    marker: {
                        color: 'rgb(158,202,225)',
                        opacity: 0.6,
                        line: {
                            color: 'rbg(8,48,107)',
                            width: 1.5
                        }
                    }
                }
            ];

            var layout = {
                title: 'Workout Data',
                yaxis: {
                    title: 'Weight',
                    titlefont: {
                        size: 16,
                        color: 'rgb(107, 107, 107)'
                    },
                    tickfont: {
                        size: 14,
                        color: 'rgb(107, 107, 107)'
                    }
                }
            };


            Plotly.newPlot('exerciseDetailChart', data, layout);

            table = $('#workout').DataTable( {
                info: false,
                language: {
                    'emptyTable': 'No workout data entered'
                },
                paging: false,
                searching: false
            });

            $('#btn-add').click( function () {
                var rowNode = table.row.add( [ $('#weight').val(), $('#reps').val() ] ).draw().node();
                $( rowNode ).css( 'color', 'red' ).animate( { color: '#666666' }, 2000 );
                $('#btn-submit').removeAttr("disabled");
            } );

            $("#form-workout").submit(function(e) {
                $('input[name="workout-data"]').val(JSON.stringify(table.data().toArray()));
            });

        });

    </script>

{% endblock %}
