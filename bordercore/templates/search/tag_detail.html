{% extends "base.html" %}

{% load domain %}

{% load get_doctype %}

{% load favicon %}

{% block title %} Search :: Tag Detail {% endblock %}

{% block content %}

    <div id="vue-app">

        <div class="row g-0 mx-2">
            <div class="col-lg-12 me-3">
                <div class="card-body mb-3 pb-4 me-2">

                    <form id="tag-filter-form" class="form-inline align-items-start" action="{% url 'search:kb_search_tag_detail' tag %}" method="get" autocomplete="off">
                        <div class="row">

                            <tags-input
                                name="tag-search"
                                class-list="col-lg-6"
                                :autofocus=true
                                place-holder="Tag"
                                search-url="{% url 'tag:search' %}?query="
                                tags-changed-url="{% url 'search:kb_search_tag_detail' 666 %}"
                                @tags-changed="handleTagSearch"
                            >
                            </tags-input>

                           {% if tag_counts %}
                               <div class="col-lg-3">
                                   <div>
                                       <select class="form-control form-select" @change="onChange">
                                           <option value="-1">Related tags</option>
                                           {% for tag, count in tag_counts %}
                                               <option value="{{ tag }}">{{ tag }} ({{ count }})</option>
                                           {% endfor %}
                                       </select>
                                   </div>
                               </div>
                           {% endif %}
                           <div>
                           {% for tag in meta_tags %}
                           {% if forloop.first %}
                               <label class="ms-3 mt-2">Meta Tags: </label>
                           {% endif %}
                           <span class="ms-2"><a class="meta_tag tag" href="" @click="onClickMetaTag">{{ tag }}</a></span>
                           {% endfor %}
                           </div>
                    </form>
                </div>
            </div>
        </div>

        <br />

        <ul class="nav nav-tabs mx-3">
            {% for doctype in doctype_counts %}
                <li class="nav-item" data-type="{{ doctype.0 }}" @click="onClickDoctype">
                    <a class="nav-link" data-bs-toggle="tab" href="#{{ doctype.0 }}">
                        {{ doctype_mapping|get_doctype:doctype.0 }}
                        <span class="badge align-middle ms-2">
                            {{ doctype.1 }}
                        </span>
                    </a>
                </li>
            {% endfor %}
        </ul>

        <div class="tab-content ps-3 h-100 mb-3">
            <tag-search-result
                doc-type="blob"
                :matches="searchResults.matches.blob"
            >
            </tag-search-result>
            <tag-search-result
                doc-type="book"
                :matches="searchResults.matches.book"
            >
            </tag-search-result>
            <tag-search-result
                doc-type="bookmark"
                :matches="searchResults.matches.bookmark"
            >
            </tag-search-result>
            <tag-search-result
                doc-type="document"
                :matches="searchResults.matches.document"
            >
            </tag-search-result>
            <tag-search-result
                doc-type="note"
                :matches="searchResults.matches.note"
            >
            </tag-search-result>
            <tag-search-result
                doc-type="drill"
                :matches="searchResults.matches.drill"
            >
            </tag-search-result>
            <tag-search-result
                doc-type="song"
                :matches="searchResults.matches.song"
            >
            </tag-search-result>
            <tag-search-result
                doc-type="todo"
                :matches="searchResults.matches.todo"
            >
            </tag-search-result>
            <tag-search-result
                doc-type="album"
                :matches="searchResults.matches.album"
            >
            </tag-search-result>
        </div>

    </div>

{% endblock %}

{% block javascript %}

    {{ block.super }}

    {{ search_results|json_script:"searchResults" }}
    {{ tag_list|json_script:"initial-tags"|default:"" }}

    <script type="text/javascript">

        function getTagListString() {
            initialTags = JSON.parse(document.getElementById("initial-tags").textContent);
            return initialTags.join(",");
        }

        const app = createApp({
            delimiters: ["[[", "]]"],
            components: {
                FontAwesomeIcon,
                TagSearchResult,
                TagsInput,
            },
            setup() {
                const searchResults = JSON.parse(document.getElementById("searchResults").textContent);
                function handleTagSearch(tagList) {
                    const tagsChangedUrl = "{% url 'search:kb_search_tag_detail' 666 %}";
                    window.location = tagsChangedUrl.replace("666", tagList.join(",")).replace("//", "/");
                };

                function onChange(evt) {
                    const tagList = getTagListString() + "," + evt.srcElement.value;
                    window.location="{% url 'search:kb_search_tag_detail' 666 %}".replace("666", tagList);
                };

                function onClickDoctype(evt) {
                    doPost(
                        "{% url "accounts:store_in_session" %}",
                        {
                            "kb_tag_detail_current_tab": evt.srcElement.parentElement.getAttribute("data-type"),
                        },
                        (response) => {
                            evt.preventDefault();
                        },
                    );
                };

                function onClickMetaTag(evt) {
                    evt.preventDefault();
                    const tagList = getTagListString() + "," + evt.srcElement.innerHTML;
                    window.location="{% url 'search:kb_search_tag_detail' 666 %}".replace(/666/, tagList);
                };

                onMounted(() => {
                    const triggerTabList = [].slice.call(document.querySelectorAll(".nav a"));
                    triggerTabList.forEach(function(triggerEl) {
                        const tabTrigger = new Tab(triggerEl);

                        triggerEl.addEventListener("click", function(event) {
                            event.preventDefault();
                            tabTrigger.show();
                        });
                    });

                    {% if kb_tag_detail_current_tab and kb_tag_detail_current_tab in doctypes %}
                    const triggerFirstTabEl = document.querySelector("li[data-type='{{ kb_tag_detail_current_tab }}'] a");
                    Tab.getInstance(triggerFirstTabEl).show();

                    {% else %}
                    // If the tab stored in the session doesn't match any current tab categories,
                    //  select the first tab.
                    const triggerFirstTabEl = document.querySelector(".nav li:first-child a");
                    if (triggerFirstTabEl != undefined) {
                        Tab.getInstance(triggerFirstTabEl).show();
                    }

                    {% endif %}
                });

                return {
                    handleTagSearch,
                    onChange,
                    onClickDoctype,
                    onClickMetaTag,
                    searchResults,
                };
            },
        });
        app.mount("#vue-app");

    </script>

{% endblock %}
