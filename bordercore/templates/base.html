{% load is_in_group %}

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>

    <head>

        <meta charset="utf-8" />
        <title>Bordercore :: {{ title|default:"Bordercore" }}</title>

        <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/bootstrap-glyphicons.css" />

        {% if debug %}
            <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}dist/css/theme-{{ request.user.userprofile.theme }}.css" />
            <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}dist/css/vue-sidebar-menu.css" />
        {% else %}
            <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/theme-{{ request.user.userprofile.theme }}.min.css" />
            <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/vue-sidebar-menu.min.css" />
        {% endif %}

        {% block extra_head %}{% endblock %}

        <style>
            /* div[class="row"] {
               outline: 1px dotted rgba(0, 0, 0, 0.25);
               }

               div[class^="col-"] {
               background-color: rgba(255, 0, 0, 0.2);
               outline: 1px dotted rgba(0, 0, 0, 0.5);
               } */
        </style>

    </head>

    <body>

        <div id="vue-toast">
            <toast
                :initial-messages="initialMessages"
            >
            </toast>
        </div>

        <div class="wrapper {% if request.session.show_sidebar == "false" %}collapsed{% else %}sidebar-transition{% endif %}">

            <div class="container-fluid d-flex flex-column" id="content">

                <div class="row">
                    <div class="col-lg-12">

                        <div id="top-bar" class="row">

                            <div class="col-lg-8 card-grid my-auto text-truncate" id="top-title">
                                <span v-if="$store.state.collapsed" v-cloak>Bordercore :: </span>{% block title %} {% endblock %}
                            </div>

                            <div class="col-lg-4 my-auto d-flex justify-content-end align-items-center">
                                <div class="position-relative">
                                    <top-search
                                        ref="topSearch"
                                        value-attribute="id"
                                        :max-suggestions=20
                                        accesskey="s"
                                        initial-search-type="{{ request.session.top_search_filter }}"
                                        suggest-search-url="{% url 'search:search_tags_and_names' %}?term="
                                        query-search-url="{% url 'search:search' %}"
                                        note-query-search-url="{% url 'search:notes' %}"
                                        drill-query-search-url="{% url 'search:search' %}"
                                        store-in-session-url="{% url "accounts:store_in_session" %}"
                                        recent-searches="{{ recent_searches }}"
                                        :recent-searches="recentSearches"
                                    >
                                    </top-search>
                                </div>

                                <span id="top-search-icon" @click="openSearchWindow">
                                    <font-awesome-icon class="top-search-target glow" icon="search" />
                                </span>

                                <recent-blobs
                                    :blob-list-info="recentBlobs"
                                    blob-detail-url="{% url 'blob:detail' '00000000-0000-0000-0000-000000000000' %}"
                                >
                                </recent-blobs>

                                <div v-cloak>
                                    <drop-down-menu
                                        class="top-drop-down"
                                        :links="userMenuItems"
                                        :initial-hide="false"
                                        :support-hover-target="false"
                                        :show-target="false"
                                    >
                                        <div slot="icon">
                                            <span class="align-middle ms-2">
                                                Hello <strong>{{ user.get_username }}</strong>
                                            </span>
                                            {% if request.user|is_in_group:"Admin" %}
                                                <span class="dropdown-item-extra align-middle ms-2" v-if="failed_test_count > 0">
                                                    [[ failed_test_count ]]
                                                </span>
                                            {% endif %}
                                            <font-awesome-icon icon="angle-down" class="align-middle ms-2" />
                                        </template>
                                    </drop-down-menu>
                                </div>

                            </div>

                            <overdue-tasks
                                :task-list-prop="overdueTasks"
                                reschedule-task-url="{% url 'todo:reschedule_task' %}"
                                delete-todo-url="{% url 'todo-detail' '00000000-0000-0000-0000-000000000000' %}"
                            >
                            </overdue-tasks>

                        </div>

                    </div>

                </div>

                {% block nav %}
                {% endblock %}

                </div>

                <div class="row flex-grow-1">

                    <div class="col-lg-12">
                        {% block content %}
                        {% endblock %}
                </div>

            </div>

        </div>

        <div id="sidebar">
            <sidebar-menu @toggle-collapse="onToggleCollapse" @item-click="onItemClick" :menu="menu" :collapsed="$store.state.collapsed" ref="sidebar" />
            <span slot="toggle-icon">
                <font-awesome-icon icon="arrows-alt-h"></font-awesome-icon>
            </span>
            <span slot="dropdown-icon">
                <font-awesome-icon icon="angle-right"></font-awesome-icon>
            </span>
        </div>

        <div class="modal fade" id="modalHelp" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title" id="myModalLabel">
                            <font-awesome-icon icon="question" class="text-info me-2"></font-awesome-icon>
                            Help
                        </h4>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="modal-body-help">
                        Help!
                    </div>
                </div>
            </div>
        </div>

        {% block javascript %}

            {% if debug %}
                <script type="text/javascript" src="{{ STATIC_URL }}dist/js/javascript-bundle.js.gz"></script>
            {% else %}
                <script type="text/javascript" src="{{ STATIC_URL }}js/javascript-bundle.min.js.gz"></script>
            {% endif %}

            {{ recent_blobs|json_script:"recent_blobs" }}
            {{ overdue_tasks|json_script:"overdue_tasks" }}
            {{ recent_searches|json_script:"recent_searches" }}

            <script type="text/javascript">

                Vue.mixin({ delimiters: ["[[", "]]"] });

                const EventBus = new Vue();

                const mapGetters = Vuex.mapGetters;

                // Use the name 'storeBase' to avoid conflict with stores in child templates
                const storeBase = new Vuex.Store({
                    state: {
                        collapsed: {% if request.session.show_sidebar == "false" %}true{% else %}false{% endif %},
                    },
                    getters: {},
                    mutations: {
                        collapsed (state, payload) {
                            state.collapsed = payload;
                        }
                    },
                });

                const timestamp = new Date().getTime()

                {% if user.userprofile.sidebar_image %}
                const sidebar = document.getElementById("sidebar");
                sidebar.style.backgroundImage = "url('https://bordercore-blobs.s3.amazonaws.com/sidebar/{{ user.userprofile.uuid }}/{{ user.userprofile.sidebar_image }}')";
                {% endif %}

                {% if user.userprofile.background_image %}
                const body = document.querySelector("body");
                body.style.backgroundImage = "url('https://bordercore-blobs.s3.amazonaws.com/background/{{ user.userprofile.uuid }}/{{ user.userprofile.background_image }}')";
                console.log("url('https://bordercore-blobs.s3.amazonaws.com/background/{{ user.userprofile.uuid }}/{{ user.userprofile.background_image }}')");
                {% endif %}

                new Vue({
                    el: "#vue-toast",
                    name: "Toast",
                    data() {
                        return {
                            initialMessages: JSON.parse('{{ json_messages|safe|escapejs }}'),
                        }
                    }
                });

                new Vue({
                    el: "#top-bar",
                    store: storeBase,
                    name: "Top Bar",
                    data() {
                        return {
                            show: false,
                            right: true,
                            failed_test_count: {{ failed_test_count }},
                            userMenuItems: [
                                {
                                    id: uuidv4(),
                                    title: "Preferences",
                                    url: "{% url 'accounts:prefs' %}",
                                    icon: "briefcase"
                                },
                                {% if request.user|is_in_group:"Admin" %}
                                {
                                    id: uuidv4(),
                                    title: "Metrics",
                                    url: "{% url 'metrics:list' %}",
                                    icon: "chart-bar",
                                    extra: {{ failed_test_count }}
                                },
                                {% endif %}
                                {
                                    id: uuidv4(),
                                    title: "Help",
                                    url: "#",
                                    icon: "question",
                                    clickHandler: this.showHelp
                                },
                                {
                                    id: uuidv4(),
                                    title: "Logout",
                                    url: "{% url 'accounts:logout' %}",
                                    icon: "sign-out-alt",
                                },
                            ],
                            recentBlobs: JSON.parse(document.getElementById("recent_blobs").textContent),
                            overdueTasks: JSON.parse(document.getElementById("overdue_tasks").textContent),
                            recentSearches: JSON.parse(document.getElementById("recent_searches").textContent),
                        }
                    },
                    methods: {
                        showHelp(evt) {
                            const helpText = document.getElementById("help-text").innerHTML;
                            document.getElementById("modal-body-help").innerHTML = markdown.render(helpText);
                            const modal = new Modal("#modalHelp");
                            modal.show();
                        },
                        openSearchWindow() {
                            this.$refs.topSearch.openSearchWindow();
                            this.$refs.topSearch.$refs.suggestComponent.input.focus()
                        }
                    },
                    mounted() {

                        if (this.overdueTasks.length > 0) {
                            const modal = new Modal("#modalOverdueTasks");
                            modal.show();
                        }
                    }
                });

                new Vue({
                    el: "#sidebar",
                    name: "Sidebar",
                    store: storeBase,
                    data() {
                        return {
                            menu: [
                                {
                                    header: true,
                                    title: "Bordercore",
                                    hiddenOnCollapse: true,
                                    class: "sidebar-header text-center"
                                },
                                {
                                    href: "{% url 'homepage:homepage' %}",
                                    title: "Home",
                                    class: "first-item",
                                    icon: {
                                        element: "font-awesome-icon",
                                        attributes: {
                                            icon: "home",
                                        },
                                        class: "fa-xs sidebar-icon"
                                    }
                                },
                                {
                                    href: "{% url 'search:search' %}",
                                    title: "Search",
                                    alias: "/search/search*",
                                    icon: {
                                        element: "font-awesome-icon",
                                        attributes: {
                                            icon: "search",
                                        },
                                        class: "sidebar-icon"
                                    }
                                },
                                {
                                    href: "{% url 'bookmark:overview' %}",
                                    title: "Bookmarks",
                                    alias: "/bookmark/*",
                                    icon: {
                                        element: "font-awesome-icon",
                                        attributes: {
                                            icon: "bookmark",
                                        },
                                        class: "sidebar-icon"
                                    },
                                    badge: {
                                        text: "",
                                        class: ""
                                    }
                                },
                                {
                                    href: "{% url 'node:list' %}",
                                    title: "Nodes",
                                    alias: "/node/*",
                                    icon: {
                                        element: "font-awesome-icon",
                                        attributes: {
                                            icon: "box",
                                        },
                                        class: "sidebar-icon"
                                    }
                                },
                                {
                                    href: "{% url 'feed:list' %}",
                                    title: "Feeds",
                                    icon: {
                                        element: "font-awesome-icon",
                                        attributes: {
                                            icon: "newspaper",
                                        },
                                        class: "sidebar-icon"
                                    }
                                },
                                {
                                    href: "{% url 'search:notes' %}",
                                    title: "Notes",
                                    icon: {
                                        element: "font-awesome-icon",
                                        attributes: {
                                            icon: "sticky-note",
                                        },
                                        class: "sidebar-icon"
                                    }
                                },
                                {
                                    href: "",
                                    title: "Blobs",
                                    icon: {
                                        element: "font-awesome-icon",
                                        attributes: {
                                            icon: "copy",
                                        },
                                        class: "sidebar-icon"
                                    },
                                    child: [
                                        {
                                            href: "{% url 'blob:list' %}",
                                            title: "Home",
                                            alias: "/blob/list",
                                        },
                                        {
                                            href: "{% url 'search:kb_search_tag_detail_search' %}",
                                            title: "Tag Search",
                                            alias: "/search/tagdetail/*",
                                        },
                                        {
                                            href: "{% url 'collection:list' %}",
                                            title: "Collections",
                                            alias: "/collection/*",
                                        },
                                        {
                                            href: "{% url 'blob:import' %}",
                                            title: "Import",
                                            alias: "/blob/import/",
                                        },
                                    ]
                                },
                                {
                                    href: "{% url 'drill:list' %}",
                                    title: "Drill",
                                    alias: "/drill/*",
                                    icon: {
                                        element: "font-awesome-icon",
                                        attributes: {
                                            icon: "graduation-cap",
                                        },
                                        class: "sidebar-icon"
                                    }
                                },
                                {
                                    href: "{% url 'music:list' %}",
                                    title: "Music",
                                    alias: ["/music/artist/*", "/music/album/*", "/music/tag/*"],
                                    icon: {
                                        element: "font-awesome-icon",
                                        attributes: {
                                            icon: "music"
                                        },
                                        class: "sidebar-icon"
                                    }
                                },
                                {
                                    href: "{% url 'todo:list' %}",
                                    title: "Todo",
                                    alias: "/todo/*",
                                    icon: {
                                        element: "font-awesome-icon",
                                        attributes: {
                                            icon: "tasks",
                                        },
                                        class: "sidebar-icon"
                                    },
                                    {% if todo_count %}
                                    badge: {
                                        text: {{ todo_count|default:0 }},
                                        class: "vsm--badge_default"
                                    }
                                    {% endif %}
                                },
                                {
                                    href: "{% url 'tag:list' %}",
                                    title: "Tags",
                                    alias: "/tag/list",
                                    icon: {
                                        element: "font-awesome-icon",
                                        attributes: {
                                            icon: "tags",
                                        },
                                        class: "sidebar-icon"
                                    },
                                },
                                {
                                    href: "{% url 'fitness:summary' %}",
                                    title: "Fitness",
                                    alias: "/fitness/*",
                                    icon: {
                                        element: "font-awesome-icon",
                                        attributes: {
                                            icon: "running",
                                        },
                                        class: "sidebar-icon"
                                    },
                                    {% if exercise_count %}
                                    badge: {
                                        text: {{ exercise_count|default:0 }},
                                        class: "vsm--badge_default"
                                    }
                                    {% endif %}
                                },
                            ],
                        }
                    },
                    computed: {
                        ...mapGetters(["collapsed"]),
                    },
                    methods: {
                        onToggleCollapse(collapsed) {

                            this.$store.commit("collapsed", collapsed);
                            const wrapper = document.querySelector(".wrapper");
                            if (collapsed) {
                                wrapper.classList.add("collapsed");
                            } else {
                                wrapper.classList.remove("collapsed");
                            }

                            doPost(
                                this,
                                "{% url "accounts:store_in_session" %}",
                                {
                                    "show_sidebar": !collapsed
                                }
                                ,
                                (response) => {},
                                "",
                                ""
                            );

                        },
                        onItemClick(event, item, node) {
                            this.ps.update();
                        },
                        getUntaggedBookmarkCount() {

                            let self = this;
                            doGet(
                                self,
                                "{% url "bookmark:get_new_bookmarks_count" 666 %}".replace(/666/, timestamp),
                                (response) => {
                                    count = response.data.count;
                                    const item = self.menu.find(item => item.title === "Bookmarks");
                                    item.badge.text = count;
                                    item.badge.class = count === 0 ? "d-none" : "vsm--badge_default";
                                },
                                "Error getting new bookmarks count"
                            );
                        }
                    },
                    mounted() {

                        window.setInterval(this.getUntaggedBookmarkCount, 60000);

                        const ps = new PerfectScrollbar(".vsm--scroll-wrapper");

                        // Save this so that we can update the scrollbar when expanding items in the sidebar
                        this.ps = ps;

                    }
                });

                new Vue({
                    name: "Help Modal",
                    el: "#modalHelp",
                });

            </script>

        {% endblock %}

        {% block help %}
            <div class="d-none" id="help-text">
Bordercore is a place to organize all your information.
            </div>
        {% endblock %}

    </body>

</html>
