{% extends "base.html" %}

{% block title %} Collections {% endblock %}

{% block nav %}

        <div class="d-flex mb-3">
            <div class="mr-auto align-self-center">
                <ul class="breadcrumb mb-0 pt-0 pb-0">
                    <li class="breadcrumb-item"> <a href="{% url 'collection:list' %}">Collection List</a> </li>
                    <li class="breadcrumb-item active">{{ object.name }}</li>
                </ul>
            </div>
        </div>

{% endblock %}

{% block content %}

    <div class="row no-gutters h-100">

        <div class="col-lg-3 d-flex flex-column">

            <div class="card-body">

                {% if object.description %}
                    <h2>{{ collection.description }}</h2>
                    <br />
                {% endif %}

                <input type="submit" class="btn btn-primary" value="Gallery" id="show-gallery" data-toggle="modal" data-target="#gallery">

                <br /><br />

                <form action="{% url 'blob:create' %}" method="GET">
                    <input type="hidden" name="collection_id" value="{{ collection.id }}" />
                    <input type="submit" class="btn btn-primary" value="Add">
                </form>

            </div>

        </div>

        <div class="col-lg-9" id="vue-app">

            <div class="card-grid ml-2">

                <h3>{{ object.name }}</h3>

                <blob-list></blob-list>
                {% if not blob_list %}
                    <div class="alert alert-warning" role="alert">Nothing in this collection</div>
                {% endif %}
            </div>
        </div>

        <div class="modal fade" id="gallery" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered w-75 mw-100" role="document">
                <div class="modal-content">
                    <div class="modal-body">
                        <div>
                            <img class="w-100" id="gallery_image" src="{{ first_blob_cover_info.url }}"/>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

{% endblock %}

{% block javascript %}

    {{ block.super }}

    <script type="text/javascript">

        current_index = 0;
        size_of_collection = {{ blob_list|length }};

        Vue.mixin({ delimiters: ["[[", "]]"] });

        const BlobList = {
            template: `
                <div>
                    <ul class="list-group list-group-horizontal text-center list-unstyled collection_sortable">
                        <draggable v-model="blob_list" @change="onChange" ghost-class="collection_ghost_class" animation="500" forceFallback="true">
                            <li v-for="blob in blob_list" :key="blob.id">
                                <a :href="[[ blob.url ]]"><img :src="[[ blob.cover_url ]]" /></a>
                                <br/>
                                <a :href="[[ blob.url ]]">[[ blob.title ]]</a> {% if blob.collection_note %}<img src="{{ STATIC_URL }}img/note.png" height="16" width="16" data-toggle="popover" data-content="[[ blob.collection_note ]]"/>{% endif %}
                            </li>
                        </draggable>
                    </ul>
                </div>
            `,
            data() {
                return {
                    blob_list: [
                        {% for blob in blob_list %}
                        {
                            id: {{ blob.id }},
                            uuid: "{{ blob.uuid }}",
                            title: "{{ blob.title|safe }}",
                            collection_note: "{{ blob.collection_note }}",
                            url: "{% url 'blob:detail' blob.uuid %}",
                            cover_url: "{{ blob.cover_url }}"
                        },
                        {% endfor %}
                    ]
                }
            },
            methods: {
                onChange(evt) {

                    // The backend expects the ordering to begin
                    // with 1, not 0, so add 1.
                    new_position = evt.moved.newIndex + 1;

                    doPost(
                        this,
                        "{% url "collection:sort" %}",
                        {
                            "collection_id": {{ collection.id }},
                            "blob_id": evt.moved.element.id,
                            "position": new_position
                        },
                        () => {},
                        "",
                        ""
                    );

                }
            }
        }

        new Vue({
            el: "#vue-app",
            components: {
                BlobList
            },
            mounted() {

                window.addEventListener("keydown", function(e) {

                    if (e.which == 37 || e.which == 39) {

                        if (e.which == 39) { /* Right arrow */

                            if (current_index == size_of_collection - 1) {
                                return;
                            }
                            current_index++;

                        }

                        if (e.which == 37) { /* Left arrow */

                            if (current_index == 0) {
                                return;
                            }
                            current_index--;

                        }

                        axios.get("{% url "collection:get_blob" object.id 666 %}".replace(/666/, current_index))
                             .then(response => {
                                 document.getElementById("gallery_image").setAttribute("src", response.data.cover_info.url);
                             })
                    }
                });
            }
        });

    </script>

{% endblock %}
