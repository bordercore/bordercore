{% extends "base.html" %}

{% block title %} Collections {% endblock %}

{% block nav %}

    <div class="d-flex mb-3">
        <div class="mr-auto align-self-center">
            <ul class="breadcrumb mb-0 pt-0 pb-0">
                <li class="breadcrumb-item"> <a href="{% url 'collection:list' %}">Collection List</a> </li>
                <li class="breadcrumb-item active">{{ collection.name }}</li>
            </ul>
        </div>
    </div>

{% endblock %}

{% block content %}

    <div class="row no-gutters h-100" id="vue-app">

        <div class="col-lg-3 d-flex flex-column">

            <div class="card-body">

                {% if collection.description %}
                    <h3 class="mb-3">{{ collection.description }}</span></h3>
                {% endif %}

                <div class="mb-3">
                    <strong>Count</strong>
                    <span class="text-primary ml-1">
                        {{ blob_list|length }} blob{{ blob_list|length|pluralize:"s" }}
                    </span>
                </div>

                <div class="mb-3">
                    <strong>Updated</strong>
                    <span class="text-primary ml-1">
                        {{ collection.modified|date:"F j, Y" }}
                    </span>
                </div>

                <a href="{% url 'blob:create' %}?collection_uuid={{ collection.uuid }}" class="btn btn-primary mt-2" role="button"><font-awesome-icon icon="plus" class="mr-2"></font-awesome-icon>Add Blob</a>

            </div>

        </div>

        <div class="col-lg-9">

            <div class="right-column">

                <card>

                    <template v-slot:title-slot>

                        <div class="d-flex">
                            <h3>{{ collection.name }}</h3>

                            <drop-down-menu
                                ref="dropDownMenu"
                                id="album-detail-menu"
                                :links="collectionDetailMenuItems"
                                class="dropdownmenu"
                            >
                            </drop-down-menu>
                        </div>

                    </template>

                    <template v-slot:content>
                        <div class="ml-2">

                            <blob-list inline-template>
                                <div>
                                    <ul class="list-group list-group-horizontal text-center list-unstyled collection-sortable">
                                        <draggable v-model="blob_list" @change="onChange" ghost-class="collection_ghost_class" animation="500" forceFallback="true">
                                            <li v-for="blob in blob_list" :key="blob.id" class="collection-item hoverable cursor-pointer float-left p-3">
                                                <button type="button" class="collection-item-delete close" data-dismiss="modal" aria-label="Close" @click="removeBlob(blob.uuid)">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                                <div class="d-flex flex-column h-100" @click="onClick(blob.url)">
                                                    <a :href="[[ blob.url ]]">
                                                        <img :src="[[ blob.cover_url ]]" />
                                                    </a>

                                                    <div class="collection-item-name mt-auto">
                                                    [[ blob.name ]]
                                                    </div>

                                                    <img v-if="blob.collection_note" src="{{ STATIC_URL }}img/note.png" height="16" width="16" data-toggle="popover" :data-content="blob.collection_note"/>

                                                </div>

                                            </li>
                                        </draggable>
                                    </ul>
                                </div>
                            </blob-list>

                           {% if not blob_list %}
                               <h5 class="text-info">
                                   This collection is empty.
                               </h5>
                           {% endif %}

                        </div>
                    </template>

                </card>

            </div>

        </div>

        <form action="{% url 'collection:update' collection.uuid %}" method="post" id="form-collection-edit">
            {% csrf_token %}
            <div class="modal fade" id="modalUpdate" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title" id="myModalLabel">
                                Update Collection
                            </h4>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        </div>
                        <div class="modal-body">
                        {% for field in form %}
                            <div class="form-group{% if field.errors %} error{% endif %} row">
                                <label class="col-lg-3 col-form-label" for="inputTitle">{{ field.label }}</label>

                                <div class="col-lg-9">

                            {% if field.label == "Tags" %}

                                <tags-input
                                    search-url="{% url 'tag:search' %}?query="
                                >
                                </tags-input>

                            {% else %}

                                {{ field }}
                                {% for error in field.errors %}
                                    <span class="form-error">{{ error }}</span>
                                {% endfor %}

                            {% endif %}

                                </div>

                            </div>
                        {% endfor %}
                        </div>
                        <div class="modal-footer">
                            <input id="btn-action" class="btn btn-primary" type="submit" name="Go" value="Update" />
                        </div>

                    </div>
                </div>
            </div>
        </form>

        <form action="{% url 'collection:delete' collection.uuid %}" method="post" id="form-collection-edit">
            {% csrf_token %}
            <div class="modal fade" id="modalDelete" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">

                        <div class="modal-header">
                            <h4 class="modal-title" id="myModalLabel">Delete Collection</h4>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        </div>

                        <div class="modal-body">
                        Are you sure you want to delete this collection?
                        </div>

                        <div class="modal-footer justify-content-end">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                            <input class="btn btn-primary" type="submit" value="Confirm" />
                        </div>

                    </div>
                </div>
            </div>
        </form>

        <div class="modal fade" id="modalSlideShow" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">

                    <div class="modal-header">
                        <h4 class="modal-title" id="myModalLabel">Begin Slide Show</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    </div>

                    <div class="modal-body">
                        Slide Show Type:

                        <div class="form-group row mt-3">
                            <div class="col-lg-12">
                                <div class="form-check">
                                    <input v-model="slideShowType" class="form-check-input" type="radio" name="type" value="manual" checked>
                                    <label class="form-check-label d-flex" for="type">
                                        Manual
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="form-group row mt-3">
                            <div class="col-lg-4">
                                <div class="form-check">
                                    <input v-model="slideShowType" class="form-check-input" type="radio" name="type" value="automatic">
                                    <label class="form-check-label d-flex" for="type">
                                        Automatic
                                    </label>
                                </div>
                            </div>
                            <div class="col-lg-8">
                                <select v-model="slideShowInterval" class="form-control">
                                    <option v-for="option in slideShowOptions" :key="option.value" :value="option.value">
                                        [[ option.display ]]
                                    </option>
                                </select>
                                <div class="d-flex flex-column pl-4 mt-2">
                                    <div>
                                        Randomize
                                    </div>
                                    <input v-model="slideShowRandomize" class="form-check-input" type="checkbox" />
                                </div>
                            </div>
                        </div>

                    </div>

                    <div class="modal-footer justify-content-end">
                        <input id="btn-action" class="btn btn-primary" type="button" name="Go" value="Confirm" @click="startSlideShow()" />
                    </div>

                </div>
            </div>
        </div>

        <div id="overlay" class="d-none">
            <img class="slide-show" src="" />
            <video class="slide-show d-none" controls autoplay loop muted>
                <source src="" type="video/mp4">
            </video>
        </div>

    </div>

{% endblock %}

{% block javascript %}

    {{ block.super }}

    {{ tags|json_script:"initial-tags"|default:"" }}

    <script type="text/javascript">

        sizeOfCollection = {{ blob_list|length }};

        const BlobList = {
            data() {
                return {
                    blob_list: [
                        {% for blob in blob_list %}
                        {
                            id: {{ blob.id }},
                            uuid: "{{ blob.uuid }}",
                            name: "{{ blob.name|escapejs|safe }}",
                            collection_note: "{{ blob.collection_note|default:'' }}",
                            url: "{% url 'blob:detail' blob.uuid %}",
                            cover_url: "{{ blob.cover_url }}"
                        },
                        {% endfor %}
                    ]
                }
            },
            methods: {
                onChange(evt) {

                    // The backend expects the ordering to begin
                    // with 1, not 0, so add 1.
                    new_position = evt.moved.newIndex + 1;

                    doPost(
                        this,
                        "{% url "collection:sort" %}",
                        {
                            "collection_uuid": "{{ collection.uuid }}",
                            "blob_uuid": evt.moved.element.uuid,
                            "position": new_position
                        },
                        () => {},
                        "",
                        ""
                    );

                },
                onClick(url) {
                    window.location=url;
                },
                removeBlob(uuid) {

                    doPost(
                        this,
                        "{% url "blob:collection_mutate" %}",
                        {
                            "blob_uuid": uuid,
                            "collection_uuid": "{{ collection.uuid }}",
                            "mutation": "delete"
                        },
                        (response) => {
                            this.getBlobList();
                        },
                        "Blob removed from collection",
                        ""
                    );

                },
                getBlobList() {
                    doGet(
                        this,
                        "{% url 'collection:get_blob_list' collection.uuid %}",
                        (response) => {
                            this.blob_list = response.data;
                        },
                        "Error getting blob list"
                    );
                }
            },
            mounted() {
                document.getElementById("id_name").value = "{{ collection.name }}";
                document.getElementById("id_description").value = "{{ collection.description }}";
            }
        }

        new Vue({
            el: "#vue-app",
            components: {
                BlobList,
                DropDownMenu,
                TagsInput
            },
            data() {
                return {
                    collectionDetailMenuItems: [
                        {
                            id: uuidv4(),
                            title: "Slide Show",
                            url: "#",
                            clickHandler: this.onClickSlideShow,
                        },
                        {
                            id: uuidv4(),
                            title: "Update",
                            url: "#",
                            clickHandler: this.onClickUpdate,
                        },
                        {
                            id: uuidv4(),
                            title: "Delete",
                            url: "#",
                            clickHandler: this.onClickDelete,
                        },
                    ],
                    {% if first_blob_info %}
                    slideShowImageInfo: {{ first_blob_info|safe }},
                    {% endif %}
                    slideShowImageIndex: 0,
                    slideShowType: "manual",
                    slideShowInterval: "60",
                    slideShowRandomize: false,
                    slideShowOptions: [
                        {
                            value: "1",
                            display: "Rotate Every Minute",
                        },
                        {
                            value: "5",
                            display: "Rotate Every 5 Minutes",
                        },
                        {
                            value: "10",
                            display: "Rotate Every 10 Minutes",
                        },
                        {
                            value: "30",
                            display: "Rotate Every 30 Minutes",
                        },
                        {
                            value: "60",
                            display: "Rotate Every Hour",
                        },
                        {
                            value: "1440",
                            display: "Rotate Every Day",
                        },
                    ]
                }
            },
            methods: {
                onClickUpdate() {
                    $("#modalUpdate").modal("show");
                },
                onClickSlideShow() {
                    $("#modalSlideShow").modal("show");
                },
                startSlideShow() {
                    $("#modalSlideShow").modal("hide");

                    // Hide scrollbars
                    document.body.style.overflow = "hidden";

                    // Add a black background
                    document.getElementById("overlay").classList.remove("d-none");

                    if (this.slideShowType === "automatic") {
                        this.getSlideShowImage();
                        setInterval( () => {
                            if (this.slideShowImageIndex === sizeOfCollection - 1) {
                                this.slideShowImageIndex = 0;
                            } else {
                                this.slideShowImageIndex++;
                            }
                            this.getSlideShowImage();
                        }, parseInt(this.slideShowInterval * 1000 * 60));
                    } else {
                        this.changeSlideShowImage(this.slideShowImageInfo.url, this.slideShowImageInfo.content_type);
                    }
                },
                getSlideShowImage() {

                    axios.get("{% url "collection:get_blob" collection.uuid 666 %}?randomize=".replace(/666/, this.slideShowImageIndex) + this.slideShowRandomize)
                         .then(response => {
                             this.changeSlideShowImage(response.data.url, response.data.content_type);
                         })
                },
                changeSlideShowImage(url, type) {
                    if (type === "Image") {
                        document.querySelector("#overlay img").classList.remove("d-none");
                        document.querySelector("#overlay img").src = url;
                        document.querySelector("#overlay video").classList.add("d-none");
                        document.querySelector("#overlay video").src = null;
                    } else {
                        document.querySelector("#overlay img").classList.add("d-none");
                        document.querySelector("#overlay img").src = null;
                        document.querySelector("#overlay video").classList.remove("d-none");
                        document.querySelector("#overlay video").src = url;
                    }
                },
                onClickDelete() {
                    $("#modalDelete").modal("show")
                },
            },
            mounted() {

                let self = this;

                window.addEventListener("keydown", function(e) {

                    if (e.which == 39) { /* Right arrow */

                        if (self.slideShowImageIndex === sizeOfCollection - 1) {
                            self.slideShowImageIndex = 0;
                        } else {
                            self.slideShowImageIndex++;
                        }

                        self.getSlideShowImage();

                    } else if (e.which == 37) { /* Left arrow */

                        if (self.slideShowImageIndex === 0) {
                            self.slideShowImageIndex = sizeOfCollection - 1;
                        } else {
                            self.slideShowImageIndex--;
                        }

                        self.getSlideShowImage();


                    } else if (e.which == 27) { /* Escape */

                        document.querySelector("#overlay img").src = null;
                        document.querySelector("#overlay video").src = null;

                        // Restore the scrollbars
                        document.body.style.overflow = "visible";

                        // Remove the back background
                        document.getElementById("overlay").classList.add("d-none");

                    }
                });
            }
        });

    </script>

{% endblock %}
