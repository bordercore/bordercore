{% extends "base.html" %}

{% block title %} Collections {% endblock %}

{% block nav %}

    <div class="d-flex mb-3">
        <div class="mr-auto align-self-center">
            <ul class="breadcrumb mb-0 pt-0 pb-0">
                <li class="breadcrumb-item"> <a href="{% url 'collection:list' %}">Collection List</a> </li>
                <li class="breadcrumb-item active">{{ collection.name }}</li>
            </ul>
        </div>
    </div>

{% endblock %}

{% block content %}

    <div class="row no-gutters h-100" id="vue-app">

        {% include "common/show_messages.html" %}

        <div class="col-lg-3 d-flex flex-column">

            <div class="card-body">

                {% if collection.description %}
                    <h2>{{ collection.description }}</h2>
                    <br />
                {% endif %}

                {% if blob_list %}
                <button type="submit" class="btn btn-primary" id="show-gallery" data-toggle="modal" data-target="#gallery" v-cloak>
                    <font-awesome-icon icon="image" class="mr-2"></font-awesome-icon>Gallery
                </button>

                <br />
                {% endif %}

                <a href="{% url 'blob:create' %}?collection_id={{ collection.id }}" class="btn btn-primary mt-2" role="button"><font-awesome-icon icon="plus" class="mr-2"></font-awesome-icon>Add Blob</a>

            </div>

        </div>

        <div class="col-lg-9">

            <div class="right-column">

                <card>

                    <template v-slot:title-slot>

                        <div class="d-flex">
                            <h3>{{ collection.name }}</h3>

                            <dropdown-menu v-model="show" :right="right" transition="translate-fade-down" class="bookmark-dropdown text-center ml-auto mr-2 mt-2">
                                <font-awesome-icon icon="ellipsis-v" class="burger-menu"></font-awesome-icon>
                                <div slot="dropdown" id="collection-detail-menu">
                                    <a class="dropdown-item" href="#" @click="onClickUpdate">Update</a>
                                    <a class="dropdown-item" href="#" @click="onClickDelete">Delete</a>
                                </div>
                            </dropdown-menu>

                        </div>

                    </template>

                    <template v-slot:content>
                        <div class="card-body ml-2">

                            <blob-list inline-template>
                                <div>
                                    <ul class="list-group list-group-horizontal text-center list-unstyled collection-sortable">
                                        <draggable v-model="blob_list" @change="onChange" ghost-class="collection_ghost_class" animation="500" forceFallback="true">
                                            <li v-for="blob in blob_list" :key="blob.id" class="hoverable float-left p-3">
                                                <a :href="[[ blob.url ]]"><img :src="[[ blob.cover_url ]]" /></a>

                                                <div class="collection-item">[[ blob.name ]]</div>

                                    {% if blob.collection_note %}

                                        <img src="{{ STATIC_URL }}img/note.png" height="16" width="16" data-toggle="popover" data-content="[[ blob.collection_note ]]"/>

                                    {% endif %}

                                            </li>
                                        </draggable>
                                    </ul>
                                </div>
                            </blob-list>

                           {% if not blob_list %}
                               <h5 class="text-info">
                                   This collection is empty.
                               </h5>
                           {% endif %}

                        </div>
                    </template>

                </card>

            </div>

        </div>

        <div class="modal fade" id="gallery" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered w-75 mw-100" role="document">
                <div class="modal-content">
                    <div class="modal-body">
                        <div>
                            <img class="w-100" id="gallery_image" src="{{ first_blob_cover_info.url }}"/>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <form action="{% url 'collection:update' collection.uuid %}" method="post" id="form-collection-edit">
            {% csrf_token %}
            <div class="modal fade" id="modalUpdate" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title" id="myModalLabel">Update Collection</h4>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        </div>
                        <div class="modal-body">
                        {% for field in form %}
                            <div class="form-group{% if field.errors %} error{% endif %} row">
                                <label class="col-lg-3 col-form-label" for="inputTitle">{{ field.label }}</label>

                                <div class="col-lg-7">

                            {% if field.label == "Tags" %}

                                <tags-input
                                    search-url="{% url 'tag:search' %}?query="
                                >
                                </tags-input>

                            {% else %}

                                {{ field }}
                                {% for error in field.errors %}
                                    <span class="form-error">{{ error }}</span>
                                {% endfor %}

                            {% endif %}

                                </div>

                            </div>
                        {% endfor %}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <input id="btn-action" class="btn btn-primary" type="submit" name="Go" value="Update" />
                        </div>

                    </div>
                </div>
            </div>
        </form>

        <form action="{% url 'collection:delete' collection.uuid %}" method="post" id="form-collection-edit">
            {% csrf_token %}
            <div class="modal fade" id="modalDelete" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">

                        <div class="modal-header">
                            <h4 class="modal-title" id="myModalLabel">Delete Collection</h4>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        </div>

                        <div class="modal-body">
                        Are you sure you want to delete this collection?
                        </div>

                        <div class="modal-footer justify-content-end">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                            <input class="btn btn-primary" type="submit" value="Confirm" />
                        </div>

                    </div>
                </div>
            </div>
        </form>

    </div>

{% endblock %}

{% block javascript %}

    {{ block.super }}

    {{ tags|json_script:"initial-tags"|default:"" }}

    <script type="text/javascript">

        current_index = 0;
        size_of_collection = {{ blob_list|length }};

        Vue.mixin({ delimiters: ["[[", "]]"] });

        const EventBus = new Vue();

        const BlobList = {
            data() {
                return {
                    blob_list: [
                        {% for blob in blob_list %}
                        {
                            id: {{ blob.id }},
                            uuid: "{{ blob.uuid }}",
                            name: "{{ blob.name|safe }}",
                            collection_note: "{{ blob.collection_note }}",
                            url: "{% url 'blob:detail' blob.uuid %}",
                            cover_url: "{{ blob.cover_url }}"
                        },
                        {% endfor %}
                    ]
                }
            },
            methods: {
                onChange(evt) {

                    // The backend expects the ordering to begin
                    // with 1, not 0, so add 1.
                    new_position = evt.moved.newIndex + 1;

                    doPost(
                        this,
                        "{% url "collection:sort" %}",
                        {
                            "collection_id": {{ collection.id }},
                            "blob_id": evt.moved.element.id,
                            "position": new_position
                        },
                        () => {},
                        "",
                        ""
                    );

                }
            },
            mounted() {
                document.getElementById("id_name").value = "{{ collection.name }}";
                document.getElementById("id_description").value = "{{ collection.description }}";
                }
            }

        new Vue({
            el: "#vue-app",
            components: {
                BlobList,
                TagsInput
            },
            data() {
                return {
                    show: false,
                    right: true,
                }
            },
            methods: {
                onClickUpdate() {
                    $("#modalUpdate").modal("show")
                },
                onClickDelete() {
                    $("#modalDelete").modal("show")
                },
            },
            mounted() {

                window.addEventListener("keydown", function(e) {

                    if (e.which == 37 || e.which == 39) {

                        if (e.which == 39) { /* Right arrow */

                            if (current_index == size_of_collection - 1) {
                                return;
                            }
                            current_index++;

                        }

                        if (e.which == 37) { /* Left arrow */

                            if (current_index == 0) {
                                return;
                            }
                            current_index--;

                        }

                        axios.get("{% url "collection:get_blob" collection.id 666 %}".replace(/666/, current_index))
                             .then(response => {
                                 document.getElementById("gallery_image").setAttribute("src", response.data.cover_info.url);
                             })
                    }
                });
            }
        });

    </script>

{% endblock %}
