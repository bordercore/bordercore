{% extends "base.html" %}

{% block title %} Collections {% endblock %}

{% block content %}

    <div id="vue-app">

        <div class="row card-grid">
            <div class="col-lg-12 d-flex align-items-center">

                <h1 class="ms-2">Collection List</h1>
                <div class="d-flex align-items-center ms-auto">
                    <Transition name="fade">
                        <div v-cloak v-if="showFilterInput" id="collection-filter" class="me-3">
                            <input type="text" class="form-control" size="20" placeholder="Name" @blur="onBlur" @keyup.enter="onFilterEnter">
                        </div>
                    </Transition>

                    <div v-if="filter" class="tag d-flex align-items-center me-3">
                        <div v-cloak>Filter: <strong>[[ filter ]]</strong></div>
                        <div>
                            <a class="ms-1" href="#" @click.prevent="onClickRemoveFilter">
                                <font-awesome-icon icon="times" class="text-primary" />
                            </a>
                        </div>
                    </div>

                    <div class="ms-2 me-5" @click="onFilterClick">
                        <font-awesome-icon icon="search" class="glow text-emphasis" />
                    </div>

                    <drop-down-menu class="my-auto">
                        <div slot="dropdown" v-cloak>
                            <li>
                                <a class="dropdown-item" href="#" @click.prevent="onClickCreate">
                                    <font-awesome-icon icon="plus" class="text-primary me-3"></font-awesome-icon>
                                        Create Collection
                                </a>
                            </li>
                        </div>
                    </drop-down-menu>

                </div>
            </div>

            <div class="col-lg-12">
                <hr class="collection-list-divider" />
            </div>

            <div class="card-grid ms-3">
                <div class="d-flex flex-column">
                    <div class="d-flex flex-wrap">
                        <div v-for="collection, index in getCollectionList()" class="collection-container text-center hoverable p-3" @click="onClickCollection(collection.url)">
                            <div class="position-relative collection mx-auto">
                                <img :src="collection.cover_url" />
                                <div class="collection-cover-container position-absolute" v-html="getBlobCount(collection.num_blobs)">
                                </div>
                            </div>
                            <div class="text-truncate">
                                <a :href="collection.url">[[ collection.name ]]</a>
                            </div>
                        </div>
                        <div v-if="getCollectionList().length === 0" class="notice-big px-3" v-cloak>
                        No collections found
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-grid ms-3">

                <form action="{% url 'collection:list' %}" method="post" id="form-collection-edit">
                {% csrf_token %}
                    <div class="modal fade" id="modalAdd" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h4 class="modal-title" id="myModalLabel">
                                        Create Collection
                                    </h4>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                    {% for field in form %}
                        <div class="{% if field.errors %} error{% endif %} row mb-3">
                            <label class="col-lg-3 col-form-label" for="inputTitle">{{ field.label }}</label>

                            <div class="col-lg-9">

                            {% if field.label == 'Tags' %}

                                <tags-input
                                    search-url="{% url 'tag:search' %}?query="
                                    :get-tags-from-event="true"
                                >
                                </tags-input>

                            {% else %}

                                {{ field }}
                                {% for error in field.errors %}
                                    <span class="form-error">{{ error }}</span>
                                {% endfor %}

                            {% endif %}

                            </div>

                        </div>
                    {% endfor %}

                                </div>
                                <div class="modal-footer">
                                    <input id="btn-action" class="btn btn-primary" type="submit" name="Go" value="Create" />
                                </div>

                            </div>
                        </div>
                    </div>
                </form>

            </div>

        </div>

    </div>

{% endblock %}

{% block javascript %}

    {{ block.super }}

    {{ collection_list|json_script:"collection_list" }}

    <script type="text/javascript" charset="utf-8">

        new Vue({
            el: "#vue-app",
            data() {
                return {
                    filter: null,
                    items: JSON.parse(document.getElementById("collection_list").textContent),
                    showFilterInput: false,
                };
            },
            methods: {
                getCollectionList() {
                    if (this.filter) {
                        const regex = new RegExp(`.*${this.filter}.*`, "i");
                        return this.items.filter((c) => !c.name.search(regex));
                    } else {
                        return this.items;
                    }
                },
                onBlur() {
                    this.showFilterInput = false;
                },
                onClickCreate(evt) {
                    document.getElementById("id_name").value = "";
                    document.getElementById("id_description").value = "";
                    EventBus.$emit("addTags", []);
                    document.getElementById("btn-action").value = "Create";
                    document.getElementById("form-collection-edit").setAttribute("action", "{% url 'collection:create' %}");
                    const modal = new Modal("#modalAdd");
                    modal.show();
                    window.setTimeout(() => {
                        document.getElementById("id_name").focus();
                    }, 500);
                },
                onClickCollection(url) {
                    window.location = url;
                },
                onClickRemoveFilter() {
                    this.filter = null;
                },
                onFilterClick() {
                    this.showFilterInput = true;
                    setTimeout( () => {
                        const el = document.getElementById("collection-filter");
                        el.querySelector("input").focus();
                    }, 100);
                },
                getBlobCount(count) {
                    return count + " " + pluralize("blob", count);
                },
                onFilterEnter() {
                    this.showFilterInput = false;
                    const el = document.getElementById("collection-filter");
                    this.filter = el.querySelector("input").value;
                },
            },
        });

    </script>

{% endblock %}
