{% extends "base.html" %}

{% block title %} Drill :: {{ title }} {% endblock %}

{% block content %}

    <div id="vue-app" class="row g-0 h-100 mx-2">

        <div class="col-lg-3 d-flex flex-column">

            <div class="card-body backdrop-filter flex-grow-1">

                <div>
                    Click the <strong>Study</strong> button to start a study session or select a <strong>tag</strong> on the right to drill on a specific category.
                </div>

                <div class="mt-3">
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal-study">Study</button>
                </div>

                {% if request.session.drill_study_session %}
                    <hr />

                    <span>
                        <a href="{% url 'drill:resume' %}" type="button" class="btn btn-primary">Resume</a> study session.
                    </span>
                        <div class="text-secondary mt-3">
                            <small>
                            {% if request.session.drill_study_session.type == "all" %}
                                Currently studying <strong>all questions</strong>.
                            {% elif request.session.drill_study_session.type == "favorites" %}
                                Currently studying your <strong>favorite questions</strong>.
                            {% elif request.session.drill_study_session.type == "tag-needing-review" %}Currently studying tag{% if "," in request.session.drill_study_session.tag %}s{% endif %} <strong>{{ request.session.drill_study_session.tag }}</strong>.
                            {% elif request.session.drill_study_session.type == "learning" %}
                                Currently studying questions that need learning.
                            {% elif request.session.drill_study_session.type == "random" %}
                                Currently studying random questions.
                            {% elif request.session.drill_study_session.type == "search" %}
                                Currently studying questions that match search <strong>{{ request.session.drill_study_session.search_term }}</strong>.
                            {% endif %}
                                <br />
                                <strong>{{ study_session_progress }}</strong> out of <strong>{{ request.session.drill_study_session.list|length }}</strong> questions completed.
                            </small>
                        </div>
                {% endif %}

                <hr />

                <div>
                    <a href="{% url 'drill:add' %}" class="btn btn-primary" role="button"><font-awesome-icon icon="plus" class="me-2"></font-awesome-icon>Add Question</a>
                </div>

            </div>

        </div>

        <div class="col-lg-3 d-flex flex-column">

            <card title="Total Progress" class="backdrop-filter">
                <template v-slot:content>
                    <hr class="divider" />
                    <div class="d-flex">
                        <div class="d-flex justify-content-center align-items-center">
                            Percentage of all questions not needing review
                        </div>
                        <drill-tag-progress
                            :count={{ total_progress.count }}
                            :progress={{ total_progress.percentage }}
                        >
                        </drill-tag-progress>
                    </div>
                </template>
            </card>

            <card title="Favorites Progress" class="backdrop-filter flex-grow-1">
                <template v-slot:content>
                    <hr class="divider" />
                    <div class="d-flex">
                        <div class="d-flex justify-content-center align-items-center">
                            Percentage of favorite questions not needing review
                        </div>
                        <drill-tag-progress
                            :count={{ favorite_questions_progress.count }}
                            :progress={{ favorite_questions_progress.percentage }}
                        >
                        </drill-tag-progress>
                    </div>
                </template>
            </card>

        </div>

        <div class="col-lg-3 d-flex flex-column">

            <card title="Tags needing review" class="backdrop-filter flex-grow-1">

                <template v-slot:content>
                    <hr class="divider" />
                    <ul class="list-unstyled">
                        <li class="d-flex text-primary px-2 py-1">
                            <div class="flex-fill fw-bold">Tag</div>
                            <div class="fw-bold">Last Reviewed</div>
                        </li>
                        <hr class="divider my-1" />
                        {% for tag in tags_last_reviewed %}
                            <li class="d-flex px-2">
                                <div class="item-name flex-fill">
                                    <a href="{% url 'drill:start_study_session_tag' tag.name %}">{{ tag.name }}</a>
                                </div>
                                <div class="item-value text-end">
                                    {{ tag.last_reviewed|date:"F j, Y"|default:"Never" }}
                                </div>
                            </li>
                         {% empty %}
                            <div class="text-success text-center">Nothing to learn</div>
                        {% endfor %}
                    </ul>
                </template>

            </card>
        </div>

        <div class="hover-target col-lg-3 d-flex flex-column">

            <card
                title="Pinned Tags"
                class="backdrop-filter"
                id="vue-app-pinned-tags"
            >
                <template v-slot:title-slot>

                    <div class="card-title d-flex align-items-center">
                        <div>
                            Pinned Tags
                        </div>
                        <drop-down-menu :show-on-hover="true">
                            <font-awesome-icon icon="ellipsis-v"></font-awesome-icon>
                            <template #dropdown>
                                <li>
                                    <a class="dropdown-item" href="#" @click="chooseTag()">
                                        <font-awesome-icon icon="pencil-alt" class="text-primary me-3"></font-awesome-icon>
                                            Pinned Tags
                                    </a>
                                </li>
                            </template>
                        </drop-down-menu>
                    </div>
                </template>

                <template v-slot:content>
                    <hr class="divider" />
                    <ul class="list-unstyled">
                        <li v-for="tag in tagList" class="d-flex px-2">
                            <div class="item-name flex-fill">
                                <a :href="tag.url">[[ tag.name ]]</a>
                            </div>
                            <div class="item-value">
                                [[ tag.progress ]]%
                            </div>
                        </li>
                        <li v-if="!tagList.length">
                            <a href="#" @click="chooseTag()">Add a tag</a>
                        </li>
                    </ul>
                </template>
            </card>

            <card class="backdrop-filter flex-grow-1">
                <template v-slot:title-slot>
                    <div class="d-flex">
                        <div v-if="showFeaturedTagInput" class="me-3 mb-0">
                            <select-value
                                ref="selectValueFeaturedTag"
                                search-url="{% url 'tag:search' %}?doctype=drill&query="
                                place-holder="Tag"
                                @select="selectFeaturedTag"
                                @close="showFeaturedTagInput = false"
                                :bolden-options="true"
                            >
                            </select-value>
                        </div>
                        <h5 v-else class="lh-base mb-0">
                            <span class="card-title">Featured Tag:</span> <a :href="featuredTag.url">[[ featuredTag.name ]]</a>
                        </h5>
                        <div class="ms-auto" @click="onTagSearch">
                            <font-awesome-icon icon="search" class="glow text-emphasis" />
                        </div>
                    </div>
                </template>
                <template v-slot:content>
                    <hr class="divider" />
                    <div class="d-flex">
                        <div class="flex-grow-1 d-flex justify-content-center align-items-center">
                            <ul class="list-unstyled">
                                <li>Last Reviewed <br/> <strong>[[ featuredTag.last_reviewed ]]</strong></li>
                            </ul>
                        </div>
                        <drill-tag-progress
                            :count=featuredTag.count
                            :progress=featuredTag.progress
                        >
                        </drill-tag-progress>
                    </div>
                </template>
            </card>

            <div class="modal fade" id="modalAddTag" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title" id="myModalLabel">Manage Tags</h4>
                            <button type="button" class="close-button btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row align-items-center">
                                <div class="form-row mx-1 w-100">
                                    <select-value
                                        ref="selectValuePinnedTag"
                                        search-url="{% url 'tag:search' %}?doctype=drill&query="
                                        place-holder="Add Tag"
                                        @select="selectPinnedTag"
                                    >
                                    </select-value>
                                </div>
                            </div>
                            <ul class="list-unstyled p-2 mb-0 wide-list">
                                <draggable v-model="tagList" @change="onDrag" :component-data="{type:'transition-group'}" item-key="name">
                                    <template #item="{element}">
                                        <li :key="element.name" class="px-2 py-1">
                                            <div class="d-flex">
                                                <div>
                                                    [[ element.name ]]
                                                </div>
                                                <div class="ms-auto my-auto">
                                                    <font-awesome-icon icon="times-circle" class="list-delete" @click="onClickDelete(element.name)" />
                                                </div>
                                            </div>
                                        </li>
                                    </template>
                                </draggable>
                            </ul>
                        </div>
                        <div class="modal-footer justify-content-start">
                            <input class="btn btn-primary" type="button" value="Done" data-bs-dismiss="modal" />
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="modal fade" id="modal-study" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title" id="myModalLabel">Start Study Session</h4>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <h5>
                            Choose your study method
                            <hr />
                        </h5>
                        <div class="form-check d-flex align-items-center mt-3">
                            <input id="id_studymethod_all" class="form-check-input" type="radio" value="all" v-model="studyMethod">
                            <label class="form-check-label ms-2" for="id_studymethod_all">
                                All questions
                            </label>
                        </div>
                        <div class="form-check d-flex align-items-center mt-3">
                            <input id="id_studymethod_favorites" class="form-check-input" type="radio" value="favorites" v-model="studyMethod">
                            <label class="form-check-label ms-2" for="id_studymethod_favorites">
                                Favorite questions
                            </label>
                        </div>
                        <div class="form-check d-flex align-items-center mt-3">
                            <input id="id_studymethod_tagsneedingreview" class="form-check-input" type="radio" value="tag-needing-review"
                                v-model="studyMethod">
                            <label class="form-check-label ms-2 d-flex align-items-center" for="id_studymethod_tagsneedingreview">
                                <div class="me-4">Tag</div>
                                <tags-input
                                    class-list=""
                                    search-url="{% url 'tag:search' %}?doctype=drill&query="
                                    id="tag-name"
                                    place-holder="Tag name"
                                ></tags-input>
                            </label>
                        </div>
                        <div class="form-check d-flex align-items-center mt-3">
                            <input id="id_studymethod_random" class="form-check-input" type="radio" value="random" v-model="studyMethod">
                            <label class="form-check-label ms-2 d-flex align-items-center" for="id_studymethod_random">
                                <div class="me-3">Random questions, count of</div>
                                <select class="form-control form-select" id="study-random-count">
                                    <option value="5">5</option>
                                    <option value="10">10</option>
                                    <option value="20">20</option>
                                    <option value="100">100</option>
                                </select>
                            </label>
                        </div>
                        <div class="form-check d-flex align-items-center mt-3">
                            <input id="id_studymethod_search" class="form-check-input" type="radio" value="search" v-model="studyMethod">
                            <label class="form-check-label ms-2 d-flex align-items-center" for="id_studymethod_search">
                                <div class="me-3">Questions matching search</div>
                                <input class="form-control" id="search-term" placeholder="Search term" autocomplete="off" />
                            </label>
                        </div>
                        <hr />
                        <div class="d-flex align-items-center my-3">
                            <div class="me-3">
                                Filter
                            </div>
                            <select class="form-control form-select" id="question-filter">
                                <option value="review" selected>Questions needing review</option>
                                <option value="all">All questions</option>
                            </select>
                        </div>
                        <a href="#" type="button" class="btn btn-primary mt-2" @click.prevent="onClickStudy">Study</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block javascript %}

    {{ block.super }}

    {{ tags|json_script:"initial-tags"|default:"" }}

    <script type="text/javascript" charset="utf-8">

        const app = createApp({
            name: "DrillDashboard",
            delimiters: ["[[", "]]"],
            components: {
                Card,
                draggable,
                DrillTagProgress,
                DropDownMenu,
                FontAwesomeIcon,
                SelectValue,
                TagsInput,
            },
            setup() {
                const featuredTag = ref({{ random_tag|safe }});
                const showFeaturedTagInput = ref(false);
                const studyMethod = ref("all");
                const tagList = ref([]);

                const selectValueFeaturedTag = ref(null);
                const selectValuePinnedTag = ref(null);

                function getTagList() {
                    doGet(
                        "{% url "drill:get_pinned_tags" %}",
                        (response) => {
                            tagList.value = response.data.tag_list;
                        },
                        "Error getting pinned tags",
                    );
                };

                function chooseTag() {
                    EventBus.$emit("open-manage-tags-modal");
                };

                function addTag(tag) {
                    doPost(
                        "{% url "drill:pin_tag" %}",
                        {
                            "tag": tag,
                        },
                        (response) => {
                            getTagList();
                        },
                        "",
                        "",
                    );
                };

                 function onClickDelete(tagName) {
                    doPost(
                        url = "{% url "drill:unpin_tag" %}",
                        {
                            "tag": tagName,
                        },
                        (response) => {
                            EventBus.$emit("get-tag-list");
                        },
                        "",
                        "",
                    );
                 };

                function onClickStudy() {
                    const filter = document.getElementById("question-filter").value;
                    if (studyMethod.value === "all") {
                        window.location = "{% url 'drill:start_study_session' 'all' %}?filter=" + filter;
                    } else if (studyMethod.value === "favorites") {
                        window.location = "{% url 'drill:start_study_session' 'favorites' %}?filter=" + filter;
                    } else if (studyMethod.value === "tag-needing-review") {
                        const tag = document.getElementsByName("tags")[0].value;
                        if (tag) {
                            window.location = "{% url 'drill:start_study_session_tag' 666 %}?filter=".replace(/666/, tag) + filter;
                        }
                    } else if (studyMethod.value === "learning") {
                        window.location = "{% url 'drill:start_study_session' 'learning' %}";
                    } else if (studyMethod.value === "random") {
                        const count = document.getElementById("study-random-count").value;
                        window.location = "{% url 'drill:start_study_session_random' 666 %}?filter=".replace(/666/, count) + filter;
                    } else if (studyMethod.value === "search") {
                        const searchTerm = document.getElementById("search-term").value;
                        if (searchTerm) {
                            window.location = "{% url 'drill:start_study_session_search' 666 %}?filter".replace(/666/, search_term) + filter;
                        }
                    }
                };

                function onDrag(evt) {
                    const tagName = evt.moved.element.name;

                    // The backend expects the ordering to begin
                    // with 1, not 0, so add 1.
                    const newPosition = evt.moved.newIndex + 1;

                    doPost(
                        "{% url "drill:sort_pinned_tags" %}",
                        {
                            "tag_name": tagName,
                            "new_position": newPosition,
                        },
                        () => {},
                        "",
                        "",
                    );
                };

                function onTagSearch() {
                    showFeaturedTagInput.value = true;
                    setTimeout( () => {
                        selectValueFeaturedTag.value.focus();
                    }, 500);
                };

                function selectPinnedTag(selection) {
                    EventBus.$emit("add-tag", selection.label);

                     nextTick(() => {
                         selectValuePinnedTag.value.clearOptions();
                     });
                };

                function selectFeaturedTag(tagInfo) {
                    showFeaturedTagInput.value = false;
                    featuredTag.value = tagInfo.info;
                };

                onMounted(() => {
                    EventBus.$on("open-manage-tags-modal", (payload) => {
                        const modal = new Modal("#modalAddTag");
                        modal.show();
                            setTimeout(() => {
                                selectValuePinnedTag.value.focus();
                            }, 500);
                    });

                    EventBus.$on("add-tag", (payload) => {
                        addTag(payload);
                    });

                    EventBus.$on("get-tag-list", () => {
                        getTagList();
                    });

                    getTagList();
                });

                return {
                    addTag,
                    chooseTag,
                    featuredTag,
                    getTagList,
                    onClickDelete,
                    onClickStudy,
                    onDrag,
                    onTagSearch,
                    selectFeaturedTag,
                    selectPinnedTag,
                    selectValueFeaturedTag,
                    selectValuePinnedTag,
                    showFeaturedTagInput,
                    studyMethod,
                    tagList,
                };
            },
        });
        app.mount("#vue-app");

    </script>

{% endblock %}
