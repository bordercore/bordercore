{% extends "base.html" %}

{% block title %} Drill :: {{ title }} {% endblock %}

{% block content %}

    <div class="row g-0 h-100 mx-2">

        <div class="col-lg-3 d-flex flex-column flex-grow-last" id="vue-app-left">

            <div class="card-body backdrop-filter">

                <div>
                    Click the <strong>Study</strong> button to start a study session or select a <strong>tag</strong> on the right to drill on a specific category.
                </div>

                <div class="mt-3">
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal-study">Study</button>
                </div>

                {% if request.session.drill_study_session %}
                    <hr />

                    <span>
                        <a href="{% url 'drill:resume' %}" type="button" class="btn btn-primary">Resume</a> study session.
                    </span>
                        <div class="mt-3 text-success">
                            <small>
                            {% if request.session.drill_study_session.type == "favorites" %}
                                Currently studying your <strong class="text-info">favorite questions</strong>.
                            {% elif request.session.drill_study_session.type == "tag-needing-review" %}Currently studying tag{% if "," in request.session.drill_study_session.tag %}s{% endif %} <strong class="text-info">{{ request.session.drill_study_session.tag }}</strong>.
                            {% elif request.session.drill_study_session.type == "learning" %}
                                Currently studying questions that need learning.
                            {% elif request.session.drill_study_session.type == "random" %}
                                Currently studying random questions.
                            {% elif request.session.drill_study_session.type == "search" %}
                                Currently studying questions that match search <strong class="text-info">{{ request.session.drill_study_session.search_term }}</strong>.
                            {% endif %}
                                <br />
                                <strong class="text-info">{{ study_session_progress }}</strong> out of <strong class="text-info">{{ request.session.drill_study_session.list|length }}</strong> questions completed.
                            </small>
                        </div>
                {% endif %}

                <hr />

                <div>
                    <a href="{% url 'drill:add' %}" class="btn btn-primary" role="button"><font-awesome-icon icon="plus" class="me-2"></font-awesome-icon>Add Question</a>
                </div>

            </div>

        </div>

        <div class="col-lg-3 d-flex flex-column flex-grow-last" id="vue-app">

            <card title="Total Progress" class="backdrop-filter">
                <template v-slot:content>
                    <div class="d-flex">
                        <div class="d-flex justify-content-center align-items-center">
                            Percentage across all tags of questions not needing review
                        </div>
                        <drill-tag-progress
                            :count={{ total_progress.count }}
                                   :progress={{ total_progress.percentage }}
                        >
                        </drill-tag-progress>
                    </div>
                </template>
            </card>

            <card title="Tags still learning" class="backdrop-filter">

                <template v-slot:content>
                    <ul class="list-unstyled">
                        <li class="d-flex text-primary px-2 py-1">
                            <div class="flex-fill fw-bold">Tag</div>
                            <div class="fw-bold">Question Count</div>
                        </li>
                        <hr class="divider my-1" />
                        {% for tag in tags_still_learning %}
                            <li class="d-flex px-2">
                                <div class="flex-fill"><a href="{% url 'drill:start_study_session_tag' tag.name %}">{{ tag.name }}</a></div>
                                <div class="text-info">{{ tag.count }}</div>
                            </li>
                        {% empty %}
                            <div class="text-success text-center">Nothing to learn</div>
                        {% endfor %}
                    </ul>
                </template>

            </card>

        </div>

        <div class="col-lg-3 d-flex flex-column flex-grow-last" id="tag-search">

            <div class="mb-2 ms-3">
                <simple-suggest
                    ref="simpleSuggest"
                    display-attribute="display"
                    value-attribute="display"
                    search-url="{% url 'tag:search' %}?doctype=drill&query="
                    place-holder="Tag Search"
                >
                </simple-suggest>
            </div>

            <div class="d-flex flex-grow-1" v-if="tag.text">
                <card class="backdrop-filter">
                    <template v-slot:title-slot>
                        <h6><a :href="tag.link">[[ tag.text ]]</a></h6>
                    </template>
                    <template v-slot:content>
                        <div class="d-flex">
                            <div class="flex-grow-1 d-flex justify-content-center align-items-center">
                                <ul class="list-unstyled">
                                    <li>Last Reviewed <br/> <strong>[[ tag.info.last_reviewed ]]</strong></li>
                                </ul>
                            </div>
                            <div class="flex-grow-1 text-center">
                                <drill-tag-progress
                                    :count=tag.info.count
                                    :progress=tag.info.progress
                                >
                                </drill-tag-progress>
                            </div>
                        </div>
                    </template>
                </card>
            </div>

            <card title="Tags needing review" class="backdrop-filter">

                <template v-slot:content>
                    <ul class="list-unstyled">
                        <li class="d-flex text-primary px-2 py-1">
                            <div class="flex-fill fw-bold">Tag</div>
                            <div class="fw-bold">Last Reviewed</div>
                        </li>
                        <hr class="divider my-1" />
                        {% for tag in tags_needing_review %}
                            <li class="d-flex px-2">
                                <div class="flex-fill"><a href="{% url 'drill:start_study_session_tag' tag.name %}">{{ tag.name }}</a></div>
                                <div class="text-info text-end">{{ tag.last_reviewed|date:"F j, Y"|default:"Never" }}</div>
                            </li>
                         {% empty %}
                            <div class="text-success text-center">Nothing to learn</div>
                        {% endfor %}
                    </ul>
                </template>

            </card>
        </div>

        <div class="hover-target col-lg-3 d-flex flex-column flex-grow-last" id="pinned-tags">

            <card
                title="Pinned Tags"
                class="backdrop-filter"
            >
                <template v-slot:title-slot>

                    <div class="card-title d-flex align-items-center">
                        <div>
                            Pinned Tags
                        </div>
                        <drop-down-menu :show-on-hover="true">
                            <font-awesome-icon icon="ellipsis-v"></font-awesome-icon>
                            <div slot="dropdown">
                                <li>
                                    <a class="dropdown-item" href="#" @click="chooseTag()">
                                        <font-awesome-icon icon="pencil-alt" class="text-primary me-3"></font-awesome-icon>
                                            Manage Tags
                                    </a>
                                </li>
                            </div>
                        </drop-down-menu>
                    </div>
                </template>

                <template v-slot:content>
                    <ul class="list-unstyled">
                        <li v-for="tag in $store.state.tagList" class="d-flex px-2">
                            <div class="flex-fill"><a :href="tag.url">[[ tag.name ]]</a></div>
                            <div class="text-info">[[ tag.progress ]]%</div>
                        </li>
                        <li v-if="!$store.state.tagList.length"><a href="#" @click="chooseTag()">Add a tag</a></li>
                    </ul>
                </template>
            </card>

            <card title="Favorites Progress" class="backdrop-filter">
                <template v-slot:content>
                    <div class="d-flex">
                        <div class="d-flex justify-content-center align-items-center">
                            Percentage across favorite questions not needing review
                        </div>
                        <drill-tag-progress
                            :count={{ favorite_questions_progress.count }}
                                   :progress={{ favorite_questions_progress.percentage }}
                        >
                        </drill-tag-progress>
                    </div>
                </template>
            </card>

            <card class="backdrop-filter flex-grow-1">
                <template v-slot:title-slot>
                    <h5>Random tag: <a href="{{ random_tag.url }}">{{ random_tag.name }}</a></h5>
                </template>
                <template v-slot:content>
                    <div class="d-flex">
                        <div class="flex-grow-1 d-flex justify-content-center align-items-center">
                            <ul class="list-unstyled">
                                <li>Last Reviewed <br/> <strong>{{ random_tag.last_reviewed }}</strong></li>
                            </ul>
                        </div>
                        <drill-tag-progress
                            :count={{ random_tag.count }}
                                   :progress={{ random_tag.progress }}
                        >
                        </drill-tag-progress>
                    </div>
                </template>
            </card>

            <div class="modal fade" id="modalAddTag" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title" id="myModalLabel">Manage Tags</h4>
                            <button type="button" class="close-button btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row align-items-center">
                                <div class="form-row mx-1 w-100">
                                    <simple-suggest
                                        ref="simpleSuggest"
                                        search-url="{% url 'tag:search' %}?doctype=drill&query="
                                        display-attribute="display"
                                        value-attribute="display"
                                        place-holder="Add Tag"
                                        wrapper-class="w-100"
                                        :debounce="500"
                                    >
                                    </simple-suggest>
                                </div>
                            </div>
                            <ul class="list-unstyled p-2 mb-0 wide-list">
                                <draggable v-model="$store.state.tagList" @change="onDrag">
                                    <transition-group type="transition">
                                        <li v-for="tag in $store.state.tagList" :key="tag.name" class="px-2 py-1">
                                            <div class="d-flex">
                                                <div>
                                                    [[ tag.name ]]
                                                </div>
                                                <div class="ms-auto my-auto">
                                                    <font-awesome-icon icon="times-circle" class="list-delete" @click="onClickDelete(tag.name)" />
                                                </div>
                                            </div>
                                        </li>
                                    </transition-group>
                                </draggable>
                            </ul>
                        </div>
                        <div class="modal-footer justify-content-start">
                            <input class="btn btn-primary" type="button" value="Done" data-bs-dismiss="modal" />
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <div class="modal fade" id="modal-study" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="myModalLabel">Start Study Session</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">

                    <h5>
                        Choose your study method
                        <hr />
                    </h5>

                    <div class="form-check mt-3">
                        <input class="form-check-input" type="radio" name="flexRadioDefault" value="favorites" v-model="picked">
                        <label class="form-check-label" for="flexRadioDefault1">
                            Favorite questions
                        </label>
                    </div>

                    <div class="form-check mt-3">
                        <input class="form-check-input" type="radio" name="flexRadioDefault" value="learning" v-model="picked">
                        <label class="form-check-label" for="flexRadioDefault1">
                            Questions to learn
                        </label>
                    </div>

                    <div class="form-check mt-3">
                        <input class="form-check-input" type="radio" name="flexRadioDefault" value="tag-needing-review" v-model="picked">
                        <label class="form-check-label d-flex" for="flexRadioDefault1">
                            <div class="me-4">Tag</div>
                            <tags-input search-url="{% url 'tag:search' %}?doctype=drill&query=" id="tag-name" place-holder="Tag name"></tags-input>
                        </label>
                    </div>

                    <div class="d-flex align-items-center mt-3 ms-4">
                        <div class="me-3">
                            Filter
                        </div>
                        <select class="form-control form-select" id="question-filter">
                            <option value="review" selected>Questions needing review</option>
                            <option value="all">All questions</option>
                        </select>
                    </div>

                    <div class="form-check mt-3">
                        <input class="form-check-input" type="radio" name="flexRadioDefault" value="random" v-model="picked">
                        <label class="form-check-label d-flex" for="flexRadioDefault1">
                            <div class="me-3">Random questions, count of</div>
                            <select class="form-control form-select" id="study-random-count">
                                <option value="5">5</option>
                                <option value="10">10</option>
                                <option value="20">20</option>
                                <option value="100">100</option>
                            </select>
                        </label>
                    </div>

                    <div class="form-check mt-3">
                        <input class="form-check-input" type="radio" name="flexRadioDefault" value="search" v-model="picked">
                        <label class="form-check-label d-flex" for="flexRadioDefault1">
                            <div class="me-3">Questions matching search</div>
                            <input class="form-control" id="search-term" placeholder="Search term" autocomplete="off" />
                        </label>
                    </div>

                    <a id="start-study-session" href="#" type="button" class="btn btn-primary mt-2" @click="onClick">Study</a>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block javascript %}

    {{ block.super }}

    {{ tags|json_script:"initial-tags"|default:"" }}

    <script type="text/javascript" charset="utf-8">

        const store = new Vuex.Store({
            state: {
                tagList: [],
            },
            getters: {},
            mutations: {},
        });

        new Vue({
            el: "#vue-app-left"
        });

        new Vue({
            el: "#vue-app"
        });

        new Vue({
            el: "#tag-search",
            data() {
                return {
                    tag: {},
                }
            },
            methods: {
                select(datum) {
                    this.tag = datum;
                },
                boldenSuggestion(scope) {
                    return scope.suggestion.display;
                }
            },
        });

        new Vue({
            el: "#pinned-tags",
            name: "Pinned Tags",
            store,
            data() {
                return {
                    show: false,
                    interactive: true,
                    showDropDownMenu: true,
                }
            },
            methods: {

                getTagList() {
                    doGet(
                        this,
                        "{% url "drill:get_pinned_tags" %}",
                        (response) => {
                            this.$store.state.tagList = response.data.tag_list;
                        },
                        "Error getting pinned tags"
                    );
                },
                chooseTag() {

                    const modal = new Modal("#modalAddTag");
                    modal.show();
                    setTimeout( () => { this.$refs.simpleSuggest.$refs.suggestComponent.input.focus(); }, 500)

                },

                addTag(tag) {
                    doPost(
                        this,
                        "{% url "drill:pin_tag" %}",
                        {
                            "tag": tag
                        },
                        (response) => {
                            this.getTagList();
                        },
                        "",
                        ""
                    );

                },

                select(selection) {

                    EventBus.$emit("add-tag", selection.text);

                    this.$nextTick(() => {
                        this.$refs.simpleSuggest.$refs.suggestComponent.$el.querySelector("input").blur();
                        this.$refs.simpleSuggest.$refs.suggestComponent.setText("");
                    });

                },

                onClickDelete(tag) {

                    doPost(
                        this,
                        url = "{% url "drill:unpin_tag" %}",
                        {
                            "tag": tag,
                        },
                        (response) => {
                            this.getTagList();
                        },
                        "",
                        ""
                    );

                },

                onDrag(evt) {

                    tag_name = evt.moved.element.name;

                    // The backend expects the ordering to begin
                    // with 1, not 0, so add 1.
                    new_position = evt.moved.newIndex + 1;

                    doPost(
                        this,
                        "{% url "drill:sort_pinned_tags" %}",
                        {
                            "tag_name": tag_name,
                            "new_position": new_position,
                        },
                        () => {},
                        "",
                        "",
                    );

                }
            },
            mounted() {

                EventBus.$on("add-tag", payload => {
                    this.addTag(payload);
                });

                this.getTagList();

            }

        });

        new Vue({
            el: "#modal-study",
            data() {
                return {
                    picked: "favorites"
                }
            },
            methods: {
                onClick() {
                    if (this.picked === "favorites") {
                        window.location = "{% url 'drill:start_study_session' 'favorites' %}";
                    } else if (this.picked === "tag-needing-review") {
                        const tag = document.getElementsByName("tags")[0].value;
                        const filter = document.getElementById("question-filter").value;
                        if (tag) {
                            window.location = "{% url 'drill:start_study_session_tag' 666 %}?filter=".replace(/666/, tag) + filter;
                        }
                    } else if (this.picked === "learning") {
                        window.location = "{% url 'drill:start_study_session' 'learning' %}";
                    } else if (this.picked === "random") {
                        const count = document.getElementById("study-random-count").value;
                        window.location = "{% url 'drill:start_study_session_random' 666 %}".replace(/666/, count);
                    } else if (this.picked === "search") {
                        const search_term = document.getElementById("search-term").value;
                        if (search_term) {
                            window.location = "{% url 'drill:start_study_session_search' 666 %}".replace(/666/, search_term);
                        }
                    }
                }
            }
        });

    </script>

{% endblock %}
