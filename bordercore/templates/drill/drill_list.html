{% extends "base.html" %}

{% block extra_head %}
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs4/dt-1.10.20/sl-1.3.1/datatables.min.css"/>
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/tagsinput.css" />
{% endblock %}

{% block left-block %}

    <div>
    Click the Start button to drill on random questions or select a tag on the right to drill on a specific category.
    </div>

    <br />

    <div>
        <form action="{% url 'study_random' %}">
            <input class="btn btn-primary" type="submit" value="Start" id="random_mode" />
        </form>
    </div>

    <hr />

    <div>
        <a href="{% url 'question_add' %}" class="btn btn-primary" role="button">Add Question</a>
    </div>

{% endblock %}

{% block title %} {{ section }} :: {{ title }} {% endblock %}

{% block content %}

{% for message in messages %}
    <div class="alert alert-{{ message.tags|lower }}">{{ message|safe }}</div>
{% endfor %}

<div class="row">
    <div class="col-lg-7">
        <form _class="form-inline" role="form" id="form-drill-delete" method="POST" autocomplete="off">
            {% csrf_token %}

            <div class="form-row">
                <div class="col-auto has-search">
                    <span class="fa fa-search form-control-feedback"></span>
                    <input id="search" name="search_term" type="text" style="width: 300px" class="form-control" placeholder="Search">
                </div>
            </div>

        </form>
    </div>
</div>

<div class="row">
    <div class="col-lg-12">
        {% include "common/datatable.html" with data=info cols=cols id="drill_list" %}
    </div>
</div>

{% endblock %}

{% block javascript %}

    {{ block.super }}

    <script src="https://use.fontawesome.com/4a95cb196f.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/typeahead.bundle.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs4/dt-1.10.20/sl-1.3.1/datatables.min.js"></script>

    <script type="text/javascript" charset="utf-8">

        var table;

        $(document).ready(function() {

            var myengine = new Bloodhound({
                remote: {
                    url: '{% url 'drill_tag_search' %}?term=%QUERY',
                    wildcard: '%QUERY'
                },
                datumTokenizer: function(d) { return Bloodhound.tokenizers.whitespace(d.val); },
                queryTokenizer: Bloodhound.tokenizers.whitespace,
                limit: 20
            });

            myengine.initialize();

            var template_source = $("#entry-template-what").html()

            $('#search').typeahead(
                {
                    hint: true,
                    highlight: true,
                    minLength: 3
                }, {
                    limit: 20,
                    display: 'value',
                    source: myengine,
                    templates: {
                        suggestion: function(data) {
                            return '<div class="tt-suggest-page">' + data.value + '</div>';
                        }
                    }
                }
            );

            $('#search').bind('typeahead:selected', function(obj, datum, name) {
                autocomplete_selected = true;
                window.location='{% url 'study_tag' 666 %}'.replace(/666$/, datum.value);
            });

            // This is set when an item from the autocomplete options is selected.  Otherwise there would be
            //  a race between the window.open() in $('#search').bind('typeahead:selected',...) and the form
            //  submission from the $('#search').on('keydown', ...)
            var autocomplete_selected = false;

            $('#search').on('keydown', function(event, selection) {
                if (((event.which && event.which == 13) || (event.keyCode && event.keyCode == 13)) && !autocomplete_selected) {
                    $("#form-drill-delete").attr('action', '{% url 'drill_search' %}');
                    $("#form-drill-delete").attr('method', 'GET');
                    $('#form-drill-delete').submit();
                    return false;
                } else {
                    return true;
                }
            });

            function formatName( data, type, row ) {
                return '<a href="{% url 'study_tag' 666 %}">'.replace(/666/, row[0]) + row[0] + '</a>';
            }

            table = $('#drill_list').DataTable( {
                initComplete: function () {
                    var api = this.api();
                    $('#drill_list').show();
                    api.columns.adjust();
                },
                "info": false,
                "paginate": false,
                "sorting": [[2, 'asc']],
                "filter": true,
                "language": {
                    "emptyTable": "No questions created"
                },
                "lengthChange": false,
                "dom": "<'row'<'col-lg-3'<'toolbar'>l>r>t<'row'<'float-right col-lg-4'p>>",
                "searchable": false,
                "columnDefs": [
                    { "targets": [0], "sorting": [ "desc", "asc" ], "render": formatName, "useRendered": false  },
                    { "targets": [2], "dataSort": 3 },
                    { "targets": [3,4], "visible": false },
                ],
            } );

        });

    </script>

{% endblock %}
