{% extends "base.html" %}

{% block title %} Notes {% endblock %}

{% block content %}

    <div class="scrollable-panel-container row no-gutters">

        <div id="left-panel" class="col-lg-3 h-100">

            <div v-if="pinnedNotes.length > 0" class="d-flex flex-column">
                <card title="Pinned Notes">

                    <template v-slot:title-slot>
                        <div class="h3">
                            Pinned Notes
                        </div>
                    </template>

                    <template v-slot:content>
                        <ul class="list-group">
                            <draggable v-model="pinnedNotes" @change="onChange" ghost-class="sortable-ghost">
                                <transition-group type="transition">
                                    <div v-for="note in pinnedNotes" :key="note.uuid" v-cloak>
                                        <li class="list-group-item list-group-item-secondary" :data-uuid="note.uuid">
                                            <a :href="note.url">[[ note.name ]]</a>
                                        </li>
                                    </div>
                                </transition-group>
                            </draggable>
                        </ul>
                        <div v-if="pinnedNotes.length === 0">
                            No notes found to pin.
                        </div>
                    </template>

                </card>
            </div>

            <div v-if="'{{ request.GET.search }}'" class="scrollable-panel-scrollbar-hover card-body d-flex flex-column h-100">

                <div class="h3 text-info">
                    {{ object_list.hits.hits|length }} Note{{ object_list.hits.hits|pluralize:"s" }} Found
                </div>

                <div class="d-flex flex-column">
                    <ul class="list-unstyled note-search-result">
                        <li v-for="note in $store.state.notes" class="px-2 py-3 d-flex flex-column" :class="{ 'selected': note.uuid === $store.state.selectedNoteUuid }" @click="onClick(note.uuid)">
                            <h4 class="text-primary font-weight-bold">
                                [[ note.name ]]
                            </h4>

                            <div class="search-result-date mb-1">
                                [[ note.date ]]
                            </div>

                            <div v-html="getContent(note)" class="note-content">
                            </div>

                            <div>
                                <span v-for="tag in note.tags" :key="tag.tag" class="tag mr-2">
                                    [[ tag.tag ]]
                                </span>
                            </div>
                        </li>
                    </ul>
                </div>

            </div>

        </div>

        <div id="right-panel" class="col-lg-9 h-100 scrollable-panel d-flex flex-column">

            <div v-for="(note,index) in $store.state.notes" :class="{ 'd-none': isSearch && note.uuid !== $store.state.selectedNoteUuid }" class="right-column">
                <div v-if="index === 0" class="mt-3 float-right" v-cloak>
                    <a class="btn btn-primary ml-2 mr-4 float-right right-column" href="{% url 'blob:create' %}?is_note=true">Add note</a>
                </div>

                <card :title="note.name">
                    <template v-slot:title-slot>
                        <h2>
                            <a :href="note.url" v-html="note.name"></a>
                        </h2>
                    </template>
                    <template v-slot:content>

                        <div class="blob-content table-borders">

                            <h6 class="text-primary" v-html="note.date">
                            </h6>

                            <div>
                                <div class="position-relative">
                                    <div :class="{ 'note-content-truncated': !isSearchResult }" class="mt-3" v-html="getContent(note.contents)" ref="note">
                                    </div>
                                </div>
                                <div class="text-center" ref="expander">
                                    <a class="text-primary" href="#" @click="expand(index)">—Expand—</a>
                                </div>
                            </div>
                            <span v-for="tag in note.tags" class="mr-2">
                                <a id="tag" class="tag" :href="tag.url" v-html="tag.tag"></a>
                            </span>
                        </div>

                    </template>
                </card>
            </div>

            <div v-if="$store.state.notes.length === 0" class="card-grid mr-2" v-cloak>
                <search-no-result class="ml-2">
                    <template v-slot:message>
                        No notes found matching search criteria.
                    </template>
                </search-no-result>

                <a class="btn btn-primary ml-2 mr-4 float-right right-column" href="{% url 'blob:create' %}?is_note=true">Add note</a>
            </div>

            <div v-else class="row">

                <div class="col-lg-12 card-grid ml-4">

                    <pagination
                        :paginator="paginator"
                        :num-objects="$store.state.notes.length"
                        {% if request.GET.tagsearch %}
                            search-args="&tagsearch={{ request.GET.tagsearch }}"
                        {% endif %}
                    >
                    </pagination>

                </div>

            </div>

        </div>

    </div>


{% endblock %}

{% block javascript %}

    {{ block.super }}

    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>

    <script type="text/javascript">

        window.MathJax = {
            tex: {
                inlineMath: [ ["\\(","\\)"], ["$$", "$$"] ],
                displayMath: [ ["\\[","\\]"] ],
                processEscapes: true,
                processEnvironments: true
            },
        };

        // Should match CSS class "note-content"
        const NOTE_MAX_HEIGHT = 500;

        Vue.mixin({ delimiters: ["[[", "]]"] });

        const store = new Vuex.Store({
            state: {
                notes: [
                    {% for note in object_list.hits.hits %}
                    {
                        "uuid": "{{ note.source.uuid }}",
                        "date": "{{ note.source.date }}",
                        "name": "{{ note.source.name|safe|default:'Note'|escapejs }}",
                        "contents": "{{ note.source.contents|escapejs }}",
                        "url": "{% url 'blob:detail' note.source.uuid %}",
                        "tags": [
                            {% for tag in note.source.tags %}
                            {
                                "tag": "{{ tag }}",
                                "url": "{% url 'search:notes' %}?tagsearch={{ tag }}"
                            },
                            {% endfor %}
                        ]
                    },
                    {% endfor %}
                ],
                selectedNoteUuid: null
            },
            getters: {},
            mutations: {},
        });

        new Vue({
            el: "#left-panel",
            name: "Left Panel",
            store,
            data: {
                pinnedNotes: [
                    {% for note in pinned_notes %}
                    {
                        url: "{% url 'blob:detail' '00000000-0000-0000-0000-000000000000' %}".replace(/00000000-0000-0000-0000-000000000000/, "{{ note.uuid }}"),
                        uuid: "{{ note.uuid }}",
                        name: "{{ note.name }}"
                    },
                    {% endfor %}
                ],
            },
            methods: {
                onChange(evt) {

                    note_uuid = evt.moved.element.uuid;

                    // The backend expects the ordering to begin
                    // with 1, not 0, so add 1.
                    new_position = evt.moved.newIndex + 1;

                    const bodyFormData = new URLSearchParams();
                    bodyFormData.append("note_uuid", note_uuid);
                    bodyFormData.append("new_position", new_position);

                    axios("{% url "accounts:sort_pinned_notes" %}", {
                        method: "POST",
                        data: bodyFormData,
                    }).then(response =>  {
                        console.log("Success:", response.data);
                    })
                      .catch((error) => {
                          this.$bvToast.toast(error, {
                              title: "Error",
                              noAutoHide: true,
                              variant: "danger"
                          })
                          console.error("Error:", error);
                      });
                },
                getContent(note) {
                    return markdown.render(note.contents.substring(0, 400)||"");
                },
                onClick(uuid) {
                    const found = this.$store.state.notes.find(element => element.uuid === uuid);
                    this.$store.state.selectedNoteUuid = found.uuid;

                },
            },
            mounted() {
                this.$store.state.selectedNoteUuid = this.$store.state.notes.length > 0 ? this.$store.state.notes[0].uuid : null;
            }
        });

        new Vue({
            el: "#right-panel",
            name: "Right Content Panel",
            store,
            components: {
                Pagination
            },
            data() {
                return {
                    paginator: JSON.parse("{{ paginator|escapejs }}"),
                    isSearchResult: {% if request.GET.search %}true{% else %}false{% endif %}
                }
            },
            methods: {
                getContent(content) {
                    return markdown.render(content);
                },
                getTagUrl(tag) {
                    return "{% url 'search:notes' %}?tagsearch=" + tag;
                },
                expand(index) {
                    this.$refs.note[index].style["max-height"] = "none";
                    this.$refs.note[index].classList.remove("fader");
                    this.$refs.expander[index].classList.add("d-none");
                }
            },
            computed: {
                isSearch() {
                    return {% if request.GET.search %}true{% else %}false{% endif %};
                }
            },
            mounted() {
                for (let [index, element] of this.$refs.note.entries()) {
                    if (element.clientHeight < NOTE_MAX_HEIGHT) {
                        this.$refs.expander[index].classList.add("d-none");
                   } else {
                       element.classList.add("fader");
                   }
                }
            }
        });

    </script>

{% endblock %}
