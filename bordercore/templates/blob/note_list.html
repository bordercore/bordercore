{% extends "base.html" %}

{% block title %} Notes {% endblock %}

{% block extra_head %}
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/smoke.min.css" />
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/code_style.css" />
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/tagsinput.css" />
{% endblock %}

{% block left-block %}

    <div class="h3">
        Favorite Notes
    </div>

    <ul class="list-group" id="sort-container-notes">
        {% for note in favorite_notes %}
            <li class="list-group-item" data-uuid="{{ note.uuid }}">
                <a href="{% url 'blob_detail' note.uuid %}">{{ note.title }}</a>
            </li>
        {% endfor %}
    </ul>

{% endblock %}

{% block content %}

    {% include "common/show_messages.html" with offset="0" width="12" %}

    <div class="row mb-3">
        <div class="col-lg-12">
            <form class="form-inline" name="nav_form" id="search-form" action="{% url 'notes_list' %}" method="get" autocomplete="off">
                <div class="form-row">
                    <div class="col-auto has-search">
                        <span class="fa fa-search form-control-feedback"></span>
                        <input class="form-control" id="search" type="text" name="search" value="{{ request.GET.search_item }}" accesskey="s" style="width: 300px" placeholder="Search"/>
                    </div>
                </div>
                <a class="btn btn-primary ml-2" href="{% url 'blob_add' %}?is_note=true">Add note</a>
            </form>
        </div>
    </div>

    {% if request.GET and not info %}
        <div class="alert alert-info">No notes found</div>
    {% endif %}

    <div class="row">
        <div class="col-lg-12">

            {% for note in info %}

                <div id="note">
                    <h2>
                        <a href="{% url 'blob_detail' note.uuid %}">{{ note.title|default:"Note Title" }}</a>
                    </h2>

                    <span class="glyphicon glyphicon-time"></span> <span class="muted"> {{ note.date }} </span>

                    <br /><br />

                    <div>
                        {{ note.content|safe }}
                    </div>

                    {% for tag in note.tags %}
                        <a id="tag" class="badge badge-primary" href="{% url 'notes_list' %}?tagsearch={{ tag }}">{{ tag }}</a>
                    {% endfor %}

                    <br /><br />
                </div>

            {% endfor %}

        </div>
    </div>

    {% if object_list and paginator.num_pages > 1 %}
        <nav class="mb-5 navigation">
            <ul class="pagination">
                <li class="page-item{% if not paginator.has_previous %} disabled{% endif %}">
                    <a class="page-link" href="?page={{ paginator.previous_page_number }}&tagsearch={{ request.GET.tagsearch }}&search={{ request.GET.search }}">Previous</a>
                </li>
                <li class="page-item disabled">
                    <span class="page-link ">
            Page <strong>{{ paginator.number }}</strong> of <strong>{{ paginator.num_pages }}</strong>
                    </span>
                </li>
                <li class="page-item{% if not paginator.has_next %} disabled{% endif %}">
                    <a class="page-link" href="?page={{ paginator.next_page_number }}&tagsearch={{ request.GET.tagsearch }}&search={{ request.GET.search }}">Next</a>
                </li>
            </ul>
        </nav>
    {% endif %}

{% endblock %}

{% block javascript %}

    {{ block.super }}

    <script src="https://use.fontawesome.com/4a95cb196f.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/smoke.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/jquery-ui.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/typeahead.bundle.min.js"></script>

    <script type="text/javascript">

        $(document).ready(function() {

            $('#sort-container-notes').sortable( {
                connectWith: '.list-group',

                // The 'Untagged' item is not sortable -- it's always on top
                items: "li:not(#untagged)",

                stop: function(event, ui) {

                    var note_uuid = $(ui.item).data("uuid");

                    $.ajax( {
                        type: 'POST',
                        url: '{% url 'sort_favorite_notes' %}',
                        data: {
                            note_uuid: note_uuid,
                            new_position: ui.item.index()
                        },
                        error: function (xhr, ajaxOptions, error) {
                            $.smkAlert({text: 'Error reordering tags: ' + error, type: 'error', position:'top-right'});
                        }
                    } );
                }
            })

            var engine = new Bloodhound({
                name: 'tags',
                remote: {
                    url: '{% url 'tag_search' %}?query=%QUERY' + '&type=note',
                    wildcard: '%QUERY'
                },
                datumTokenizer: function(d) { return Bloodhound.tokenizers.whitespace(d.val); },
                queryTokenizer: Bloodhound.tokenizers.whitespace
            });

            engine.initialize();

            $('#search').typeahead({
                minLength: 2
            }, {
                    display: 'value',
                    source: engine,
                    templates: {
                        suggestion: function(data) {
                            return '<div class="tt-suggest-page">' + data.value.replace(data._query, '<strong>' + data._query+ '</strong>') + '</div>';
                        }
                    }
                }
                                   );

            // This is set when an item from the autocomplete options is selected.  Otherwise there would be
            //  a race between the window.open() in $('#kbsearch').bind(...) and the form submission from the
            //  $('#kbsearch').on('keyup', ...)
            var autocomplete_selected = false;

            $('#search').on('keyup', function(event, selection) {
                if (((event.which && event.which == 13) || (event.keyCode && event.keyCode == 13)) && !autocomplete_selected) {
                    $('#search-form').submit();
                    return false;
                } else {
                    return true;
                }
            });

            $('#search').bind('typeahead:selected', function(obj, datum, name) {
                autocomplete_selected = true;
                window.location='{% url 'notes_list' %}?tagsearch=' + datum.value;
            });

        });

    </script>

{% endblock %}
