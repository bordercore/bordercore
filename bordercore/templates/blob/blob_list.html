{% extends "base.html" %}

{% load dict_get %}

{% block title %} Recent Blobs {% endblock %}

{% block content %}

    <div id="vue-app">

        {% include "common/show_messages.html" %}

        <div class="row card-grid">
            <div class="col-lg-12 d-flex">

                <h1>Recent Blobs</h1>

                <div class="mr-2 ml-auto">
                    <add-button url="{% url 'blob:create' %}">
                    </add-button>
                </div>

            </div>
        </div>

        <ul class="blob-list-nav list-group list-group-horizontal list-unstyled pl-5 ml-3">
            <li v-for="nav in navAll" v-if="nav === 'All' || doctypeCount(nav) > 0" class="px-5 m-3 mx-auto justify-content-center" v-bind:class="{ 'nav-selected': nav === navCurrent }" @click="onClick(nav)">
                <span class="text-center"><a href="#" v-cloak>[[ nav ]]</a></span><span class="ml-1 badge badge-info" v-html="doctypeCount(nav)"></span>
            </li>
        </ul>

        <div class="d-flex flex-row flex-wrap ml-3">
            <div v-for="blob in blobList" class="blob-list float-left mb-2 p-3 w-25" :data-doctype="blob.doctype">

                <div class="d-flex flex-column h-100">

                    <h5 class="text-center mb-2">
                        <a :href="blob.url" class="text-primary">[[ blob.name ]]</a>
                    </h5>

                    <a v-if="blob.cover_url" :href="blob.url"><img class="w-100" :src="blob.cover_url" /></a>

                    <div v-if="blob.doctype === 'note' || blob.doctype === 'document'" class="blob-content" v-html="getContent(blob)"></div>

                    <div class="blob-info d-flex justify-content-between mt-auto">
                        <div class="text-primary mr-auto">[[ getDeltaDays(blob.delta_days) ]]</div>
                        <div class="text-center">
                            <span v-if="blob.content_size !== '0 Bytes'">Size: <span class="text-primary">[[ blob.content_size ]]</span></span>
                        </div>
                    </div>

                </div>
            </div>

        </div>

    </div>


{% endblock %}

{% block javascript %}

    {{ block.super }}

    <script type="text/javascript">

        new Vue({
            el: "#vue-app",
            data() {
                return {
                    navAll: [
                        "All",
                        "Notes",
                        "Images",
                        "Documents",
                        "Blobs"
                    ],
                    navCurrent: "All",
                    blobList: [],
                    docTypes: {}
                }
            },
            methods: {
                getContent(blob) {
                    return markdown.render(blob.content);
                },
                getNormalizedDoctype(doctype) {
                    doctype = doctype.toLowerCase();

                    // Remove the trailing 's'
                    if (doctype !== "All") {
                        doctype = doctype.substring(0, doctype.length - 1)
                    }
                    return doctype;
                },
                doctypeCount(doctype) {
                    return this.docTypes[this.getNormalizedDoctype(doctype)]
                },
                getDeltaDays(delta) {

                    if (delta === 0) {
                        return "Today";
                    } else {
                        return delta + " " + pluralize("day", delta) + " ago";
                    }
                },
                onClick(doctype) {

                    this.navCurrent = doctype;

                    // Show everything
                    let objects = document.querySelectorAll("div.blob-list[data-doctype]");
                    objects.forEach(function(object) {
                        object.classList.remove("d-none");
                    })

                    if (doctype === "All") {
                        return;
                    }

                    doctype = this.getNormalizedDoctype(doctype);

                    objects = document.querySelectorAll(`div.blob-list:not([data-doctype = ${doctype}])`);

                    objects.forEach(function(object) {
                        object.classList.add("d-none");
                    })

                },
                getRecentBlobs() {
                    doGet(
                        this,
                        "{% url "blob:get_recent_blobs" %}",
                        (response) => {
                            this.blobList = response.data.blobList;
                            this.docTypes = response.data.docTypes;

                            this.$nextTick(() => {
                                document.querySelectorAll(".blob-content :is(h1, h2, h3, h4, h5, h6)").forEach((el) => {
                                    let style = window.getComputedStyle(el, null).getPropertyValue("font-size");
                                    let fontSize = parseFloat(style);
                                    // The 0.35 factor is based on scaling <h6> tags to 4px
                                    el.style.fontSize = 0.35 * fontSize + "px";
                                });
                            });

                        },
                        "Error getting note"
                    );
                },
            },
            mounted() {
                this.getRecentBlobs();
            }

        });

    </script>

{% endblock %}
