{% extends "base.html" %}

{% load dict_get %}

{% block title %} Recent Blobs {% endblock %}

{% block content %}

    <div id="vue-app">

        <div class="row card-grid">
            <div class="col-lg-12 d-flex">

                <h1>Recent Blobs</h1>

                <div class="me-2 ms-auto">
                    <add-button :href="'{% url 'blob:create' %}'">
                    </add-button>
                </div>

            </div>
        </div>

        <ul class="nav nav-tabs mx-3">
            <li v-for="nav in navAll" v-if="nav === 'All' || doctypeCount(nav) > 0" class="nav-item px-5" @click="onClickNav(nav)">
                <a class="nav-link" data-bs-toggle="tab" href="#" v-cloak>
                    [[ nav ]]
                    <span class="badge rounded-pill align-middle ms-2" v-html="doctypeCount(nav)"></span>
                </a>
            </li>
        </ul>

        <div class="d-flex flex-row flex-wrap ms-3">
            <div v-for="blob in blobList" class="blob-list float-start mb-2 p-3 w-25" @click="onClickBlob(blob.url)" :data-doctype="blob.doctype">

                <div class="d-flex flex-column h-100">

                    <h5 class="text-center mb-2">
                        <a :href="blob.url" class="text-primary">[[ blob.name ]]</a>
                    </h5>

                    <a v-if="blob.cover_url" :href="blob.url"><img class="w-100" :src="blob.cover_url" /></a>

                    <div v-if="blob.doctype === 'note' || blob.doctype === 'document'" class="blob-content" v-html="getContent(blob)"></div>

                    <div class="blob-info d-flex justify-content-between mt-auto">
                        <div class="text-primary me-auto">[[ getDeltaDays(blob.delta_days) ]]</div>
                        <div class="text-center">
                            <span v-if="blob.content_size !== '0 Bytes'">Size: <span class="text-primary">[[ blob.content_size ]]</span></span>
                        </div>
                    </div>

                </div>
            </div>
            <h3 v-if="message" class="text-danger mt-3" v-cloak>
                Elasticsearch Error: [[ message.statusCode ]]
            </h3>

        </div>

    </div>


{% endblock %}

{% block javascript %}

    {{ block.super }}

    <script type="text/javascript">

        new Vue({
            el: "#vue-app",
            data() {
                return {
                    navAll: [
                        "All",
                        "Notes",
                        "Images",
                        "Documents",
                        "Blobs"
                    ],
                    navCurrent: "All",
                    blobList: [],
                    docTypes: {},
                    message: null,
                }
            },
            methods: {
                getContent(blob) {
                    return markdown.render(blob.content||"");
                },
                getNormalizedDoctype(doctype) {
                    doctype = doctype.toLowerCase();

                    // Remove the trailing 's'
                    if (doctype !== "All") {
                        doctype = doctype.substring(0, doctype.length - 1)
                    }
                    return doctype;
                },
                doctypeCount(doctype) {
                    return this.docTypes[this.getNormalizedDoctype(doctype)]
                },
                getDeltaDays(delta) {

                    if (delta === 0) {
                        return "Today";
                    } else {
                        return delta + " " + pluralize("day", delta) + " ago";
                    }
                },
                onClickBlob(url) {
                    window.location = url;
                },
                onClickNav(doctype) {

                    this.navCurrent = doctype;

                    // Show everything
                    let objects = document.querySelectorAll("div.blob-list[data-doctype]");
                    objects.forEach(function(object) {
                        object.classList.remove("d-none");
                    })

                    if (doctype === "All") {
                        return;
                    }

                    doctype = this.getNormalizedDoctype(doctype);

                    objects = document.querySelectorAll(`div.blob-list:not([data-doctype = ${doctype}])`);

                    objects.forEach(function(object) {
                        object.classList.add("d-none");
                    })

                },
                getRecentBlobs() {
                    doGet(
                        this,
                        "{% url "blob:recent_blobs" %}",
                        (response) => {
                            this.blobList = response.data.blobList;
                            this.docTypes = response.data.docTypes;
                            this.message = response.data.message

                            this.$nextTick(() => {
                                document.querySelectorAll(".blob-content :is(h1, h2, h3, h4, h5, h6)").forEach((el) => {
                                    let style = window.getComputedStyle(el, null).getPropertyValue("font-size");
                                    let fontSize = parseFloat(style);
                                    // The 0.35 factor is based on scaling <h6> tags to 4px
                                    el.style.fontSize = 0.35 * fontSize + "px";
                                });
                            });

                        },
                        "Error getting recent blobs"
                    );
                },
            },
            mounted() {
                this.getRecentBlobs();

                // Select the first tab ("All") by default
                this.$el.querySelector(".nav li a").classList.add("active");
            }

        });

    </script>

{% endblock %}
