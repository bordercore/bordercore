{% extends "base.html" %}

{% load escape_characters %}

{% block extra_head %}
    <link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
{% endblock %}

{% block title %} KB :: Documents {% endblock %}

{% block left-block %}

    <div id="vue-app-left">

    {% if object %}

        {% if cover_info %}
            <img id="amazon-cover-image" src="{{ MEDIA_URL }}{{ cover_info.url }}" height="{{ cover_info.height_cropped }}" width="{{ cover_info.width_cropped }}" class="mw-100" />
            <br /><br />
        {% endif %}

    <div id="update-cover-div">
        <input id="update-cover" class="btn btn-secondary" type="button" value="Update Image" />
    </div>

    <div id="set-cover-div" class="hidden">
        <span id="progress" class="glyphicon glyphicon-refresh glyphicon-refresh-animate hidden"></span>
        <input id="next-cover" class="btn btn-secondary" type="button" value="Next Image" />
        <input id="set-cover" class="btn btn-primary" type="button" value="Set Image" />
        <span id="amazon-feedback"></span>
    </div>

    <br /><br />

    <div class="form-group">
        <div class="row">
            <div class="col-lg-7">
                <add-to-collection-dropdown></add-to-collection-dropdown>
            </div>
        </div>
    </div>

{% if object.get_collection_info %}
    <div class="form-group">
        <div class="row">
            <div class="col-lg-7">
                <remove-from-collection-dropdown></remove-from-collection-dropdown>
            </div>
        </div>
    </div>
{% endif %}

    </form>

    <form action="{% url 'blob_delete' object.uuid %}" method="post">
        {% csrf_token %}
        <input type="hidden" name="uuid" value="{{ object.uuid }}" />
        <button type="submit" class="btn btn-warning">
            <span class="glyphicon glyphicon-trash" aria-hidden="true"></span> Delete
        </button>
    </form>

    <hr/>

    {% endif %}

    <div class="row">
        <div class="col-lg-4 mt-3">
            <cleanup-filename-button></cleanup-filename-button>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-4 mt-3">
            <upper-case-first-button></upper-case-first-button>
        </div>
    </div>

    {% if collection_info %}
        <div>
            <br />
        Adding to collection <strong><a href="{% url 'collection_detail' collection_info.id %}">{{ collection_info.name }}</a></strong>
        </div>
    {% endif %}

    {% if linked_blob %}
        <br /><br />
Linking to <a href="{% url 'blob_detail' linked_blob.uuid %}">{{ linked_blob.title|default:"Blob" }}</a>
    {% endif %}
    {% if linked_collection_blob_list %}
        <br /><br />
        <div style="font-size: 18px; margin-bottom: 10px">Linking to a collection with these blobs: </div>
        <ul class="list-group">
            {% for blob in linked_collection_blob_list %}
                <li class="list-group-item">
                    <a href="{% url 'blob_detail' blob.uuid %}">{{ blob.title|default:"No Title" }}</a>
                </li>
        {% endfor %}
    {% endif %}

</div>

{% endblock %}

{% block content %}

{% if object %}
<div class="row">
    <div class="col-lg-12">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'blob_detail' object.uuid %}">Blob Detail</a></li>
            <li class="breadcrumb-item active">Edit Blob</li>
        </ol>
    </div>
</div>
{% endif %}

{% if form.errors %}
    <div class="row">
        <div class="col-lg-10 offset-lg-2">
            {% for field,error in form.errors.items %}
                <div class="alert alert-danger">{{ error }}</div>
            {% endfor %}
        </div>
    </div>
{% endif %}

<div class="row" id="vue-app-right">
    <div class="col-lg-12">

<form id="form-blob" action="{{ request.path }}" method="post" enctype="multipart/form-data">
    <input type="hidden" name="metadata" id="input-metadata" />
    <input type="hidden" name="linked_blob" value="{{ linked_blob.id }}" />
    <input type="hidden" name="linked_collection" value="{{ linked_collection_info.id }}" />
    {% if collection_info %}
        <input type="hidden" name="collection_id" value="{{ collection_info.id }}" />
    {% endif %}
    {% csrf_token %}

    {% for field in form.visible_fields %}
        {% if field.label != 'Filename' and field.name != 'is_private' and field.name != 'is_note' %}
        <div class="form-group{% if field.errors %}error{% endif %} row">
            <label class="bold col-lg-2 col-sm-2 col-form-label text-right" for="inputTitle">{{ field.label }}</label>

            {% if field.label == 'File' %}

                <file-upload></file-upload>

            {% elif field.label == 'Date' %}

                <date-input></date-input>

            {% elif field.label == 'Content' %}

                <content-text-area></content-text-area>

            {% elif field.label == 'Tags' %}

                <tags-input></tags-input>

            {% else %}
                <div class="col-lg-10 col-sm-10 align-self-center">
                    {{ field }}
                </div>
            {% endif %}

        </div>

        {% endif %}
    {% endfor %}

    <div class="row form-group offset-lg-2 form-inline {% if field.errors %}error{% endif %}">

        <div class="col-lg-3 form-group">
            <div class="form-check">
                <label class="form-check-label bold">Is note</label>
                <input class="form-control form-check-input ml-3" type="checkbox"{% if form.is_note.value == True %} checked="checked"{% endif %} name="is_note" id="id_is_note" />
            </div>
        </div>

        <div class="col-lg-3 form-group">
            <div class="form-check">
                <label class="form-check-label bold">Is private</label>
                <input class="form-control form-check-input ml-3" type="checkbox"{% if is_private %} checked="checked"{% endif %} name="is_private" id="id_is_private" />
            </div>
        </div>

        <div class="col-lg-3 form-group">
            <div class="form-check">
                <label class="form-check-label bold">Is book</label>
                <input class="form-check-input ml-3" type="checkbox"{% if is_book %} checked="checked"{% endif %} name="is_book" id="id_is_book" />
            </div>
        </div>

    </div>

    <metadata-wrapper></metadata-wrapper>

    <div class="form-group">
        <div class="col-lg-3 offset-lg-2">
            <input class="btn btn-primary btn-lg" type="submit" name="Go" value="{{ action }}" />
        </div>
    </div>

</form>

    </div>
</div>

{% endblock %}

{% block javascript %}

    {{ block.super }}

    {{ tags|json_script:"initial-tags"|default:"" }}

    <script type="text/javascript" src="https://unpkg.com/@johmun/vue-tags-input/dist/vue-tags-input.js"></script>
    <script type="text/javascript" src="https://unpkg.com/vue-simple-suggest@1.10.1"></script>
    <script src="https://unpkg.com/vuejs-datepicker"></script>

    <!-- Use date-fns.js for date formatting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/1.9.0/date_fns.min.js"></script>

    <script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>

    <script type="text/javascript">

        function formatName(match, capture1, capture2) {
            return capture2 ? capture1 + capture2.toUpperCase() : match.toUpperCase();
        }

        function mutateCollection(collection_id, mutation_type) {

            const data = new URLSearchParams();
            data.append("blob_id", {{ object.id }});
            data.append("collection_id", collection_id);
            data.append("mutation", mutation_type);

            fetch("{% url "collection_mutate" %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: data,
            }).then(response => response.json())
              .then(data => {
                  console.log("Success:", data);
              })
              .catch((error) => {
                  console.error("Error:", error);
                  $.smkAlert({text: "Error during collection mutation: " + error, type: "error", position:"top-right"});
              });

        }

        var isExpanded = false;

        var metadata_count = {{ metadata|length }};

        Vue.mixin({ delimiters: ["[[", "]]"] });

        const AddToCollectionDropdown = {
            template: `
                <select class="form-control" @change="onChange">
                    <option>Add to collection</option>
                    <option v-for="c in collection_list" :value="c.id">[[ c.name ]]</option>
                </select>
            `,
            data() {
                return {
                    collection_list: [
                        {% for collection in collections_other %}
                        {
                            id: "{{ collection.id }}",
                            name: "{{ collection.name }}"
                        },
                        {% endfor %}
                    ]
                }
            },
            methods: {
                onChange(evt) {
                    mutateCollection(this.$el.value, "add");
                }
            }
        }

        {% if object and object.get_collection_info %}
        const RemoveFromCollectionDropdown = {
            template: `
                <select class="form-control" @change="onChange">
                    <option>Remove from collection</option>
                    <option v-for="c in collection_list" :value="c.id">[[ c.name ]]</option>
                </select>
            `,
            data() {
                return {
                    collection_list: [
                        {% for collection in object.get_collection_info %}
                        {
                            id: "{{ collection.id }}",
                            name: "{{ collection.name }}"
                        },
                        {% endfor %}
                    ]
                }
            },
            methods: {
                onChange(evt) {
                    mutateCollection(this.$el.value, "delete");
                }
            }
        }
        {% endif %}

        const CleanupFilenameButton = {
            template: '<input type="button" class="btn btn-secondary" value="Cleanup Filename" @click="onClick" />',
            methods: {
                async onClick(evt) {
                    var title = document.getElementById("id_title").value;
                    if (title) {
                        var fileNameEl = document.getElementById("id_filename");
                        var fileName = fileNameEl.value;
                        var match = /(.*)(\..*?)$/.exec(fileName);
                        if (match) {
                            fileNameEl.value = title + match[2];
                            fileNameEl.classList.add("highlight-changed-field");
                            await new Promise(r => setTimeout(r, 2000));
                            fileNameEl.classList.add("color-transition");
                        }
                    }
                }
            }
        }

        const UpperCaseFirstButton = {
            template: '<input type="button" class="btn btn-secondary" value="Upper Case First" @click="onClick" />',
            methods: {
                async onClick(evt) {

                    // Transforms 'JERRELL SCHIVERS' to 'Jerrell Schivers'
                    var nameEl = document.getElementById("id_value")
                    nameEl.value = nameEl.value.toLowerCase().replace(/(\s+)(.)|^(.)/g, formatName)

                    nameEl.classList.add("highlight-changed-field");
                    await new Promise(r => setTimeout(r, 2000));
                    nameEl.classList.add("color-transition");

                }
            },
        };

        const FileUpload = {
            template: `
                <div class="col-lg-4 input-group">
                    <input type="text" name="filename" :value="filename" class="form-control" id="id_filename" />
                    <input type="hidden" name="file_modified" :value="lastModified" />
                    <span class="input-group-append">
                        <label class="btn btn-primary">Choose file
                            <input type="file" name="file" id="id_file" hidden @change="onChange" />
                        </label>
                    </span>
                </div>
            `,
            data() {
                return {
                    filename: "{{ form.filename.value|default:"" }}",
                    lastModified: null
                }
            },
            methods: {
                onChange(evt) {
                    this.filename = evt.target.files[0].name;
                    this.lastModified = evt.target.files[0].lastModified;
                }
            }
        }

        const noDelimiter = {replace: function(){}};

        const ContentTextArea = {
            delimiters: [noDelimiter, noDelimiter],
            template: `
                <div class="col-lg-10 col-sm-10 align-self-center">
                    <textarea name="content" cols="40" rows="5" class="form-control" id="id_content" @focus="onFocus">{{ form.content.value|escape_characters }}</textarea>
                </div>
            `,
            methods: {
                onFocus(evt) {
                    // Expand the content for editing, but only do it once.
                    if (! isExpanded) {
                        document.getElementById("id_content").classList.add("foobar");
                        /* $("#id_content").animate({ height: "30em" }, 500); */
                        isExpanded = true;
                    }
                }
            }
        }

        const DateInput = {
            template: `
                <div class="col-lg-2 input-group">
                    <div id="dateapp">
                        <vuejs-datepicker
                            :bootstrap-styling="true"
                            :format="customFormatter"
                            :typeable="true"
                            :value="date"
                              name="date"
                              id="id_date"
                            >
                            <span slot="afterDateInput" class="input-group-append">
                                <div class="input-group-text">
                                    <img src="{{ STATIC_URL }}img/calendar-icon.png" width="16" height="16" />
                                </div>
                            </span>
                        </vuejs-datepicker>
                    </div>
                    <div class="col-lg-3 align-self-center form-error" id="date-response"></div>
                </div>
            `,
            data() {
                return {
                    {% if not object or form.date.value == "" %}
                    date: new Date()
                    {% else %}
                    date: new Date("{{ form.date.value }}")
                    {% endif %}
                }
            },
            components: {
                vuejsDatepicker
            },
            methods: {
                customFormatter(date) {
                    return dateFns.format(new Date(date), "YYYY-MM-DD")
                },
                handlePaste(evt) {
                    dateResponseEl = document.getElementById("date-response");
                    dateResponseEl.innerHTML = "";

                    var clipText = encodeURIComponent(evt.clipboardData.getData("Text").trim());

                    fetch("{% url "parse_date" 666 %}".replace(/666$/, clipText))
                        .then(response => {
                            var payLoad = response.json();
                            if (payLoad.output_date == "") {
                                var errorString = "Invalid date format";
                                console.error(errorString + " :" + json.error);
                                dateResponseEl.innerHTML = errorString;
                                throw Error(errorString);
                            } else {
                                return payLoad;
                            }
                        }).then(data => {
                            console.log("Success:", data);
                            this.date = new Date(data.output_date);
                        })
                }
            },
            mounted() {
                // Set timezone
                this.date.setTime( this.date.getTime() + this.date.getTimezoneOffset()*60*1000 );

                document.getElementById("id_date").addEventListener("paste", this.handlePaste);
            }
        }

        const MetadataList = {
            template: `
                <div>
                    <div v-for="m in metadata">
                        <div class="form-group row">
                            <label class="bold col-lg-2 col-sm-2 col-form-label text-right" for="inputTitle">[[ m.name ]]</label>
                            <div class="col-lg-10 col-sm-10">
                                <div class="col-lg-10 input-group">
                                    <input type="text" :name="m.counter + '_' + m.name" :value="m.value" class="form-control" autocomplete="off" />
                                    <span class="input-group-append">
                                        <button class="btn btn-danger btn-remove" type="button" @click="$emit('delete', m.counter)">
                                            <span class="glyphicon glyphicon-minus"></span>
                                        </button>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            `,
            props: ['metadata']
        }

        const SimpleSuggest = {
            template: `
                <vue-simple-suggest ref="suggestComponent"
                    id="id_name"
                    v-model="query"
                    display-attribute="value"
                    value-attribute="value"
                    :list="metadataSearch"
                    :filter-by-query=true
                    :debounce=200
                    placeholder="New Metadata Name"
                    autofocus
                    autocomplete="off"
                    :styles="autoCompleteStyle"
                    @select="select"
                    >
                </vue-simple-suggest>
            `,
            data() {
                return {
                    query: "",
                    autoCompleteStyle: {
                        vueSimpleSuggest: "position-relative",
                        inputWrapper: "",
                        defaultInput: "form-control search-box-input",
                        suggestions: "position-absolute list-group z-1000",
                        suggestItem: "list-group-item"
                    }
                }
            },
            methods: {
                metadataSearch(query) {
                    return fetch("{% url 'metadata_name_search' %}?query=" + query)
                        .then(response => {
                            return response.json();
                        })
                        .then(data => data)
                },
                select(datum) {
                    document.getElementById("id_value").focus();
                }
            }
        }

        const AddMetadataButton = {
            template: `<button class="btn btn-success" type="button" @click="onClick">
                <span class="glyphicon glyphicon-plus"></span>
            </button>
            `,
            methods: {
                onClick(evt) {
                    this.$emit("add-metadata");
                    this.$nextTick(() => {
                        this.$parent.$refs.simpleSuggest.$refs.suggestComponent.$el.querySelector("input").blur();
                        this.$parent.$refs.simpleSuggest.$refs.suggestComponent.setText("");
                    });
                    this.$parent.$refs.simpleSuggest.$refs.suggestComponent.input.focus();
                }
            }
        }

        const MetadataInput = {
            template: '<input type="text" id="id_value" class="form-control" placeholder="New Metadata Value" autocomplete="off" @keydown.enter.prevent="onKeyDown" />',
            methods: {
                onKeyDown(evt) {
                    this.$emit("add-metadata");
                    this.$nextTick(() => {
                        this.$parent.$refs.simpleSuggest.$refs.suggestComponent.$el.querySelector("input").blur();
                        this.$parent.$refs.simpleSuggest.$refs.suggestComponent.setText("");
                    });
                    this.$parent.$refs.simpleSuggest.$refs.suggestComponent.input.focus();
                    /* document.getElementById("id_name").focus(); */
                }
            }
        };

        const MetadataWrapper = {
            template: `
                <div>
                    <div class="form-group row">

                        <div class="col-lg-2 col-sm-2">
                            <simple-suggest ref="simpleSuggest"></simple-suggest>
                        </div>

                        <div class="col-lg-10 col-sm-10">
                            <div class="col-lg-10 input-group">
                                <metadata-input @add-metadata=addMetadata></metadata-input>
                                <span class="input-group-append">
                                    <add-metadata-button @add-metadata=addMetadata></add-metadata-button>
                                </span>
                            </div>
                        </div>

                    </div>

                    <metadata-list
                        :metadata="metadata"
                        @delete=deleteMetadata
                        ></metadata-list>

                </div>
            `,
            data() {
                return {
                    metadata: [
                        {% for m in metadata %}
                        {
                            name: "{{ m.name }}",
                            value: "{{ m.value }}",
                            counter: {{ forloop.counter }}
                        },
                        {% endfor %}
                    ]
                }
            },
            methods: {
                addMetadata(payload) {
                    metadata_count++;

                    nameEl = document.getElementById("id_name");
                    valueEl = document.getElementById("id_value");

                    if (nameEl.value == "" || valueEl.value == "") {
                        /* this.$parent.$refs.simpleSuggest.$refs.suggestComponent.input.focus(); */
                        /* document.getElementById("id_name").focus(); */
                        /* this.$refs.simpleSuggest.$refs.suggestComponent.$refs.inputSlot.inputElement.focus(); */
                        this.$refs.simpleSuggest.$refs.suggestComponent.$refs.inputSlot.focus();

                        return;
                    }

                    payload = {
                        name: nameEl.value,
                        value: valueEl.value,
                        counter: metadata_count
                    }

                    nameEl.value = "";
                    valueEl.value = "";

                    this.metadata.unshift(payload);

                },
                deleteMetadata(counter) {
                    for (i = 0; i < this.metadata.length; i++) {
                        if (this.metadata[i].counter == counter) {
                            this.metadata.splice(i, 1);
                        }
                    }
                }
            },
            components: {
                AddMetadataButton,
                MetadataInput,
                MetadataList,
                SimpleSuggest
            }
        };

        const TagsInput = {
            template: `<div class="col-lg-10 col-sm-10">
                <vue-tags-input
                    ref="tagsInputComponent"
                    v-model="tag"
                    :tags="tags"
                    @tags-changed="newTags => tags = newTags"
                    :autocomplete-items="filteredItems"
                    :add-only-from-autocomplete="false"
                    placeholder=""
                />
                    <input type="hidden" name="tags" :value="tagsCommaSeparated" />
            </div>`,
            data() {
                return {
                    tag: "",
                    tags: [],
                    autocompleteItems: [],
                }
            },
            watch: {
                "tag": "initItems",
            },
            methods: {
                initItems() {

                    // Set a minimum character count to trigger the ajax call
                    if (this.tag.length < 3) return;

                    return fetch("{% url 'tag_search' %}?query=" + this.tag)
                        .then(response => {
                            return response.json();
                        })
                        .then(data => {
                            this.autocompleteItems = data.map(a => {
                                return { text: a.value };
                            }
                            )
                        })
                }
            },
            mounted() {
                initialTags = JSON.parse(document.getElementById("initial-tags").textContent);
                if (initialTags) {
                    this.tags = initialTags;
                }
            },
            computed: {
                tagsCommaSeparated: function() {
                    return this.tags.map(x => x.text).join(",")
                },
                filteredItems() {
                    return this.autocompleteItems.filter(i => {
                        return i.text.toLowerCase().indexOf(this.tag.toLowerCase()) !== -1;
                    });
                }
            }
        }

        new Vue({
            el: "#vue-app-left",
            components: {
                AddToCollectionDropdown,
                {% if object and object.get_collection_info %}
                RemoveFromCollectionDropdown,
                {% endif %}
                CleanupFilenameButton,
                UpperCaseFirstButton
            }
        });

        new Vue({
            el: "#vue-app-right",
            components: {
                FileUpload,
                DateInput,
                ContentTextArea,
                MetadataWrapper,
                SimpleSuggest,
                TagsInput
            }
        });

        var easyMDE = new EasyMDE({
            element: document.getElementById("id_content"),
            toolbar: [
                "bold",
                "italic",
                "heading",
                "|",
                "quote",
                "unordered-list",
                "ordered-list",
                {
                    name: "table",
                    action: function customFunction(editor) {
                        editor.codemirror.replaceSelection("\nFirst Header  | Second Header\n------------- | -------------\nContent Cell  | Content Cell\nContent Cell  | Content Cell\n");
                    },
                    className: "fa fa-table",
                    title: "Insert Table"
                },
                "|",
                "link",
                "code",
                {
                    name: "code-block",
                    action: function customFunction(editor) {

                        replacedText = editor.codemirror.getSelection().replace(/\n/g, "\n    ").replace(/>/g, "&gt;");

                        editor.codemirror.replaceSelection("    " + replacedText);

                    },
                    className: "fa fa-indent",
                    title: "Code Block",
                },
                {
                    name: "escape-html",
                    action: function customFunction(editor) {

                        replacedText = editor.codemirror.getSelection().replace(/</g, "&lt;").replace(/>/g, "&gt;");

                        editor.codemirror.replaceSelection(replacedText);

                    },
                    className: "fa fa-html5",
                    title: "Escape HTML",
                },
                "|",
                "preview",
                "side-by-side",
                "fullscreen",
            ]
        });

    </script>

    <script type="text/javascript">

        $(document).ready(function() {

            {% for tag in linked_blob.tags.all %}
            $("#id_tags").tagsinput("add", {value: "{{ tag.name }}", name: "{{ tag.name }}", is_meta: {{ tag.is_meta|lower}}});
            {% endfor %}

            {% for tag in linked_collection_blob_list.0.tags.all %}
            $("#id_tags").tagsinput("add", {value: "{{ tag.name }}", name: "{{ tag.name }}", is_meta: {{ tag.is_meta|lower}}});
            {% endfor %}

        });

    </script>

{% endblock %}
