{% extends "base.html" %}

{% load is_in_group %}
{% load dict_get %}

{% block title %} Blob :: Detail {% endblock %}

{% block content %}

    <div class="scrollable-panel-container row g-0">

        <div class="col-lg-3 h-100 d-flex flex-column">
            <div id="vue-left-panel" class="scrollable-panel card-body d-flex flex-column h-100">
                <div v-cloak>

                    <h5>
                        {{ blob.get_edition_string }}
                    </h5>

                    {% if metadata|dict_get:"Subtitle" %}
                        <div id="blob_subtitle">
                            {{ metadata|dict_get:"Subtitle" }}
                        </div>
                    {% endif %}

                    {% if metadata|dict_get:"Author" %}
                        <div class="mt-2">
                            by <span class="text-info">{{ metadata|dict_get:"Author" }}</span>
                        </div>
                    {% endif %}

                    {% if date %}
                        <div class="mb-2">
                            {{ date }}
                        </div>
                    {% endif  %}

                    {% if blob.tags.all %}
                    <div class="d-flex">
                        <div>
                            <font-awesome-icon icon="tags" class="text-primary"></font-awesome-icon>
                        </div>
                        <div class="ms-2">
                            <div id="blob-tag-list">
                            {% for tag in blob.tags.all %}
                                <a class="tag" href="{% url 'search:kb_search_tag_detail' tag.name %}">{{ tag.name }}</a>
                            {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if urls %}
                        <div class="mb-3">
                            <font-awesome-icon icon="link" class="text-primary me-1"></font-awesome-icon>
                            {% for url in urls %}
                                <strong><a href="{{ url.url }}">{{ url.domain }}</a></strong>
                            {% endfor %}
                        </div>
                    {% endif %}

                    {% if show_metadata %}

                    <transition name="fade">
                        <div v-if="Object.keys($store.state.elasticsearchInfo).length !== 0 || Object.keys(metadata_misc).length !== 0" class="highlight-box mb-3">

                            <div v-for="(value, name) in metadata_misc" class="d-flex">
                                <div class="text-info me-2">
                                    [[ name ]]
                                </div>
                                <div>
                                    [[ value ]]
                                </div>
                            </div>

                            <div v-if="$store.state.elasticsearchInfo.content_type" class="d-flex">
                                <div class="text-info me-2">
                                    Object Type
                                </div>
                                <div>
                                    [[ $store.state.elasticsearchInfo.content_type ]]
                                </div>
                            </div>

                            <div v-if="$store.state.elasticsearchInfo.size" class="d-flex">
                                <div class="text-info me-2">
                                    Size
                                </div>
                                <div>
                                    [[ $store.state.elasticsearchInfo.size ]]
                                </div>
                            </div>

                            <div v-if="$store.state.elasticsearchInfo.num_pages" class="d-flex">
                                <div class="text-info me-2">
                                    Pages
                                </div>
                                <div>
                                    [[ $store.state.elasticsearchInfo.num_pages ]]
                                </div>
                            </div>

                            <div v-if="$store.state.elasticsearchInfo.duration" class="d-flex">
                                <div class="text-info me-2">
                                    Duration
                                </div>
                                <div>
                                    [[ $store.state.elasticsearchInfo.duration ]]
                                </div>
                            </div>

                        </div>
                    </transition>

                    {% endif %}

                    {% if blob.note %}
                        <div class="highlight-box mt-3 text-break" id="blob-note" v-html="getNote()">
                        </div>
                    {% endif %}

                    {% if blob.is_note and blob.has_been_modified %}
                        <div class="mt-3">
                            <strong>Last edited</strong>
                            <small>{{ blob.modified|date:"F j, Y" }}</small>
                        </div>
                    {% endif %}

                    <div v-if="tree['nodes'].length > 0" class="mt-3 p-2 tree-menu highlight-box">
                        <tree-menu
                            class="item"
                            :item="tree"
                            :depth="0"
                        ></tree-menu>
                    </div>

                    {% if linked_blobs %}
                        <h4 class="mt-3">
                            Collections
                        </h4>
                        {% for collection in linked_blobs %}
                            {{ collection.name }}
                            <ul class="list-group">
                            {% for blob in collection.blob_list %}
                                <li class="list-group-item list-group-item-secondary text-info d-flex align-items-center border-bottom-0">
                                {% if blob.get_cover_url_small %}
                                    <img src="{{ blob.get_cover_url_small }}" />
                                {% endif %}
                                    <div class="ms-2">
                                        <a href="{% url 'blob:detail' blob.uuid %}">{{ blob.name|default:"No Name" }}</a>
                                    </div>
                                </li>
                            {% endfor %}
                            <li class="list-group-item list-group-item-secondary text-info">
                                <a class="btn btn-primary" href="{% url 'blob:create' %}?linked_collection={{ collection.uuid }}">Add to Collection</a>
                            </li>
                            </ul>
                        {% endfor %}
                    {% endif %}

                    <div v-if="$store.state.collectionList.length > 0" class="row mt-3">
                        <div class="col-lg-12">
                            In collections:

                            <a v-for="(collection, index) in $store.state.collectionList" :href="collection.url">
                                [[ collection.name ]]<span v-if="index !== $store.state.collectionList.length - 1">, </span>
                            </a>
                        </div>
                    </div>

                    {% if blob.sha1sum %}
                        <a class="button-icon mt-3" href="{{ MEDIA_URL }}blobs/{{ blob.get_url|safe }}" role="button">
                            <font-awesome-icon icon="download" class="text-emphasis" />
                        </a>
                    {% endif %}

                    <related-bookmarks-list
                        ref="relatedBookmarksList"
                        object-uuid="{{ object.uuid }}"
                        model-name="blob.Blob"
                        get-bookmark-list-url="{% url 'bookmark:get_related_bookmark_list' object.uuid %}?model_name=blob.Blob"
                        create-bookmark-url="{% url 'bookmark-list' %}"
                        search-bookmark-url="{% url 'bookmark:search' %}"
                        get-title-from-url-url="{% url 'drill:get_title_from_url' %}"
                        add-bookmark-url="{% url 'bookmark:add_related_bookmark' %}"
                        remove-bookmark-url="{% url 'bookmark:remove_related_bookmark' %}"
                        sort-bookmark-list-url="{% url 'bookmark:sort_related_bookmarks' %}"
                        edit-bookmark-note-url="{% url 'bookmark:edit_related_bookmark_note' %}"
                        :show-add-button="false"
                        extra-class="embedded-card mt-3"
                        :show-empty-list="false"
                    >
                    </related-bookmarks-list>

                    <card v-if="relatedBlobList.length > 0" class="ms-0">
                        <template #title-slot>
                            Related Blobs
                        </template>
                        <template #content>
                            <div v-for="blob in relatedBlobList" class="hover-target hoverable d-flex align-items-center mb-2 p-2">
                                <img :src="blob.cover_url" />
                                <div class="d-flex justify-content-center ms-2 w-100">
                                    <a :href="blob.url">[[ blob.name ]]</a>
                                </div>

                                <drop-down-menu :show-on-hover="true">
                                    <div slot="dropdown">
                                        <li>
                                            <a class="dropdown-item" href="#" @click.prevent="unlinkBlob(blob.uuid)">Unlink</a>
                                        </li>
                                    </div>
                                </drop-down-menu>

                            </div>
                        </template>
                    </card>

                </div>

                <div v-if="related_questions.length > 0" v-cloak>

                    <hr class="filter-divider w-100 mt-0" />

                    <div class="card-title">
                        Related Questions
                    </div>

                    <div class="cursor-pointer">
                        <ul class="list-group interior-borders">
                            <li v-for="question in related_questions" class="hoverable px-0 list-group-item list-group-item-secondary text-primary">
                                <div class="d-flex">
                                    <div class="mt-1 me-2">
                                        <font-awesome-icon icon="question" class="text-success"></font-awesome-icon>
                                    </div>
                                    <div>
                                        <span v-html="question.question" @click="onClick(question.url)"></span>
                                        <div>
                                            <span v-for="tag in question.tags" class="badge bg-info me-2">[[ tag.tag ]]</span>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>

                </div>

            </div>

        </div> <!-- End first column -->

        <div class="col-lg-9 h-100 overflow-auto" id="vue-right-panel">

            <blob-select
                ref="blobSelect"
                search-blob-url="{% url 'search:search_names' %}?doc_type=blob,book,document,note"
                recent-blobs-url="{% url 'blob:recent_blobs' %}"
                @select-blob="selectBlob"
            >
            </blob-select>

            <div class="col-lg-12 px-3">

                <div class="d-flex">
                    <h2 id="blob-name" class="p-2 mb-3 text-break w-100">
                        {{ name }}
                    </h2>
                    <hr />
                    <drop-down-menu v-cloak>
                        <div slot="dropdown" class="mt-0">
                            <li>
                                <a class="dropdown-item" href="{% url 'blob:update' blob.uuid %}">
                                    <span>
                                        <font-awesome-icon icon="pencil-alt" class="text-primary me-3"></font-awesome-icon>Update
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" @click.prevent="handleAddToCollection()">
                                    <span>
                                        <font-awesome-icon icon="plus" class="text-primary me-3"></font-awesome-icon>Add to Collection
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'blob:create' %}?linked_blob_uuid={{ blob.uuid }}">
                                    <span>
                                        <font-awesome-icon icon="file-alt" class="text-primary me-3"></font-awesome-icon>Link to New Blob
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" @click.prevent="handleLinkToExistingBlob()">
                                    <span>
                                        <font-awesome-icon icon="file-alt" class="text-primary me-3"></font-awesome-icon>Link to Existing Blob
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" @click.prevent="handleLinkToBookmark()">
                                    <span>
                                        <font-awesome-icon icon="link" class="text-primary me-3"></font-awesome-icon>Link to Bookmark
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'blob:clone' blob.uuid %}">
                                    <span>
                                        <font-awesome-icon icon="clone" class="text-primary me-3"></font-awesome-icon>Clone Blob
                                    </span>
                                </a>
                            </li>
                            {% if blob.is_note %}
                                <li>
                                    <a class="dropdown-item" href="#" @click.prevent="onClick">
                                        <span>
                                            <font-awesome-icon icon="thumbtack" class="text-primary me-3"></font-awesome-icon>[[ pinnedButtonValue ]]
                                        </span>
                                    </a>
                                </li>
                            {% endif %}
                            {% if blob.sha1sum and request.user|is_in_group:"Admin" %}
                                <li>
                                    <a class="dropdown-item" href="#" @click.prevent="handleCopySha1sum('{{ blob.sha1sum }}')">
                                        <span>
                                            <font-awesome-icon icon="copy" class="text-primary me-3"></font-awesome-icon>Copy Sha1sum
                                        </span>
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{{ aws_url }}">
                                        <span>
                                            <font-awesome-icon :icon="[ 'fab', 'aws' ]" class="text-primary me-3"></font-awesome-icon>S3 Link
                                        </span>
                                    </a>
                                </li>
                            {% endif %}
                        </div>
                    </drop-down-menu>
                </div>

                {% if blob.is_video %}
                <div v-cloak>
                    <video class="h-100 w-100" controls muted>
                        <source src="{{ MEDIA_URL }}blobs/{{ blob.get_url|safe }}" type="video/mp4">
                    </video>
                </div>
                {% elif blob.sha1sum and not blob.is_audio %}
                <blob-detail-cover
                    cover-url="{{ blob.get_cover_url }}?nodefault=1"
                    {% if blob.content %}
                        :full-size="false"
                    {% endif %}
                >
                </blob-detail-cover>
                {% endif %}

                <audio v-if="$store.state.elasticsearchInfo.content_type === 'Audio'" controls controlsList="nodownload" v-cloak>
                    <source src="{{ MEDIA_URL }}blobs/{{ blob.get_url|safe }}" type="audio/mpeg">
                    Your browser does not support the audio tag.
                </audio>

                {% if blob.content %}
                    <div class="blob-content table-borders" id="blob-detail-content" v-html="getContent()">
                    </div>
                {% endif %}

                <add-to-collection
                    ref="addToCollection"
                    blob-uuid="{{ blob.uuid }}"
                    search-url="{% url 'collection:search' %}?exclude_blob_uuid={{ blob.uuid }}&query="
                    collection-mutate-url="{% url 'blob:collection_mutate' %}"
                    add-collection-url="{% url 'collection-list' %}"
                    @add-to-collection="getCollectionList"
                >
                </add-to-collection>

            </div>

        </div>

    </div>

{% endblock %}

{% block javascript %}

    {{ block.super }}

    {% if blob.math_support %}
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
    {% endif %}

    <script type="text/javascript">

        const store = new Vuex.Store({
            state: {
                elasticsearchInfo: {{ elasticsearch_info|safe|default:"{}" }},
                collectionList: [
                    {% for collection in collection_list %}
                    {
                        "uuid": "{{ collection.uuid }}",
                        "name": "{{ collection.name }}",
                        "url": "{% url 'collection:detail' collection.uuid %}"
                    },
                    {% endfor %}
                ]
            },
            getters: {},
            mutations: {},
        });

        {% if blob.is_note %}
        window.MathJax = {
            tex: {
                inlineMath: [ ["\\(","\\)"], ["$$", "$$"] ],
                displayMath: [ ["\\[","\\]"] ],
                processEscapes: true,
                processEnvironments: true
            },
        };
        {% endif %}

        new Vue({
            el: "#vue-left-panel",
            name: "Left Panel",
            store,
            data() {
                return {
                    relatedBlobList: [],
                    getBlobInfoAttemptIntervals: [1000, 3000, 6000],
                    getBlobInfoAttempts: 0,
                    tree: {{ tree|safe }},
                    metadata_misc: {{ metadata_misc|safe|default:"{}" }},
                    related_questions: [
                        {% for question in related_questions %}
                        {
                            question: markdown.render("{{ question.question|escapejs }}"),
                            url: "{% url 'drill:detail' question.uuid %}",
                            tags: [
                                {% for tag in question.tags.all %}
                                {
                                    tag: "{{ tag }}",
                                },
                                {% endfor %}
                            ]
                        },
                        {% endfor %}
                    ],
                }
            },
            methods: {
                getNote() {
                    return markdown.render("{{ blob.note|escapejs }}");
                },
                onClick(url) {
                    window.location = url;
                },
                getBlobInfo() {
                    this.getBlobInfoAttempts++;
                    console.log(`Retrieving blob info, attempt #${this.getBlobInfoAttempts}`);
                    doGet(
                        this,
                        "{% url 'blob:get_elasticsearch_info' blob.uuid %}",
                        (response) => {
                            if (Object.keys(response.data.info).length !== 0) {
                                this.$store.state.elasticsearchInfo = response.data.info;
                            } else {
                                // Keep trying to retrieve the blob's info until we run out of attempts
                                if (this.getBlobInfoAttempts <= this.getBlobInfoAttemptIntervals.length) {
                                    setTimeout( () => {
                                        this.getBlobInfo();
                                    }, this.getBlobInfoAttemptIntervals[this.getBlobInfoAttempts-1]);
                                }
                            }
                        },
                        "Error getting blob info",
                        "{{ csrf_token }}",
                    );
                },
                getRelatedBlobList() {
                    doGet(
                        this,
                        "{% url "blob:related_blobs" object.uuid %}",
                        (response) => {
                            this.relatedBlobList = response.data.blob_list;
                        },
                        "Error getting related blob list"
                    );
                },
                unlinkBlob(uuid) {
                    doPost(
                        this,
                        "{% url "blob:unlink" %}",
                        {
                            "blob_1_uuid": "{{ object.uuid }}",
                            "blob_2_uuid": uuid,
                        },
                        (response) => {
                            this.getRelatedBlobList();
                        },
                        "Blob unlinked",
                        ""
                    );
                }
            },
            mounted() {
                {% if not elasticsearch_info %}
                setTimeout( () => {
                    this.getBlobInfo();
                }, this.getBlobInfoAttemptIntervals[this.getBlobAttempts]);
                {% endif %}
                this.getRelatedBlobList();

                EventBus.$on("get-related-blob-list", () => {
                    this.getRelatedBlobList();
                });

                EventBus.$on("open-bookmarks-modal", () => {
                    this.$refs.relatedBookmarksList.openModal();
                });

            }
        });

        new Vue({
            el: "#vue-right-panel",
            name: "Right Content Panel",
            store,
            components: {
                AddToCollection,
                BlobDetailCover,
                BlobSelect,
            },
            data() {
                return {
                    right: false,
                    show: false,
                    isPinnedNote: {{ is_pinned_note|yesno:"true,false" }},
                }
            },
            methods: {
                handleCopySha1sum(sha1sum) {
                    navigator.clipboard.writeText(sha1sum)
                    EventBus.$emit(
                        "toast",
                        {
                            "body": "Sha1sum copied to clipboard",
                        },
                    );
                },
                handleAddToCollection() {
                    const modal = new Modal("#modalAddToCollection");
                    modal.show();
                    setTimeout( () => { this.$refs.addToCollection.$refs.suggestComponent.input.focus(); }, 500);
                },
                handleLinkToExistingBlob() {
                    this.$refs.blobSelect.openModal();
                },
                handleLinkToBookmark() {
                    EventBus.$emit("open-bookmarks-modal");
                },
                selectBlob(blob) {
                    doPost(
                        this,
                        "{% url "blob:link" %}",
                        {
                            "blob_1_uuid": "{{ object.uuid }}",
                            "blob_2_uuid": blob.uuid,
                        },
                        (response) => {
                            EventBus.$emit("get-related-blob-list");
                        },
                        "The two blobs are now linked",
                        ""
                    );
                },
                getCollectionList() {
                    doGet(
                        this,
                        "{% url "collection:search" %}?blob_uuid={{ blob.uuid }}",
                        (response) => {
                            this.$store.state.collectionList = response.data;
                        },
                        "Error getting collection list"
                    );
                },
                onClick(evt) {
                    payload = {
                        "uuid": "{{ blob.uuid }}"
                    };
                    if (this.isPinnedNote) {
                        payload.remove = true;
                    }
                    doPost(
                        this,
                        url = "{% url "accounts:pin_note" %}",
                        payload,
                        (response) => {
                            this.isPinnedNote = ! this.isPinnedNote;
                        },
                        "",
                        ""
                    );

                },
                getContent() {
                    content = markdown.render("{{ blob.content|escapejs }}");
                    return content.replace(/(%#@!(\d+)!@#%)/g, "<a name='section_$2'></a>");
                },
            },
            computed: {
                pinnedButtonValue: function() {
                    return this.isPinnedNote ? "Unpin note" : "Pin Note"
                }
            },
            mounted() {

                let self = this;

                hotkeys("alt+c", function (event, handler) {
                    switch (handler.key) {
                        case "alt+c":
                            self.handleAddToCollection();
                            break;
                    }
                });

            }
        });

    </script>

{% endblock %}

{% block help %}

    <div class="d-none" id="help-text">
# Keyboard Shortcuts
- **Alt-C** *-* Add to collection
    </div>

{% endblock %}
