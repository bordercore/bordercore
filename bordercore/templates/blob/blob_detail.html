{% extends "base.html" %}

{% load is_in_group %}
{% load dict_get %}

{% block title %} Blob :: Detail {% endblock %}

{% block content %}

    <div class="scrollable-panel-container row no-gutters">

        <div class="col-lg-3 h-100">
            <div id="vue-app" class="scrollable-panel-left card-body d-flex flex-column h-100 mb-0">
                <div class="position-relative">

                    <h5>{{ blob.get_edition_string }}</h5>

                    {% if metadata|dict_get:"Subtitle" %}
                        <div id="blob_subtitle">
                            {{ metadata|dict_get:"Subtitle" }}
                        </div>
                    {% endif %}

                    {% if metadata|dict_get:"Author" %}
                        <div class="mt-2">
                            by <span id="author">{{ metadata|dict_get:"Author" }}</span>
                        </div>
                    {% endif %}

                    {% if date %}
                        <div class="mb-2">
                            {{ date }}
                        </div>
                    {% endif  %}

                    {% for tag in blob.tags.all %}
                        {% if forloop.first %}
                            <div class="mt-3 mb-3">
                                Tags:
                        {% endif %}
                        <a class="badge badge-info" href="{% url 'search:kb_search_tag_detail' tag.name %}">{{ tag.name }}</a>
                        {% if forloop.last %}
                            </div>
                        {% endif %}
                    {% endfor %}

                    {% if urls %}
                        <div class="mb-3">
                            {% for url in urls %}
                                <strong><a href="{{ url.url }}">{{ url.domain }}</a></strong>
                            {% endfor %}
                        </div>
                    {% endif %}

                    {% if show_metadata %}

                        <div class="highlight-box mb-3">

                            {% for key, values in metadata_misc.items %}
                                {% if key != "Subtitle" %}
                                    <div>
                                        <strong class="metadata_name">{{ key }}</strong>
                                        <span class="metadata_value">{{ values }}</span>
                                    </div>
                                {% endif %}
                            {% endfor %}

                            {% if elasticsearch_info.content_type %}
                                <div>
                                    <strong>Object Type</strong>
                                    {{ elasticsearch_info.content_type }}
                                </div>
                            {% endif %}

                            {% if blob.sha1sum %}
                                <div>
                                    <strong>Size</strong>
                                    <small>{{ elasticsearch_info.size }}</small>
                                </div>
                                {% if elasticsearch_info.num_pages %}
                                    <div>
                                        <strong>Pages</strong>
                                        <small>{{ elasticsearch_info.num_pages }}</small>
                                    </div>
                                {% endif %}
                                {% if elasticsearch_info.duration %}
                                    <div>
                                        <strong>Duration</strong>
                                        <small>{{ elasticsearch_info.duration }}</small>
                                    </div>
                                {% endif %}
                            {% endif %}

                        </div>

                    {% endif %}

                    {% if blob.note %}
                        <div class="highlight-box mt-3 text-break" id="blob_note" v-html="getNote()">
                        </div>
                    {% endif %}

                    {% if blob.is_note and blob.has_been_modified %}
                        <div class="mt-3">
                            <strong>Last edited</strong>
                            <small>{{ blob.modified|date:"F j, Y" }}</small>
                        </div>
                    {% endif %}

                    {% if linked_blobs %}
                        <h4 class="mt-3">Collections</h4>
                            {% for collection in linked_blobs %}
                                {{ collection.name }}
                                <ul class="list-group">
                                {% for blob in collection.blob_list %}
                                    <li class="list-group-item list-group-item-secondary text-info">
                                    {% if blob.has_thumbnail_url %}
                                        <img src="{{ blob.get_cover_url_small }}" />
                                    {% endif %}
                                    <a href="{% url 'blob:detail' blob.uuid %}">{{ blob.name|default:"No Name" }}</a>
                                    </li>
                                {% endfor %}
                                <li class="list-group-item list-group-item-secondary text-info">
                                    <a class="btn btn-primary" href="{% url 'blob:create' %}?linked_collection={{ collection.uuid }}">Add to Collection</a>
                                </li>
                                </ul>
                            {% endfor %}
                    {% endif %}

                    {% if collection_list %}
                        <div class="row mt-3">
                            <div class="col-lg-12">
                                    In collection{% if collection_list|length > 1 %}s{% else %}{% endif %}:
                                    {% for collection in collection_list %}
                                        <a href="{% url 'collection:detail' collection.uuid %}">{{ collection.name }}{% if not forloop.last %}, {% endif %}</a>
                                    {% endfor %}
                            </div>
                        </div>
                    {% endif %}

                    <form action="{% url 'blob:update' blob.uuid %}" class="mt-3">
                        {% if blob.sha1sum %}
                            <a href="{{ MEDIA_URL }}blobs/{{ blob.get_url|safe }}" class="btn btn-primary" role="button">Download</a>
                        {% endif %}
                    </form>

                    {% for blob in blob.get_related_blobs %}
                        {% if forloop.first %}
                            Related blobs:
                            <ul>
                        {% endif %}
                            {% if forloop.last %}
                            </ul>
                            {% endif %}
                            <li> <a href="{% url 'blob:detail' blob.uuid %}">{{ blob.name|default:"No Name" }}</a> </li>
                    {% endfor %}

                </div>


                <div v-if="tree['nodes'].length > 0" class="p-2" id="tree-menu">
                    <ul class="mb-0">
                        <tree-menu
                            class="item"
                            :item="tree"
                            :depth="0"
                        ></tree-menu>
                    </ul>
                </div>
            </div>

        </div> <!-- End first column -->

        <div class="col-lg-9 h-100 overflow-auto" id="vue-app-content" v-b-hover="handleHover">

            <div class="col-lg-12">

                <div id="blob-detail-menu" class="dropdownmenu hidden">

                        <dropdown-menu v-model="show" transition="translate-fade-down" class="text-center" :right="right">
                            <font-awesome-icon icon="ellipsis-v"></font-awesome-icon>
                            <div slot="dropdown" class="mt-0">
                                <a class="dropdown-item" href="{% url 'blob:update' blob.uuid %}">Update</a>
                                    {% if blob.sha1sum and request.user|is_in_group:"Admin" %}
                                        <a class="dropdown-item" href="#" @click="handleCopySha1sum('{{ blob.sha1sum }}')">Copy Sha1sum</a>
                                        <a class="dropdown-item" href="{{ aws_url }}">S3 Link</a>
                                    {% endif %}
                                    <a class="dropdown-item" href="{% url 'blob:create' %}?linked_blob_uuid={{ blob.uuid }}">Link to New Blob</a>
                                    <a class="dropdown-item" href="{% url 'blob:clone' blob.uuid %}">Clone Blob</a>
                                    {% if blob.is_note %}
                                        <a class="dropdown-item" href="#" @click="onClick">[[pinnedButtonValue ]]</a>
                                    {% endif %}
                            </div>
                        </dropdown-menu>

                    </div>

                <h2 id="name" class="pl-0 text-break">
                    {{ caption }}
                </h2>

                {% if elasticsearch_info.content_type == "Video" %}

                    <video class="slide_show w-100" controls muted>
                        <source src="{{ MEDIA_URL }}blobs/{{ blob.get_url|safe }}" type="video/mp4">
                    </video>

                {% elif elasticsearch_info.content_type == "Audio" %}

                    <audio controls controlsList="nodownload">
                        <source src="{{ MEDIA_URL }}blobs/{{ blob.get_url|safe }}" type="audio/mpeg">
                                Your browser does not support the audio tag.
                    </audio>

                {% endif %}

                {% if blob.content %}
                    <div class="blob-content table-borders" id="blob-detail-content" v-html="getContent()">
                    </div>
                {% endif %}

                {% if blob.sha1sum and elasticsearch_info.content_type != "Video" %}
                    <blob-detail-cover :initial-cover-info="{{ cover_info }}"
                                       cover-url="{% url "blob:cover_info" object.uuid %}"
                    />
                {% endif %}

            </div>

        </div>

    </div>

{% endblock %}

{% block javascript %}

    {{ block.super }}

    <script type="text/javascript">

        new Vue({
            el: "#vue-app",
            data() {
                return {
                    tree: {{ tree|safe }},
                }
            },
            methods: {
                handleCopySha1sum(sha1sum) {
                    navigator.clipboard.writeText(sha1sum)
                    this.$bvToast.toast("Sha1sum copied to clipboard", {
                        title: "Info",
                        variant: "primary"
                    })
                },
                getNote() {
                    return markdown.render("{{ blob.note|escapejs }}");
                }
            },
        });

        new Vue({
            el: "#vue-app-content",
            components: {
                BlobDetailCover,
            },
            data() {
                return {
                    right: true,
                    show: false,
                    isPinnedNote: {{ is_pinned_note|yesno:"true,false" }},
                }
            },
            methods: {
                onClick(evt) {
                    payload = {
                        "uuid": "{{ blob.uuid }}"
                    };
                    if (this.isPinnedNote) {
                        payload.remove = true;
                    }
                    doPost(
                        this,
                        url = "{% url "accounts:pin_note" %}",
                        payload,
                        (response) => {
                            this.isPinnedNote = ! this.isPinnedNote;
                        },
                        "",
                        ""
                    );

                },
                handleHover(hovered, evt) {
                    evt.currentTarget.querySelector(".dropdownmenu").classList.remove("hidden");
                    if (hovered == true) {
                        evt.currentTarget.querySelector(".dropdownmenu").classList.remove("hidden");
                    } else {
                        evt.currentTarget.querySelector(".dropdownmenu").classList.add("hidden");
                    };
                },
                getContent() {
                    content = markdown.render("{{ blob.content|escapejs }}");
                    return content.replace(/(%#@!(\d+)!@#%)/g, "<a name='section_$2'></a>");
                },
            },
            computed: {
                pinnedButtonValue: function() {
                    return this.isPinnedNote ? "Unpin note" : "Pin Note"
                }
            }
        });

    </script>

{% endblock %}
