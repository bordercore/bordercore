{% extends "base.html" %}

{% load is_in_group %}
{% load dict_get %}

{% block title %} Blob :: Detail {% endblock %}

{% block extra_head %}
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/code_style.css" />
{% endblock %}

{% block left-block %}

        <div class="col-lg-12 card-grid" id="vue-app">

            <card title="">

                <template v-slot:content>

                    <h2 id="title" class="pl-0">
                        {{ caption }}
                    </h2>

                    <h5>{{ object.get_edition_string }}</h5>

                    {% if author %}
                        <div class="mb-2">
                            by <span id="author">{{ author }}</span>
                        </div>
                    {% endif %}

                    {% if date %}
                        <div class="mb-2">
                            {{ date }}
                        </div>
                    {% endif  %}

                    {% if object.tags.all %}
                        <div class="mb-2">
                            Tags:
                            {% for tag in object.tags.all %}
                                <a class="badge badge-primary" href="{% url 'search:kb_search_tag_detail' tag.name %}">{{ tag.name }}</a>
                            {% endfor %}
                        </div>
                    {% endif %}

                    {% if urls %}
                        <div class="mb-2">
                           {% for url in urls %}
                               <strong><a href="{{ url.url }}">{{ url.domain }}</a></strong>
                           {% endfor %}
                        </div>
                    {% endif %}

                    {% if show_metabox %}
                        <div class="highlight-box">

                            {% for key, values in metadata.items %}
                                <div>
                                    <strong class="metadata_name">{{ key }}</strong>
                                    <span class="metadata_value">{{ values }}</span>
                                </div>
                            {% endfor %}

                           {% if content_type %}
                               <div>
                                   <strong>Object Type</strong>
                                       {{ content_type }}
                               </div>
                           {% endif %}

                           {% if object.sha1sum %}
                               <div>
                                   <strong>Sha1sum</strong><br />
                                   <small id="sha1sum">
                                       {% if request.user|is_in_group:"Admin" %}
                                           <a href="{{ aws_url }}">{{ object.sha1sum }}</a>
                                       {% else %}
                                           {{ object.sha1sum }}
                                       {% endif %}
                                   </small>
                               </div>
                               <div>
                                   <strong>Size</strong>
                                   <small>{{ size }}</small>
                               </div>
                               {% if elasticsearch_info.num_pages %}
                                   <div>
                                       <strong>Pages</strong>
                                       <small>{{ elasticsearch_info.num_pages }}</small>
                                   </div>
                               {% endif %}
                           {% endif %}

                        </div>

                    {% endif %}

                    {% if object.note %}
                        <div class="mt-3" id="blob_note">{{ object.get_note|safe }}</div>
                    {% endif %}

                    {% if object.is_note and object.has_been_modified %}
                        <div class="mt-3">
                            <strong>Last edited</strong>
                            <small>{{ object.modified|date:"F j, Y" }}</small>
                        </div>
                    {% endif %}

                    {% if linked_blobs %}
                        <div class="row top-buffer">
                            <div class="col-lg-12">
                                {% for collection in linked_blobs %}
                                    <div id="blob_collection_list">
                                        Linked with: <a href="{% url 'blob:create' %}?linked_collection={{ collection.id }}"></a>
                                    </div>
                                    <ul class="list-group">
                                    {% for blob in collection.blob_list %}
                                        <li class="list-group-item">
                                            {% if blob.has_thumbnail_url %}
                                                <img src="{{ blob.get_cover_url_small }}" />
                                            {% endif %}
                                            <a href="{% url 'blob:detail' blob.uuid %}">{{ blob.title|default:"No Title" }}</a>
                                        </li>
                                    {% endfor %}
                                    <li class="list-group-item">
                                        <a class="btn btn-secondary" href="{% url 'blob:create' %}?linked_collection={{ collection.id }}">Create Blob</a>
                                    </li>
                                    </ul>
                                    <br />
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}

                    {% if collection_info %}
                        <div class="row top-buffer">
                            <div class="col-lg-12">
                                In collection{% if collection_info|length > 1 %}s{% else %}{% endif %}:
                                {% for collection in collection_info %}
                                    <a href="{% url 'collection:detail' collection.uuid %}">{{ collection.name }}{% if not forloop.last %}, {% endif %}</a>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}

                    <form action="{% url 'blob:update' object.uuid %}" class="mt-3">

                        {% if object.sha1sum %}
                            <a href="{{ MEDIA_URL }}blobs/{{ object.get_url|safe }}" class="btn btn-primary" role="button">Download</a>
                        {% endif %}

                        <input type="submit" class="btn btn-primary" value="Update">

                    </form>

                    {% if object.is_note %}
                        <div class="mt-3">
                        {% if is_favorite_note %}
                            <form action="{% url 'accounts:favorites_remove' object.uuid %}">
                                <input type="submit" class="btn btn-primary" value="Remove from Favorites">
                            </form>
                        {% else %}
                            <form action="{% url 'accounts:favorites_add' object.uuid %}">
                                <input type="submit" class="btn btn-primary" value="Add to Favorites">
                            </form>
                        {% endif %}
                        </div>
                    {% endif %}

                    <br /><br />

                    <a href="{% url 'blob:create' %}?linked_blob={{ object.id }}">Link to New Blob</a> <strong>|</strong>
                    <a href="{% url 'blob:thumbnail' object.uuid %}">Update Thumbnail</a>
                    <br /><br />

                    {% for blob in object.get_related_blobs %}
                        {% if forloop.first %}
                            Related blobs:
                            <ul>
                        {% endif %}
                        {% if forloop.last %}
                            </ul>
                        {% endif %}
                        <li> <a href="{% url 'blob:detail' blob.uuid %}">{{ blob.title|default:"No Title" }}</a> </li>
                    {% endfor %}

                </template>

            </card>

        </div>

{% endblock %}

{% block content %}

    {% if cover_info %}
    <div class="modal fade" id="myModal3" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog modal-dialog-centered w-75 mw-100" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <div>
                        <img src="{{ cover_info.url }}" style="width: 100%"/>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div id="vue-messages">
        {% include "common/show_messages.html" %}
    </div>

    <div class="row">

      <div class="col-lg-12">

          {% if content_type == "Video" %}

              <video class="slide_show" controls autoplay loop muted>
                  <source src="{{ MEDIA_URL }}blobs/{{ object.get_url|safe }}" type="video/mp4">
              </video>

          {% elif content_type == "Audio" %}

                <audio controls controlsList="nodownload">
                    <source src="{{ MEDIA_URL }}blobs/{{ object.get_url|safe }}" type="audio/mpeg">
                        Your browser does not support the audio tag.
                </audio>

          {% endif %}

          {% if object.content %}
              <div id="blob_detail_content" class="table-borders">
                        {{ object.get_content|safe }}
              </div>
          {% endif %}

          {% if cover_info %}
              <img src="{{ cover_info.url }}" height="{{ cover_info.height_cropped }}" width="{{ cover_info.width_cropped }}" data-toggle="modal" data-target="#myModal3" />
          {% endif %}

          <br /><br />

      </div>

    </div>

{% endblock %}

{% block javascript %}

    {{ block.super }}

    <script type="text/javascript">

        new Vue({
            el: "#vue-app",
        });

        new Vue({
            el: "#vue-messages",
        });

    </script>

{% endblock %}
