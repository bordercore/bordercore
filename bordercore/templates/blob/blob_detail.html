{% extends "base.html" %}

{% load is_in_group %}
{% load dict_get %}

{% block title %} Blob :: Detail {% endblock %}

{% block content %}

    <div class="scrollable-panel-container row no-gutters">

        <div class="col-lg-3 h-100 d-flex flex-column">
            <div id="vue-left-panel" class="scrollable-panel card-body d-flex flex-column h-100">
                <div>

                    <h5>
                        {{ blob.get_edition_string }}
                    </h5>

                    {% if metadata|dict_get:"Subtitle" %}
                        <div id="blob_subtitle">
                            {{ metadata|dict_get:"Subtitle" }}
                        </div>
                    {% endif %}

                    {% if metadata|dict_get:"Author" %}
                        <div class="mt-2">
                            by <span class="text-info">{{ metadata|dict_get:"Author" }}</span>
                        </div>
                    {% endif %}

                    {% if date %}
                        <div class="mb-2">
                            {{ date }}
                        </div>
                    {% endif  %}

                    {% for tag in blob.tags.all %}
                        {% if forloop.first %}
                            <div class="my-3">
                                <font-awesome-icon icon="tags" class="text-primary"></font-awesome-icon>
                                Tags:
                        {% endif %}
                        <a class="tag" href="{% url 'search:kb_search_tag_detail' tag.name %}">{{ tag.name }}</a>
                        {% if forloop.last %}
                            </div>
                        {% endif %}
                    {% endfor %}

                    {% if urls %}
                        <div class="mb-3">
                            {% for url in urls %}
                                <strong><a href="{{ url.url }}">{{ url.domain }}</a></strong>
                            {% endfor %}
                        </div>
                    {% endif %}

                    {% if show_metadata %}

                    <transition name="fade">
                        <div v-if="Object.keys($store.state.elasticsearchInfo).length !== 0 || Object.keys(metadata_misc).length !== 0" class="highlight-box mb-3">

                            <div v-for="(value, name) in metadata_misc" class="d-flex">
                                <div class="text-info mr-2">
                                    [[ name ]]
                                </div>
                                <div>
                                    [[ value ]]
                                </div>
                            </div>

                            <div v-if="$store.state.elasticsearchInfo.content_type" class="d-flex">
                                <div class="text-info mr-2">
                                    Object Type
                                </div>
                                <div>
                                    [[ $store.state.elasticsearchInfo.content_type ]]
                                </div>
                            </div>

                            <div v-if="$store.state.elasticsearchInfo.size" class="d-flex">
                                <div class="text-info mr-2">
                                    Size
                                </div>
                                <div>
                                    [[ $store.state.elasticsearchInfo.size ]]
                                </div>
                            </div>

                            <div v-if="$store.state.elasticsearchInfo.num_pages" class="d-flex">
                                <div class="text-info mr-2">
                                    Pages
                                </div>
                                <div>
                                    [[ $store.state.elasticsearchInfo.num_pages ]]
                                </div>
                            </div>

                            <div v-if="$store.state.elasticsearchInfo.duration" class="d-flex">
                                <div class="text-info mr-2">
                                    Duration
                                </div>
                                <div>
                                    [[ $store.state.elasticsearchInfo.duration ]]
                                </div>
                            </div>

                        </div>
                    </transition>

                    {% endif %}

                    {% if blob.note %}
                        <div class="highlight-box mt-3 text-break" id="blob-note" v-html="getNote()">
                        </div>
                    {% endif %}

                    {% if blob.is_note and blob.has_been_modified %}
                        <div class="mt-3">
                            <strong>Last edited</strong>
                            <small>{{ blob.modified|date:"F j, Y" }}</small>
                        </div>
                    {% endif %}

                    {% if linked_blobs %}
                        <h4 class="mt-3">
                            Collections
                        </h4>
                        {% for collection in linked_blobs %}
                            {{ collection.name }}
                            <ul class="list-group">
                            {% for blob in collection.blob_list %}
                                <li class="list-group-item list-group-item-secondary text-info">
                                {% if blob.has_thumbnail_url %}
                                    <img src="{{ blob.get_cover_url_small }}" />
                                {% endif %}
                                <a href="{% url 'blob:detail' blob.uuid %}">{{ blob.name|default:"No Name" }}</a>
                                </li>
                            {% endfor %}
                            <li class="list-group-item list-group-item-secondary text-info">
                                <a class="btn btn-primary" href="{% url 'blob:create' %}?linked_collection={{ collection.uuid }}">Add to Collection</a>
                            </li>
                            </ul>
                        {% endfor %}
                    {% endif %}

                    <div v-if="$store.state.collectionList.length > 0" class="row mt-3">
                        <div class="col-lg-12">
                                In collections:

                            <a v-for="(collection, index) in $store.state.collectionList" :href="collection.url">
                                    [[ collection.name ]]<span v-if="index !== $store.state.collectionList.length - 1">, </span>
                            </a>
                        </div>
                    </div>

                    {% if blob.sha1sum %}
                        <a class="button-icon mt-3" href="{{ MEDIA_URL }}blobs/{{ blob.get_url|safe }}" role="button">
                            <font-awesome-icon icon="download" class="text-emphasis" />
                        </a>
                    {% endif %}

                    <div>
                    {% for blob in blob.get_related_blobs %}
                        {% if forloop.first %}
                            Related blobs:
                            <ul>
                        {% endif %}
                            {% if forloop.last %}
                            </ul>
                            {% endif %}
                            <li> <a href="{% url 'blob:detail' blob.uuid %}">{{ blob.name|default:"No Name" }}</a> </li>
                    {% endfor %}
                    </div>

                </div>

                <div v-if="tree['nodes'].length > 0" class="mt-3 p-2 tree-menu highlight-box">
                    <tree-menu
                        class="item"
                        :item="tree"
                        :depth="0"
                    ></tree-menu>
                </div>

                <div v-if="related_questions.length > 0">

                    <hr class="filter-divider w-100 mt-0" />

                    <div class="card-title">
                        Related Questions
                    </div>

                    <div class="cursor-pointer">
                        <ul class="list-group interior-borders">
                            <li v-for="question in related_questions" class="hoverable px-0 list-group-item list-group-item-secondary text-primary">
                                <div class="d-flex">
                                    <div class="mt-1 mr-2">
                                        <font-awesome-icon icon="question" class="text-success"></font-awesome-icon>
                                    </div>
                                    <div>
                                        <span v-html="question.question" @click="onClick(question.url)"></span>
                                        <div>
                                            <span v-for="tag in question.tags" class="badge badge-info mr-2">[[ tag.tag ]]</span>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>

                </div>

            </div>

        </div> <!-- End first column -->

        <div class="col-lg-9 h-100 overflow-auto" id="vue-right-panel" v-b-hover="handleHover">

            <div class="col-lg-12">

                <div class="d-flex">
                    <h2 id="name" class="pl-0 text-break">
                    {{ caption }}
                    </h2>
                    <div class="dropdownmenu hidden">

                        <dropdown-menu v-model="show" transition="translate-fade-down" class="text-center" :right="right">
                            <font-awesome-icon icon="ellipsis-v"></font-awesome-icon>
                            <div slot="dropdown" class="mt-0">
                                <a class="dropdown-item" href="{% url 'blob:update' blob.uuid %}">Update</a>
                                    {% if blob.sha1sum and request.user|is_in_group:"Admin" %}
                                        <a class="dropdown-item" href="#" @click.prevent="handleCopySha1sum('{{ blob.sha1sum }}')">Copy Sha1sum</a>
                                        <a class="dropdown-item" href="{{ aws_url }}">S3 Link</a>
                                    {% endif %}
                                    <a class="dropdown-item" href="#" @click.prevent="handleAddToCollection()">Add to Collection</a>
                                    <a class="dropdown-item" href="{% url 'blob:create' %}?linked_blob_uuid={{ blob.uuid }}">Link to New Blob</a>
                                    <a class="dropdown-item" href="{% url 'blob:clone' blob.uuid %}">Clone Blob</a>
                                    {% if blob.is_note %}
                                        <a class="dropdown-item" href="#" @click.prevent="onClick">[[pinnedButtonValue ]]</a>
                                    {% endif %}
                            </div>
                        </dropdown-menu>

                    </div>
                </div>

                <div v-if="$store.state.elasticsearchInfo.content_type === 'Video'" class="blob-detail-cover-image">
                    <video class="h-100 w-100" controls muted>
                        <source src="{{ MEDIA_URL }}blobs/{{ blob.get_url|safe }}" type="video/mp4">
                    </video>
                </div>

                <audio v-if="$store.state.elasticsearchInfo.content_type === 'Audio'" controls controlsList="nodownload">
                    <source src="{{ MEDIA_URL }}blobs/{{ blob.get_url|safe }}" type="audio/mpeg">
                    Your browser does not support the audio tag.
                </audio>

                {% if blob.content %}
                    <div class="blob-content table-borders" id="blob-detail-content" v-html="getContent()">
                    </div>
                {% endif %}

                <blob-detail-cover
                    v-if="$store.state.elasticsearchInfo.sha1sum && $store.state.elasticsearchInfo.content_type !== 'Video'"
                    cover-url="{{ blob.get_cover_url }}?nodefault=1"
                >
                </blob-detail-cover>

                <add-to-collection
                    ref="addToCollection"
                    blob-uuid="{{ blob.uuid }}"
                    search-url="{% url 'collection:search' %}?exclude_blob_uuid={{ blob.uuid }}&query="
                    collection-mutate-url="{% url 'blob:collection_mutate' %}"
                    @add-to-collection="getCollectionList"
                >
                </add-to-collection>

            </div>

        </div>

    </div>

{% endblock %}

{% block javascript %}

    {{ block.super }}

    {% if blob.is_note %}
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
    {% endif %}

    <script type="text/javascript">

        const EventBus = new Vue();

        const store = new Vuex.Store({
            state: {
                elasticsearchInfo: {{ elasticsearch_info|safe|default:"{}" }},
                collectionList: [
                    {% for collection in collection_list %}
                    {
                        "uuid": "{{ collection.uuid }}",
                        "name": "{{ collection.name }}",
                        "url": "{% url 'collection:detail' collection.uuid %}"
                    },
                    {% endfor %}
                ]
            },
            getters: {},
            mutations: {},
        });

        {% if blob.is_note %}
        window.MathJax = {
            tex: {
                inlineMath: [ ["\\(","\\)"], ["$$", "$$"] ],
                displayMath: [ ["\\[","\\]"] ],
                processEscapes: true,
                processEnvironments: true
            },
        };
        {% endif %}

        new Vue({
            el: "#vue-left-panel",
            name: "Left Panel",
            store,
            data() {
                return {
                    getBlobInfoAttemptIntervals: [1000, 3000, 6000],
                    getBlobInfoAttempts: 0,
                    tree: {{ tree|safe }},
                    metadata_misc: {{ metadata_misc|safe|default:"{}" }},
                    related_questions: [
                        {% for question in related_questions %}
                        {
                            question: markdown.render("{{ question.question|escapejs }}"),
                            url: "{% url 'drill:detail' question.uuid %}",
                            tags: [
                                {% for tag in question.tags.all %}
                                {
                                    tag: "{{ tag }}",
                                },
                                {% endfor %}
                            ]
                        },
                        {% endfor %}
                    ]
                }
            },
            methods: {
                getNote() {
                    return markdown.render("{{ blob.note|escapejs }}");
                },
                onClick(url) {
                    window.location = url;
                },
                getBlobInfo() {
                    this.getBlobInfoAttempts++;
                    console.log(`Retrieving blob info, attempt #${this.getBlobInfoAttempts}`);
                    doGet(
                        this,
                        "{% url 'blob:get_elasticsearch_info' blob.uuid %}",
                        (response) => {
                            if (Object.keys(response.data.info).length !== 0) {
                                this.$store.state.elasticsearchInfo = response.data.info;
                            } else {
                                // Keep trying to retrieve the blob's info until we run out of attempts
                                if (this.getBlobInfoAttempts <= this.getBlobInfoAttemptIntervals.length) {
                                    setTimeout( () => {
                                        this.getBlobInfo();
                                    }, this.getBlobInfoAttemptIntervals[this.getBlobInfoAttempts-1]);
                                }
                            }
                        },
                        "Error getting blob info",
                        "{{ csrf_token }}",
                    );
                },
            },
            mounted() {
                {% if not elasticsearch_info %}
                setTimeout( () => {
                    this.getBlobInfo();
                }, this.getBlobInfoAttemptIntervals[this.getBlobAttempts]);
                {% endif %}
            }
        });

        new Vue({
            el: "#vue-right-panel",
            name: "Right Content Panel",
            store,
            components: {
                AddToCollection,
                BlobDetailCover,
            },
            data() {
                return {
                    right: true,
                    show: false,
                    isPinnedNote: {{ is_pinned_note|yesno:"true,false" }},
                }
            },
            methods: {
                handleCopySha1sum(sha1sum) {
                    navigator.clipboard.writeText(sha1sum)
                    this.$bvToast.toast("Sha1sum copied to clipboard", {
                        title: "Info",
                        variant: "primary"
                    })
                },
                handleAddToCollection() {
                    $("#modalAddToCollection").modal("show");
                    setTimeout( () => { this.$refs.addToCollection.$refs.suggestComponent.input.focus(); }, 500);
                },
                getCollectionList() {
                    doGet(
                        this,
                        "{% url "collection:search" %}?blob_uuid={{ blob.uuid }}",
                        (response) => {
                            this.$store.state.collectionList = response.data;
                        },
                        "Error getting collection list"
                    );
                },
                onClick(evt) {
                    payload = {
                        "uuid": "{{ blob.uuid }}"
                    };
                    if (this.isPinnedNote) {
                        payload.remove = true;
                    }
                    doPost(
                        this,
                        url = "{% url "accounts:pin_note" %}",
                        payload,
                        (response) => {
                            this.isPinnedNote = ! this.isPinnedNote;
                        },
                        "",
                        ""
                    );

                },
                handleHover(hovered, evt) {
                    evt.currentTarget.querySelector(".dropdownmenu").classList.remove("hidden");
                    if (hovered == true) {
                        evt.currentTarget.querySelector(".dropdownmenu").classList.remove("hidden");
                    } else {
                        evt.currentTarget.querySelector(".dropdownmenu").classList.add("hidden");
                    };
                },
                getContent() {
                    content = markdown.render("{{ blob.content|escapejs }}");
                    return content.replace(/(%#@!(\d+)!@#%)/g, "<a name='section_$2'></a>");
                },
            },
            computed: {
                pinnedButtonValue: function() {
                    return this.isPinnedNote ? "Unpin note" : "Pin Note"
                }
            },
            mounted() {

                let self = this;

                window.addEventListener("keydown", function(e) {
                    if (e.which === 67 && e.altKey) { /* Alt-C */
                        self.handleAddToCollection();
                    }
                });

            }
        });

    </script>

{% endblock %}

{% block help %}

    <div class="d-none" id="help-text">
# Keyboard Shortcuts
- **Alt-C** *-* Add to collection
    </div>

{% endblock %}
