{% block extra_head %}

    <script type="text/javascript" src="{{ STATIC_URL }}js/handlebars.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/typeahead.bundle.min.js"></script>
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/typeahead-bootstrap3.css" />

{% endblock %}

<script type="text/javascript" charset="utf-8">

   $(document).ready(function() {

		Handlebars.registerHelper("debug", function(optionalValue) {
			console.log("Current Context");
			console.log("====================");
			console.log(this);

			if (optionalValue) {
				console.log("Value");
				console.log("====================");
				console.log(optionalValue);
			}
		});

        var myengine = new Bloodhound({
            datumTokenizer: function(data) {
                return Bloodhound.tokenizers.obj.whitespace(data.value);
            },
            remote: {
                url: '{% url 'kb_search_tags_booktitles' %}?term=%QUERY',
            },
	        queryTokenizer: Bloodhound.tokenizers.whitespace,
			limit: 20
        });

        myengine.initialize();

		var template_source = $("#entry-template-what").html()

        $('#kbsearch').typeahead(
            {
                hint: true,
                highlight: true,
                minLength: 3
            }, {
	            source: myengine.ttAdapter(),
                displayKey: 'value',
				templates: {
					suggestion: Handlebars.compile(template_source)
				}
			});

		$('#kbsearch').on('keyup', function(event, selection) {
			if ((event.which && event.which == 13) || (event.keyCode && event.keyCode == 13)) {
				$('#search').submit();
				return false;
			} else {
				return true;
			}
		});

		$('#kbsearch').bind('typeahead:selected', function(obj, datum, name) {
			var url = null;
			var name = '_self';
			if (datum.type == 'Tag') {
				url = '{% url 'kb_search_tag_detail' 666 %}'.replace(666, datum.value);
			} else {
				name = 'search'
				url = '{{ STATIC_URL }}ebooks/' + datum.filename;
			}
            window.open(url, name)
        });

    });

</script>

{% verbatim %}
	<script id="entry-template-what" type="text/x-handlebars-template">
		<div>{{ debug }}
			<em>{{type}}</em> - {{value}}
		</div>
	</script>
{% endverbatim %}

    <div class="row">

        <div class="dropdown col-md-1">
            <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown">
    Menu
                <span class="caret"></span>
            </button>
            <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">
                <li role="presentation"><a role="menuitem" tabindex="-1" href="{% url 'search' %}">Search</a></li>
                <li role="presentation" class="divider"></li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="{% url 'document_edit' %}">Add document</a></li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="{% url 'search_admin' %}">Admin</a></li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="#">Separated link</a></li>
            </ul>
        </div>

		<div class="col-md-5">

			<form id="search" class="form-inline" action="{% url 'search' %}" method="get" autocomplete="off">
				<input type="hidden" id="facets" name="facets" value="" />

				<div class="form-group">
					<input id="kbsearch" class="form-control" type="text" name="search" value="{{ request.GET.search }}" placeholder="Search" />
				</div>

			</form>

		</div>

	</div>

