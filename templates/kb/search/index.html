{% extends "base.html" %}

{% load dict_get %}

{% block title %} KB :: Search {% endblock %}

{% block content %}

{% include "kb/header.html" %}

<script type="text/javascript" charset="utf-8">

   $(document).ready(function() {

        $('.facet').on('click', function(e) {

            // For all faceting categories checked, all that list to a
            // hidden field in the search form, then submit the form

            facets = [];

            $('.facet').each(function(index) {
                if (this.checked) {
                    facets.push(this.id)
                }
            });

            $('#facets').val(facets);

            $('#search').submit();

        });

    });

</script>

<br />

{% if request.GET %}

{% if not info %}

    <div class="row">
        <br />
        <div class="col-md-10">
            <div class="alert alert-info">Nothing found</div>
        </div>
    </div>

{% else %}

    <div class="row">

        <div class="col-md-2">
            <div class="panel panel-info">

                <div class="panel-heading">Match Categories</div>
                <div class="panel-body">
{% for facet in facet_counts|dictsortreversed:"count" %}

    <label class="checkbox">
        <input type="checkbox" name="filter_query" class="facet" id="{{ facet.doctype }}"
               {% if facet.doctype in filter_query %}checked="checked"{% endif %}
               /> {{ facet.doctype_purty }} ({{ facet.count }})
    </label>
{% endfor %}

                </div>
            </div>
        </div>

        <div class="col-md-10">

{% if request.GET %}

{% for match in info %}

<!-- id: {{ match.id }} -->

{% if match.doctype == 'bordercore_todo' %}

    <h4 class="search_book_title">Todo: <a href="{% url 'todo_edit' match.internal_id %}">{{ match.bordercore_todo_task.0 }}</a>
        <span class="search_todo_date">{{ match.last_modified }}</span>
    </h4>

{% elif match.doctype == 'bordercore_bookmark' %}

    <h4 class="search_book_title">
        <img src="{{ STATIC_URL }}img/kb_link.png" />
        <a href="{{ match.url }}">{{ match.bordercore_bookmark_title.0 }}</a>
        <span class="search_todo_date">{{ match.last_modified }}</span>
        {% for tag in match.tags %}
            {% if tag|slice:":1" == '_' %}
                <span class="label label-info">
                    <a class="tag" href="{% url 'kb_search_tag_detail' tag|slice:"1:" %}">{{ tag|slice:"1:" }}</a>
                </span>
            {% else %}
                <span class="label label-default">
                    <a class="tag" href="{% url 'kb_search_tag_detail' tag %}">{{ tag }}</a>
                </span>
            {% endif %}
                                &nbsp;

        {% endfor %}
    </h4>

{% elif match.doctype == 'bordercore_blog' %}

    <h4 class="search_book_title"><a href="{% url 'blog_list' match.internal_id %}">{{ match.bordercore_blogpost_title.0|default:"Blog Post" }}</a>  <span class="search_todo_date">{{ match.last_modified }}</span></h4>

    <h5>{{ match.blogpost_snippet|safe }}</h5>

{% elif match.doctype == 'document' %}

    <h4 class="search_book_title"><a href="{% url 'document_detail' match.internal_id %}">{{ match.title|default:"Title" }}</a>
        <span class="search_todo_date">{{ match.last_modified }}</span>
    </h4>

    <h5>{{ match.blogpost_snippet|safe }}</h5>

{% else %}

    <h4 class="search_book_title">
        <img src="{{ STATIC_URL }}img/kb_book.png" />
        <a href="{% url 'blob_detail' match.sha1sum %}">{{ match.title.0 }}</a>
        <a href="{% url 'blob_edit' match.sha1sum %}" id="edit_link">Edit</a>
    </h4>
    &nbsp; &nbsp; {{ match.pub_date.0 }} - {{ match.author.0 }}

{% endif %}

{% endfor %}

{% endif %}

{% endif %}

{% endif %}

{% endblock %}
