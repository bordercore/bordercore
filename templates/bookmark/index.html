{% extends "base.html" %}

{% block extra_head %}

{% endblock %}

{% block title %} Bookmarks {% endblock %}

{% block content %}

<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/jquery.dataTables.bootstrap.css" />

<script type="text/javascript" charset="utf-8" language="javascript" src="{{ STATIC_URL }}js/jquery.dataTables.min.js"></script>
<script type="text/javascript" charset="utf-8" language="javascript" src="{{ STATIC_URL }}js/jquery.dataTables.bootstrap.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/dataTableExt.oApi.fnSetFilteringDelay.js"> </script>

<script type="text/javascript" charset="utf-8">

var oTable;

/* Get the bookmark ID which is currently selected */
/* Modified from http://www.datatables.net/examples/api/select_single_row.html */
function fnGetSelected( oTableLocal ) {

	var aTrs = oTableLocal.fnGetNodes();

	for ( var i=0 ; i<aTrs.length ; i++ ) {
		if ( $(aTrs[i]).hasClass('row_selected') ) {
			return oTable.fnGetData( i )[3];
		}
	}

}

var refreshInterval = 60;  // Minutes

function refreshList() {

    oTable.fnDraw();
    setTimeout("refreshList()", refreshInterval*60*1000);

}

// periodically refresh the list
setTimeout("refreshList()", refreshInterval*60*1000);

$(document).ready(function() {

	// http://stackoverflow.com/questions/8498592/extract-root-domain-name-from-string
	function parse_domain(url) {

		var tmp = document.createElement ('a');
		tmp.href = url;

		domain = tmp.hostname

		parts = domain.split('.')

		if ( parts.length == 3 ) {
			domain = parts[1] + '.' + parts[2]
		}

		return domain;

	}

{% if messages %}
{% for message in messages %}
	$('#feedback').fadeIn(1000).html('{{ message }}');
	setTimeout( function() {
		$('#feedback').fadeOut(1000);
	}, 3000);
{% endfor %}
{% endif %}

    $('#btn-delete').on('click', function() {

		var selectedBookmarkID = fnGetSelected( oTable );

		$.ajax( { type: 'DELETE',
				  url: '/api/v1/bookmark/' + selectedBookmarkID + '/',
				  success: function() {
					  $('#feedback').fadeIn(1000).html("Bookmark deleted.");
					  setTimeout( function() {
						  $('#feedback').fadeOut(1000);
					  }, 3000);

					  oTable.fnDraw();

					  $('#btn-edit').attr("disabled", "disabled");
					  $('#btn-delete').attr("disabled", "disabled");

				  }
				});
	});

    $('#btn-edit').on('click', function() {

		var selectedBookmarkID = fnGetSelected( oTable );
		window.location.href = '/bookmarks/edit/' + selectedBookmarkID;

	});

	function formatTitle( oObj ) {
		return '<img src="{{ STATIC_URL }}img/favicons/' + parse_domain( oObj.aData[1] ) + '.ico" width="32" height="32" /> &nbsp; &nbsp; <a href="' + oObj.aData[1] + '" target="_blank">' + oObj.aData[2] + '</a>';
	}

	oTable = $('#bookmark_list').dataTable( {
		"bServerSide": true,
		"sAjaxSource": "{% url 'get_bookmarks_list' %}",
		"bPaginate": true,
		"bInfo": false,
		"iDisplayLength": 20,
		"aaSorting": [[0, 'desc']],
		"bFilter": true,
		"bLengthChange": false,
		"sDom": "<'row'<'span6'<'toolbar'>l><'span6'f>r>t<'row'<'span6'i><'span6'p>>",
		"bSearchable": false,
		"aoColumnDefs": [
			{ "aTargets": [0], "sClass": "span2", "asSorting": [ "desc", "asc" ] },
			{ "aTargets": [1,3], "bVisible": false },
			{ "aTargets": [2], "fnRender": formatTitle, "useRendered": false },
        ],
	} );

	$('#bookmark_list').dataTable().fnSetFilteringDelay(1000);

	$("#bookmark_list tbody").click( function( event ) {

		// Hilight the clicked row
		$(event.target.parentNode).toggleClass("row_selected");

		// Remove hilighting from all other rows
		$(event.target.parentNode).siblings().removeClass("row_selected");

		// Enable or disabled the 'Edit' and 'Delete' buttons based
		//  on whether a row is selected (hilighted)
		if ( $(event.target.parentNode).hasClass("row_selected") ) {
			$('#btn-edit').removeAttr("disabled");
			$('#btn-delete').removeAttr("disabled");
		} else {
			$('#btn-edit').attr("disabled", "disabled");
			$('#btn-delete').attr("disabled", "disabled");
		}

    });

	// $("div.toolbar").html('Custom tool bar! Text/images etc.');
	$(".foobar").appendTo("div.toolbar");

});

</script>

<div class="foobar">
  <div class="btn-group">
	<a class="btn" id="btn-add" href="/bookmarks/edit">Add</a>
	<button class="btn" id="btn-edit" disabled>Edit</button>
	<button class="btn" id="btn-delete" disabled>Delete</button>
  </div>
	<div id="feedback" class="alert alert-success hide" style="width: 150px; height: 20px; float: right; margin-bottom: 0px"></div>
</div>

{% include "bookmark/header.html" %}

{% include "common/datatable.html" with cols=cols id="bookmark_list" %}

{% endblock %}

